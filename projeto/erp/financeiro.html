<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Financeira - ERP ABP</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
    const SUPABASE_URL = 'https://kjhjeaiwjilkgocwvbwi.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_WP3TF2GTMMWCS1tCYzQSjA_syIKLyIX';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function validarAcesso() {
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) {
            window.location.href = 'login.html';
        }
        return session;
    }
    validarAcesso();
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --primary: #3ecf8e; --dark: #0f172a; --bg: #f1f5f9; --danger: #ef4444; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); padding-top: 85px; }
        .container { max-width: 1100px; margin: auto; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .section-title { color: var(--primary); font-size: 14px; text-transform: uppercase; margin: 20px 0 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .btn-add { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; }
        .btn-cancel { background: #64748b; color: white; margin-top: 10px; border: none; padding: 10px; border-radius: 6px; cursor: pointer; display: none; width: 100%; }
        .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; padding: 15px; color: #64748b; font-size: 12px; text-transform: uppercase; text-align: left; }
        td { padding: 15px; border-top: 1px solid #f1f5f9; }
        .navbar { position: fixed; top: 0; left: 0; width: 100%; background: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-buttons { display: flex; gap: 15px; }
        .btn-nav-back { text-decoration: none; color: #64748b; font-weight: bold; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-pago { background: #dcfce7; color: #166534; }
        .status-pendente { background: #fef9c3; color: #854d0e; }
        .tipo-pagar { color: #ef4444; }
        .tipo-receber { color: #3ecf8e; }
        .btn-action { background: none; border: none; cursor: pointer; font-size: 16px; margin-right: 8px; }

        /* Estilos Novos: Saldo e Filtros */
        .resumo-financeiro { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .resumo-card { padding: 15px; border-radius: 10px; color: white; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .resumo-entradas { background: #10b981; }
        .resumo-saidas { background: #ef4444; }
        .resumo-saldo { background: #3b82f6; }
        .resumo-card span { display: block; font-size: 11px; text-transform: uppercase; opacity: 0.9; margin-bottom: 5px; }
        .resumo-card b { font-size: 20px; }
        .filtros-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; align-items: end; }
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold; color: #0f172a;">ERP ABP - FINANCEIRO</div>
    <div class="nav-buttons">
        <a href="index.html" class="btn-nav-back"><i class="fas fa-home"></i> Início</a>
        <button onclick="sairDaConta()" style="background:#ef4444; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">Sair</button>
    </div>
</div>

<div class="container">
    <div class="card">
        <h3 id="form-title">Novo Lançamento Financeiro</h3>
        <input type="hidden" id="edit-id">

        <div class="section-title">Dados da Transação</div>
        <div class="form-grid">
            <div>
                <label>Tipo *</label>
                <select id="tipo">
                    <option value="pagar">Conta a Pagar (Saída)</option>
                    <option value="receber">Conta a Receber (Entrada)</option>
                </select>
            </div>
            <div style="grid-column: span 2;"><label>Descrição *</label><input type="text" id="descricao" placeholder="Ex: Aluguel, Venda de Produto..."></div>
            <div><label>Valor (R$) *</label><input type="number" id="valor" step="0.01"></div>
        </div>

        <div class="section-title">Datas e Status</div>
        <div class="form-grid">
            <div><label>Vencimento</label><input type="date" id="data_vencimento"></div>
            <div><label>Pagamento</label><input type="date" id="data_pagamento"></div>
            <div>
                <label>Status</label>
                <select id="status">
                    <option value="pendente">Pendente</option>
                    <option value="pago">Pago / Recebido</option>
                </select>
            </div>
        </div>

        <div class="section-title">Relacionamentos e Categoria</div>
        <div class="form-grid">
            <div>
                <label>Entidade (Cliente/Fornecedor)</label>
                <select id="entidade_id">
                    <option value="">Selecione uma entidade...</option>
                </select>
            </div>
            <div><label>Categoria</label><input type="text" id="categoria" placeholder="Ex: Operacional, Marketing..."></div>
            <div><label>Forma de Pagamento</label><input type="text" id="forma_pagamento" placeholder="Ex: Pix, Boleto, Cartão..."></div>
        </div>

        <div class="section-title">Observações</div>
        <textarea id="observacoes" rows="2"></textarea>

        <button class="btn-add" id="btn-save" onclick="handleSave()">Salvar Lançamento</button>
        <button class="btn-cancel" id="btn-cancel" onclick="resetForm()">Cancelar Edição</button>
    </div>

    <div class="card">
        <div class="filtros-grid">
            <div>
                <label><i class="fas fa-search"></i> BUSCA GERAL</label>
                <input type="text" id="inputBusca" placeholder="Descrição ou categoria..." onkeyup="filtrarTabela()">
            </div>
            <div>
                <label>DATA INICIAL</label>
                <input type="date" id="dataInicio" onchange="filtrarTabela()">
            </div>
            <div>
                <label>DATA FINAL</label>
                <input type="date" id="dataFim" onchange="filtrarTabela()">
            </div>
        </div>
    </div>

    <div class="resumo-financeiro">
        <div class="resumo-card resumo-entradas">
            <span>Total Entradas (+)</span>
            <b id="total-receber">R$ 0,00</b>
        </div>
        <div class="resumo-card resumo-saidas">
            <span>Total Saídas (-)</span>
            <b id="total-pagar">R$ 0,00</b>
        </div>
        <div class="resumo-card resumo-saldo">
            <span>Saldo Líquido</span>
            <b id="total-saldo">R$ 0,00</b>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Tipo/Descrição</th>
                    <th>Categoria</th>
                    <th>Forma Pagto</th>
                    <th>Vencimento</th>
                    <th>Valor</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="financeiro-list"></tbody>
        </table>
    </div>
</div>

<script>
let currentFinanceData = [];

async function sairDaConta() {
    if(confirm("Deseja sair?")) {
        await _supabase.auth.signOut();
        window.location.href = 'login.html';
    }
}

async function loadEntidadesSelect() {
    const { data } = await _supabase.from('entidades').select('id, nome_completo').order('nome_completo');
    const select = document.getElementById('entidade_id');
    if(data) {
        data.forEach(e => {
            const opt = document.createElement('option');
            opt.value = e.id;
            opt.textContent = e.nome_completo;
            select.appendChild(opt);
        });
    }
}

async function loadFinanceiro() {
    const { data, error } = await _supabase
        .from('financeiro')
        .select('*, entidades(nome_completo)')
        .order('data_vencimento', { ascending: true });
    
    if (error) return console.error(error);
    currentFinanceData = data || [];
    renderTable(currentFinanceData);
}

function renderTable(data) {
    const list = document.getElementById('financeiro-list');
    let somaPagar = 0;
    let somaReceber = 0;

    list.innerHTML = data.map(f => {
        const valorNum = parseFloat(f.valor) || 0;
        if(f.tipo === 'pagar') somaPagar += valorNum;
        else somaReceber += valorNum;

        return `
        <tr>
            <td>
                <b class="tipo-${f.tipo}">${f.tipo === 'pagar' ? '[-] ' : '[+] '} ${f.tipo.toUpperCase()}</b><br>
                <span>${f.descricao}</span>
            </td>
            <td>${f.categoria || '<small>Sem cat.</small>'}</td>
            <td>${f.forma_pagamento || '-'}</td>
            <td>${new Date(f.data_vencimento).toLocaleDateString('pt-BR')}</td>
            <td><b>R$ ${valorNum.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</b></td>
            <td><span class="status-badge status-${f.status}">${f.status}</span></td>
            <td>
                <button class="btn-action" style="color:#3b82f6" onclick="editFinance('${f.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn-action" style="color:#ef4444" onclick="deleteFinance('${f.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>
    `}).join('') || '<tr><td colspan="7" style="text-align:center">Nenhum registro encontrado.</td></tr>';

    // Atualiza o Saldo em cima da listagem
    document.getElementById('total-receber').innerText = `R$ ${somaReceber.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('total-pagar').innerText = `R$ ${somaPagar.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
    document.getElementById('total-saldo').innerText = `R$ ${(somaReceber - somaPagar).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
}

function filtrarTabela() {
    const busca = document.getElementById('inputBusca').value.toLowerCase();
    const dInicio = document.getElementById('dataInicio').value;
    const dFim = document.getElementById('dataFim').value;

    const filtrados = currentFinanceData.filter(f => {
        // Filtro de texto (Descrição ou Categoria)
        const matchTexto = f.descricao.toLowerCase().includes(busca) || 
                           (f.categoria && f.categoria.toLowerCase().includes(busca));
        
        // Filtro de Datas
        let matchData = true;
        if(dInicio) matchData = matchData && (f.data_vencimento >= dInicio);
        if(dFim) matchData = matchData && (f.data_vencimento <= dFim);

        return matchTexto && matchData;
    });

    renderTable(filtrados);
}

async function handleSave() {
    const { data: { user } } = await _supabase.auth.getUser();
    const id = document.getElementById('edit-id').value;
    
    const dados = {
        usuario_id: user.id,
        tipo: document.getElementById('tipo').value,
        descricao: document.getElementById('descricao').value,
        valor: parseFloat(document.getElementById('valor').value) || 0,
        data_vencimento: document.getElementById('data_vencimento').value,
        data_pagamento: document.getElementById('data_pagamento').value || null,
        status: document.getElementById('status').value,
        entidade_id: document.getElementById('entidade_id').value || null,
        categoria: document.getElementById('categoria').value,
        forma_pagamento: document.getElementById('forma_pagamento').value,
        observacoes: document.getElementById('observacoes').value
    };

    if (!dados.descricao || !dados.valor || !dados.data_vencimento) {
        return alert("Campos obrigatórios: Descrição, Valor e Vencimento");
    }

    const { error } = id 
        ? await _supabase.from('financeiro').update(dados).eq('id', id) 
        : await _supabase.from('financeiro').insert([dados]);

    if (error) alert("Erro: " + error.message); 
    else { resetForm(); loadFinanceiro(); }
}

async function editFinance(id) {
    const item = currentFinanceData.find(f => f.id === id);
    if (!item) return;

    document.getElementById('edit-id').value = item.id;
    document.getElementById('tipo').value = item.tipo;
    document.getElementById('descricao').value = item.descricao;
    document.getElementById('valor').value = item.valor;
    document.getElementById('data_vencimento').value = item.data_vencimento;
    document.getElementById('data_pagamento').value = item.data_pagamento || '';
    document.getElementById('status').value = item.status;
    document.getElementById('entidade_id').value = item.entidade_id || '';
    document.getElementById('categoria').value = item.categoria || '';
    document.getElementById('forma_pagamento').value = item.forma_pagamento || '';
    document.getElementById('observacoes').value = item.observacoes || '';

    document.getElementById('form-title').innerText = "Editando Lançamento";
    document.getElementById('btn-save').innerText = "Atualizar Lançamento";
    document.getElementById('btn-cancel').style.display = "block";
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function resetForm() {
    document.querySelectorAll('input, select, textarea').forEach(i => i.value = '');
    document.getElementById('tipo').value = 'pagar';
    document.getElementById('status').value = 'pendente';
    document.getElementById('edit-id').value = '';
    document.getElementById('form-title').innerText = "Novo Lançamento Financeiro";
    document.getElementById('btn-save').innerText = "Salvar Lançamento";
    document.getElementById('btn-cancel').style.display = "none";
}

async function deleteFinance(id) {
    if (confirm("Excluir este lançamento?")) {
        await _supabase.from('financeiro').delete().eq('id', id);
        loadFinanceiro();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadEntidadesSelect();
    loadFinanceiro();
});
</script>
</body>
</html>
