<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Entidades - ERP ABP</title>
    <script src="conexao.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #3ecf8e; --dark: #0f172a; --bg: #f1f5f9; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); }
        .container { max-width: 1100px; margin: auto; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .section-title { color: var(--primary); font-size: 13px; text-transform: uppercase; margin: 20px 0 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .password-wrapper { position: relative; display: flex; align-items: center; }
        .password-wrapper i { position: absolute; right: 10px; cursor: pointer; color: #64748b; }
        
        /* Estilos Novos: Permiss√µes e Upload */
        .permissions-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px dashed #cbd5e1; }
        .perm-item { display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; color: #475569; }
        .perm-item input { width: auto; cursor: pointer; }
        .upload-group { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .btn-upload { background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-upload:hover { background: #2563eb; }

        .btn-add { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; }
        .btn-cancel { background: #64748b; color: white; margin-top: 10px; border: none; padding: 10px; border-radius: 6px; cursor: pointer; display: none; width: 100%; }
        .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; padding: 15px; color: #64748b; font-size: 12px; text-transform: uppercase; }
        td { padding: 15px; border-top: 1px solid #f1f5f9; }
        .btn-edit { color: #3b82f6; cursor: pointer; font-size: 18px; background: none; border: none; margin-right: 10px;}
        .btn-del { color: #ef4444; cursor: pointer; font-size: 18px; background: none; border: none; }

        /* No seu CSS */
#arquivos_url {
    background: #f1f5f9;
    font-size: 11px;
    color: #475569;
    cursor: not-allowed;
}
    
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h3 id="form-title">Novo Cadastro de Entidade</h3>
        <input type="hidden" id="edit-id">

        <div class="section-title">Informa√ß√µes e Acesso</div>
        <div class="form-grid">
            <div><label>Nome Completo / Raz√£o *</label><input type="text" id="nome_completo"></div>
            <div><label>CPF / CNPJ</label><input type="text" id="cpf"></div>
            <div><label>E-mail</label><input type="email" id="email"></div>
            <div><label>Telefone / WhatsApp *</label><input type="text" id="telefone"></div>
            <div>
                <label>Senha Interna</label>
                <div class="password-wrapper">
                    <input type="password" id="senha_acesso">
                    <i class="fas fa-eye" id="togglePassword" onclick="togglePasswordVisibility()"></i>
                </div>
            </div>
            <div>
                <label>N√≠vel de Acesso</label>
                <select id="acesso">
                    <option value="cliente">Cliente</option>
                    <option value="funcionario">Funcion√°rio</option>
                    <option value="master">Master</option>
                </select>
            </div>
            <div>
                <label>Relacionamento</label>
                <select id="relacionamento">
                    <option value="cliente">Cliente</option>
                    <option value="funcionario">Funcion√°rio</option>
                    <option value="fornecedor">Fornecedor</option>
                </select>
            </div>
            <div><label>Avalia√ß√£o (0-10)</label><input type="number" id="avaliacao" min="0" max="10" value="5"></div>
        </div>

        <div class="section-title">Permiss√µes de Acesso (Funcion√°rios)</div>
        <div class="permissions-grid" id="permissoes-container">
            <label class="perm-item"><input type="checkbox" class="perm-check" value="vendas"> Vendas</label>
            <label class="perm-item"><input type="checkbox" class="perm-check" value="estoque"> Estoque</label>
            <label class="perm-item"><input type="checkbox" class="perm-check" value="financeiro"> Financeiro</label>
            <label class="perm-item"><input type="checkbox" class="perm-check" value="entidades"> Entidades</label>
            <label class="perm-item"><input type="checkbox" class="perm-check" value="config"> Configura√ß√µes</label>
        </div>

        <div class="section-title">Endere√ßo</div>
        <div class="form-grid">
            <div><label>CEP</label><input type="text" id="cep" maxlength="8" onblur="buscaCEP()"></div>
            <div style="grid-column: span 2;"><label>Logradouro</label><input type="text" id="logradouro"></div>
            <div><label>Bairro</label><input type="text" id="bairro"></div>
            <div><label>Cidade</label><input type="text" id="cidade"></div>
        </div>

        <div class="section-title">Documentos e Arquivos (PDF, DOC, TXT)</div>
        <div class="form-grid">
            <div style="grid-column: span 2;">
                <label>Upload de Arquivo</label>
                <div class="upload-group">
                    <input type="file" id="arquivo_input">
                    <button type="button" class="btn-upload" onclick="handleUploadDoc()">Upload</button>
                </div>
            </div>
            <div style="grid-column: span 2;"><label>Link do Arquivo</label><input type="text" id="arquivos_url" readonly placeholder="O link aparecer√° aqui..."></div>
            <div style="grid-column: span 4;"><label>Observa√ß√µes</label><textarea id="observacoes" rows="2"></textarea></div>
        </div>

        <button class="btn-add" id="btn-save" onclick="handleSave()">Salvar Entidade</button>
        <button class="btn-cancel" id="btn-cancel" onclick="resetForm()">Cancelar Edi√ß√£o</button>
    </div>

    <div class="card" style="padding: 15px;">
        <input type="text" id="inputBusca" placeholder="üîç Buscar entidade..." onkeyup="filtrarTabela()">
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Entidade</th>
                    <th>Contato</th>
                    <th>Acesso</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="entities-list"></tbody>
        </table>
    </div>
</div>

<script>
(function() {
    "use strict";

    let currentData = [];

    // --- FUN√á√ïES DE INTERFACE ---
    window.togglePasswordVisibility = function() {
        const passwordInput = document.getElementById('senha_acesso');
        const toggleIcon = document.getElementById('togglePassword');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    };

    window.buscaCEP = async function() {
        const cep = document.getElementById('cep').value.replace(/\D/g, '');
        if (cep.length === 8) {
            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await res.json();
                if (!data.erro) {
                    document.getElementById('logradouro').value = data.logradouro;
                    document.getElementById('bairro').value = data.bairro;
                    document.getElementById('cidade').value = data.localidade;
                    document.getElementById('estado').value = data.uf;
                }
            } catch { console.error("Erro CEP"); }
        }
    };

    // --- L√ìGICA DE UPLOAD M√öLTIPLO ---
    window.handleUploadDoc = async function() {
        const fileInput = document.getElementById('arquivo_input');
        const urlTextarea = document.getElementById('arquivos_url');
        
        if (!fileInput.files.length) return alert("Selecione um arquivo!");

        const file = fileInput.files[0];
        const fileName = `${Date.now()}_${file.name.replace(/\s/g, '_')}`;
        const filePath = `docs/${fileName}`;

        try {
            const { error } = await _supabase.storage.from('documentos').upload(filePath, file);
            if (error) throw error;

            const { data } = _supabase.storage.from('documentos').getPublicUrl(filePath);
            
            const listaAtual = urlTextarea.value.trim();
            urlTextarea.value = listaAtual ? listaAtual + "\n" + data.publicUrl : data.publicUrl;
            
            fileInput.value = ""; 
            alert("Documento adicionado!");
        } catch (err) { alert("Erro no upload: " + err.message); }
    };

    window.limparArquivos = function() {
        if(confirm("Deseja remover todos os links de documentos?")) {
            document.getElementById('arquivos_url').value = "";
        }
    };

    // --- CARREGAMENTO E TABELA (COM WHATSAPP E EMAIL DE VOLTA) ---
    async function loadEntities() {
        if (!window._supabase) {
            setTimeout(loadEntities, 500);
            return;
        }

        const { data, error } = await _supabase.from('entidades').select('*').order('nome_completo');
        if (error) {
            console.error("Erro ao carregar:", error);
            return;
        }
        currentData = data || [];
        renderTable(currentData);
    }

    function renderTable(data) {
        const list = document.getElementById('entities-list');
        list.innerHTML = data.map(c => {
            // L√≥gica do WhatsApp e Email que voc√™ solicitou de volta
            const wppLink = c.telefone ? `https://wa.me/${c.telefone.replace(/\D/g, '')}` : '#';
            const mailLink = c.email ? `https://mail.google.com/mail/?view=cm&fs=1&to=${c.email}` : '#';

            return `
            <tr>
                <td><b>${c.nome_completo}</b><br><small>${(c.relacionamento || '').toUpperCase()}</small></td>
                <td>${c.telefone || 'Sem contato'}<br><small>${c.email || ''}</small></td>
                <td>${c.acesso}<br><small style="color:${c.status === 'ativo' ? 'green' : 'red'}">${c.status}</small></td>
                <td>
                    <button class="btn-edit" title="Editar" onclick="editFull('${c.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-del" title="Excluir" onclick="deleteEntity('${c.id}')"><i class="fas fa-trash"></i></button>
                    <a href="${wppLink}" target="_blank" class="btn-wpp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
                    <a href="${mailLink}" target="_blank" class="btn-mail" title="Gmail"><i class="fas fa-envelope"></i></a>
                </td>
            </tr>`;
        }).join('') || '<tr><td colspan="4" style="text-align:center">Nenhuma entidade encontrada.</td></tr>';
    }

    // --- SALVAMENTO E EDI√á√ÉO ---
    window.handleSave = async function() {
        const { data: { user } } = await _supabase.auth.getUser();
        const id = document.getElementById('edit-id').value;
        
        // Converte as linhas do textarea em um Array para o banco de dados
        const linksArray = document.getElementById('arquivos_url').value
            .split('\n')
            .filter(link => link.trim() !== "");

        const dados = {
            usuario_id: user.id,
            nome_completo: document.getElementById('nome_completo').value,
            cpf: document.getElementById('cpf').value,
            data_nascimento: document.getElementById('data_nascimento').value || null,
            email: document.getElementById('email').value,
            telefone: document.getElementById('telefone').value,
            senha_acesso: document.getElementById('senha_acesso').value,
            acesso: document.getElementById('acesso').value,
            relacionamento: document.getElementById('relacionamento').value,
            status: document.getElementById('status').value,
            avaliacao: parseInt(document.getElementById('avaliacao').value),
            observacoes: document.getElementById('observacoes').value,
            cep: document.getElementById('cep').value,
            logradouro: document.getElementById('logradouro').value,
            numero: document.getElementById('numero').value,
            bairro: document.getElementById('bairro').value,
            cidade: document.getElementById('cidade').value,
            estado: document.getElementById('estado').value,
            arquivos_url: linksArray // Salva como lista
        };
        
        if (!dados.nome_completo) return alert("Nome √© obrigat√≥rio");
        
        const { error } = id ? 
            await _supabase.from('entidades').update(dados).eq('id', id) : 
            await _supabase.from('entidades').insert([dados]);
        
        if (error) alert("Erro ao salvar: " + error.message); 
        else { resetForm(); loadEntities(); }
    };

    window.editFull = async function(id) {
        const { data, error } = await _supabase.from('entidades').select('*').eq('id', id).single();
        if (error || !data) return;

        Object.keys(data).forEach(k => {
            const el = document.getElementById(k);
            if (el) {
                if (k === 'arquivos_url' && Array.isArray(data[k])) {
                    el.value = data[k].join('\n'); // Transforma array em linhas no textarea
                } else {
                    el.value = data[k] || '';
                }
            }
        });

        document.getElementById('edit-id').value = data.id;
        document.getElementById('form-title').innerText = "Editando Entidade";
        document.getElementById('btn-save').innerText = "Atualizar Entidade";
        document.getElementById('btn-cancel').style.display = "block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.resetForm = function() {
        document.querySelectorAll('input, select, textarea').forEach(i => {
            if(i.id === 'avaliacao') i.value = '5';
            else if(i.tagName === 'SELECT') i.selectedIndex = 0;
            else i.value = '';
        });
        document.getElementById('edit-id').value = '';
        document.getElementById('form-title').innerText = "Novo Cadastro de Entidade";
        document.getElementById('btn-save').innerText = "Salvar Entidade";
        document.getElementById('btn-cancel').style.display = "none";
    };

    window.deleteEntity = async function(id) {
        if (confirm("Excluir definitivamente?")) {
            await _supabase.from('entidades').delete().eq('id', id);
            loadEntities();
        }
    }

    document.addEventListener('DOMContentLoaded', loadEntities);
})();
</script>
</body>
</html>
