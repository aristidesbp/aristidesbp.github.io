<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produtos - ERP ABP</title>

    <script src="conexao.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 
    <style>
        /* Mantendo seu CSS original para integridade visual */
        :root { --primary: #3ecf8e; --dark: #0f172a; --bg: #f1f5f9; --danger: #ef4444; --warning: #f59e0b; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); padding-top: 85px; color: #1e293b; }
        .container { max-width: 1250px; margin: auto; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .section-title { color: var(--primary); font-size: 13px; text-transform: uppercase; margin: 25px 0 12px; border-bottom: 2px solid #f1f5f9; padding-bottom: 6px; font-weight: 800; letter-spacing: 0.5px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 18px; }
        label { display: block; margin-bottom: 6px; font-size: 13px; color: #64748b; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 11px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .btn-add { background: var(--primary); color: white; padding: 14px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 25px; font-size: 15px; }
        .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8fafc; padding: 16px; color: #475569; font-size: 12px; text-transform: uppercase; text-align: left; border-bottom: 2px solid #f1f5f9; }
        td { padding: 14px 16px; border-top: 1px solid #f1f5f9; font-size: 14px; }
        .btn-action { background: #f1f5f9; border: none; cursor: pointer; font-size: 14px; padding: 8px; border-radius: 6px; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h3 id="form-title">Novo Produto</h3>
        <input type="hidden" id="edit-id">
        
        <div class="section-title">Informações Básicas</div>
        <div class="form-grid">
            <div style="grid-column: span 2;">
                <label>Nome do Produto *</label>
                <input type="text" id="nome" placeholder="Ex: Cimento CP-II">
            </div>
            <div>
                <label>Código de Barras (EAN)</label>
                <input type="text" id="codigo_de_barras">
            </div>
            <div>
                <label>Marca</label>
                <input type="text" id="marca">
            </div>
            <div>
                <label>SKU / Código Interno</label>
                <input type="text" id="sku">
            </div>
            <div>
                <label>Categoria</label>
                <input type="text" id="categoria_prod">
            </div>
            <div>
                <label>Entidade (Fornecedor)</label>
                <select id="entidade_id"><option value="">Carregando...</option></select>
            </div>
            <div>
                <label>Data de Vencimento</label>
                <input type="date" id="data_vencimento">
            </div>
        </div>

        <div class="section-title">Descrição e Detalhes</div>
        <textarea id="descricao" rows="3" placeholder="Informações adicionais..."></textarea>

        <div class="section-title">Preços e Estoque</div>
        <div class="form-grid">
            <div><label>Preço de Custo (R$)</label><input type="number" id="preco_custo" step="0.01" value="0.00"></div>
            <div><label>Preço de Venda (R$) *</label><input type="number" id="preco_venda" step="0.01" value="0.00"></div>
            <div><label>Estoque Atual *</label><input type="number" id="estoque_atual" value="0"></div>
            <div><label>Estoque Mínimo</label><input type="number" id="estoque_minimo" value="5"></div>
        </div>

        <button class="btn-add" id="btn-save" onclick="handleSaveProduto()">Salvar Produto</button>
        <button id="btn-cancel" onclick="resetForm()" style="display:none; background:#94a3b8; color:white; border:none; padding:10px; width:100%; border-radius:8px; margin-top:10px; cursor:pointer;">Cancelar Edição</button>
    </div>

    <div class="card">
        <label>Busca Inteligente</label>
        <input type="text" id="inputBusca" onkeyup="filtrarProdutos()" placeholder="Buscar por Nome, SKU, Código ou Marca...">
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Código/SKU</th>
                    <th>Produto / Marca</th>
                    <th>Categoria</th>
                    <th>Custo</th>
                    <th>Venda</th>
                    <th>Estoque</th>
                    <th>Vencimento</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="produtos-list"></tbody>
        </table>
    </div>
</div>

<script>
/** ERP ABP - Módulo Produtos (Integrado com conexao.js) **/
(function() {
    "use strict";

    let listaProdutos = [];

    async function inicializar() {
        // Aguarda o Supabase carregar do conexao.js
        if (!window._supabase) {
            setTimeout(inicializar, 500);
            return;
        }
        await loadEntidadesProd();
        await loadProdutos();
    }

    async function loadEntidadesProd() {
        const { data, error } = await _supabase.from('entidades').select('id, nome_completo').order('nome_completo');
        if (error) return console.error("Erro entidades:", error);
        
        const select = document.getElementById('entidade_id');
        select.innerHTML = '<option value="">Selecione...</option>' + 
            data.map(e => `<option value="${e.id}">${e.nome_completo}</option>`).join('');
    }

    async function loadProdutos() {
        const { data, error } = await _supabase.from('produtos').select('*, entidades(nome_completo)').order('nome');
        if (error) return console.error("Erro produtos:", error);
        listaProdutos = data || [];
        renderProdutos(listaProdutos);
    }

    function renderProdutos(data) {
        const list = document.getElementById('produtos-list');
        list.innerHTML = data.map(p => {
            const estoque = parseInt(p.estoque_atual) || 0;
            const alerta = estoque <= (p.estoque_minimo || 0) ? 'color: #ef4444; font-weight: bold;' : '';
            return `
            <tr>
                <td><small>${p.codigo_de_barras || p.sku || '-'}</small></td>
                <td><b>${p.nome}</b><br><small style="color:gray">${p.marca || ''}</small></td>
                <td>${p.categoria_prod || '-'}</td>
                <td>R$ ${parseFloat(p.preco_custo).toLocaleString('pt-BR', {minFractionDigits:2})}</td>
                <td>R$ ${parseFloat(p.preco_venda).toLocaleString('pt-BR', {minFractionDigits:2})}</td>
                <td style="${alerta}">${estoque} un</td>
                <td><small>${p.data_vencimento ? new Date(p.data_vencimento).toLocaleDateString('pt-BR') : '-'}</small></td>
                <td>
                    <button class="btn-action" style="color:#3b82f6" onclick="window.editProduto('${p.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-action" style="color:#ef4444" onclick="window.deleteProduto('${p.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('') || '<tr><td colspan="8" style="text-align:center">Nenhum produto cadastrado.</td></tr>';
    }

    window.handleSaveProduto = async function() {
        const { data: { user } } = await _supabase.auth.getUser();
        const id = document.getElementById('edit-id').value;
        const dados = getFormData(user.id);

        if(!dados.nome || !dados.preco_venda) return alert("Preencha os campos obrigatórios.");

        const { error } = id ? 
            await _supabase.from('produtos').update(dados).eq('id', id) : 
            await _supabase.from('produtos').insert([dados]);

        if(error) alert("Erro ao salvar."); else { resetForm(); loadProdutos(); }
    };

    function getFormData(uid) {
        return {
            usuario_id: uid,
            nome: document.getElementById('nome').value,
            sku: document.getElementById('sku').value,
            codigo_de_barras: document.getElementById('codigo_de_barras').value,
            marca: document.getElementById('marca').value,
            categoria_prod: document.getElementById('categoria_prod').value,
            descricao: document.getElementById('descricao').value,
            data_vencimento: document.getElementById('data_vencimento').value || null,
            entidade_id: document.getElementById('entidade_id').value || null,
            preco_custo: parseFloat(document.getElementById('preco_custo').value) || 0,
            preco_venda: parseFloat(document.getElementById('preco_venda').value) || 0,
            estoque_atual: parseInt(document.getElementById('estoque_atual').value) || 0,
            estoque_minimo: parseInt(document.getElementById('estoque_minimo').value) || 0
        };
    }

    window.editProduto = function(id) {
        const p = listaProdutos.find(i => i.id == id);
        if(!p) return;
        document.getElementById('edit-id').value = p.id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('sku').value = p.sku || '';
        document.getElementById('codigo_de_barras').value = p.codigo_de_barras || '';
        document.getElementById('marca').value = p.marca || '';
        document.getElementById('categoria_prod').value = p.categoria_prod || '';
        document.getElementById('descricao').value = p.descricao || '';
        document.getElementById('data_vencimento').value = p.data_vencimento || '';
        document.getElementById('entidade_id').value = p.entidade_id || '';
        document.getElementById('preco_custo').value = p.preco_custo;
        document.getElementById('preco_venda').value = p.preco_venda;
        document.getElementById('estoque_atual').value = p.estoque_atual;
        document.getElementById('estoque_minimo').value = p.estoque_minimo;
        
        document.getElementById('form-title').innerText = "Editando Produto";
        document.getElementById('btn-save').innerText = "Atualizar Produto";
        document.getElementById('btn-cancel').style.display = 'block';
        window.scrollTo({top:0, behavior:'smooth'});
    };

    window.resetForm = function() {
        document.querySelectorAll('input, textarea, select').forEach(i => i.value = '');
        document.getElementById('edit-id').value = '';
        document.getElementById('form-title').innerText = "Novo Produto";
        document.getElementById('btn-save').innerText = "Salvar Produto";
        document.getElementById('btn-cancel').style.display = 'none';
    };

    window.deleteProduto = async function(id) {
        if(confirm("Excluir produto?")) {
            await _supabase.from('produtos').delete().eq('id', id);
            loadProdutos();
        }
    };

    window.filtrarProdutos = function() {
        const busca = document.getElementById('inputBusca').value.toLowerCase();
        renderProdutos(listaProdutos.filter(p => p.nome.toLowerCase().includes(busca) || (p.sku && p.sku.toLowerCase().includes(busca))));
    };

    document.addEventListener('DOMContentLoaded', inicializar);
})();
</script>
</body>
</html>
