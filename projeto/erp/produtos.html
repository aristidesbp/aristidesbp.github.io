<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos - ERP ABP</title>
    <script src="conexao.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root { --primary: #3ecf8e; --dark: #0f172a; --bg: #f1f5f9; --danger: #ef4444; }
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 85px 15px 20px; color: #1e293b; }
.container { max-width: 1250px; margin: auto; }
.card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
.section-title { color: var(--primary); font-size: 13px; text-transform: uppercase; margin: 25px 0 12px; border-bottom: 2px solid #f1f5f9; padding-bottom: 6px; font-weight: 800; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: 600; }
input, select { width: 100%; padding: 11px; border: 1px solid #e2e8f0; border-radius: 8px; }
.btn-add { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; }
.btn-cancel { background: #94a3b8; color: white; padding: 12px; border: none; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; font-weight: bold; }
.btn-scan { background: var(--dark); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
.table-container { background: white; border-radius: 12px; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; min-width: 900px; }
th { background: #f8fafc; padding: 15px; font-size: 12px; text-align: left; color: #475569; }
td { padding: 12px 15px; border-top: 1px solid #f1f5f9; font-size: 14px; }
.img-prod { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; background: #eee; }
#reader { width: 100%; border-radius: 12px; margin-bottom: 10px; }


    .actions-flex {
    display: flex;
    gap: 8px;
    justify-content: flex-start;
}

.btn-action {
    border: none;
    border-radius: 6px;
    padding: 10px 12px;
    cursor: pointer;
    color: white;
    font-size: 14px;
    transition: 0.2s;
}

.btn-edit {
    background-color: var(--dark); /* Cor escura que você já usa */
}

.btn-delete {
    background-color: var(--danger); /* Vermelho para exclusão */
}

.btn-action:hover {
    filter: brightness(1.2);
}
    
    </style>

</head>
<body>

<div class="container">
    <div class="card">
        <h3 id="form-title">Novo Produto</h3>
        <input type="hidden" id="edit-id">
        
        <div class="section-title">Identificação e Foto</div>
        <div class="form-grid">
            <div style="grid-column: span 2;">
                <label>Foto do Produto</label>
                <input type="file" id="foto_produto" accept="image/*" onchange="previewImage(this)">
                <div id="preview-container" style="margin-top:10px; display:none;">
                    <img id="img-preview" src="" style="max-height: 120px; border: 2px solid #3ecf8e; border-radius: 8px;">
                </div>
            </div>
            <div style="grid-column: span 2;">
                <label>Nome do Produto *</label>
                <input type="text" id="nome" placeholder="Ex: Porcelanato 60x60">
            </div>
            <div>
                <label>Código de Barras (EAN)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="codigo_de_barras" placeholder="0000000000000">
                    <button type="button" class="btn-scan" onclick="abrirScanner()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="reader-container" style="display:none;">
            <div id="reader"></div>
            <button class="btn-cancel" onclick="fecharScanner()" style="margin-bottom: 20px;">Fechar Câmera</button>
        </div>

        <div class="section-title">Dados da Compra e Fornecedor</div>
        <div class="form-grid">
            <div><label>Data da Compra</label><input type="date" id="data_compra"></div>
            <div><label>Nº Nota Fiscal</label><input type="text" id="numero_nota"></div>
            <div>
                <label>Fornecedor</label>
                <select id="entidade_id"><option value="">Carregando...</option></select>
            </div>
            <div><label>Categoria</label><input type="text" id="categoria_prod" list="lista-categorias"></div>
            <datalist id="lista-categorias"></datalist>
        </div>

        <div class="section-title">Preços e Estoque</div>
        <div class="form-grid">
            <div><label>Custo (R$)</label><input type="number" id="preco_custo" step="0.01"></div>
            <div><label>Venda (R$) *</label><input type="number" id="preco_venda" step="0.01"></div>
            <div><label>Estoque Atual</label><input type="number" id="estoque_atual"></div>
            <div><label>Mínimo</label><input type="number" id="estoque_minimo"></div>
        </div>

        <button class="btn-add" id="btn-save" onclick="handleSaveProduto()">Salvar Produto</button>
        <button id="btn-cancel" class="btn-cancel" onclick="resetForm()" style="display:none;">Cancelar Edição</button>
    </div>

    <div class="card">
        <div class="form-grid">
            <div style="grid-column: span 2;">
                <label>Busca Inteligente</label>
                <input type="text" id="inputBusca" onkeyup="filtrarProdutos()" placeholder="Nome, SKU ou EAN...">
            </div>
            <div>
                <label>Filtrar Categoria</label>
                <select id="filtro_categoria" onchange="filtrarProdutos()">
                    <option value="">Todas</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Foto</th>
                    <th>Produto / Marca</th>
                    <th>Categoria</th>
                    <th>Estoque</th>
                    <th>Venda</th>
                    <th>Compra / NF</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="produtos-list"></tbody>
        </table>
    </div>
</div>
    <script>

(function() {
    "use strict";

    let listaProdutos = [];
    let html5QrCode;

    /**
     * INICIALIZAÇÃO
     */
    async function inicializar() {
        // Aguarda o Supabase ser injetado pelo conexao.js
        if (!window._supabase) {
            setTimeout(inicializar, 500);
            return;
        }
        await loadEntidadesFornecedores();
        await loadProdutos();
    }

    /**
     * CARREGAMENTO DE DADOS
     */
    
    // Carrega apenas entidades marcadas como 'fornecedor'
    async function loadEntidadesFornecedores() {
        try {
            const { data, error } = await _supabase
                .from('entidades')
                .select('id, nome_completo')
                .eq('relacionamento', 'fornecedor')
                .order('nome_completo');

            if (error) throw error;

            const select = document.getElementById('entidade_id');
            select.innerHTML = '<option value="">Selecione o Fornecedor...</option>' + 
                data.map(e => `<option value="${e.id}">${e.nome_completo}</option>`).join('');
        } catch (err) {
            console.error("Erro ao carregar fornecedores:", err.message);
        }
    }

    async function loadProdutos() {
        try {
            const { data, error } = await _supabase
                .from('produtos')
                .select('*, entidades(nome_completo)')
                .order('nome');

            if (error) throw error;
            
            listaProdutos = data || [];
            renderProdutos(listaProdutos);
            atualizarFiltrosCategorias(listaProdutos);
        } catch (err) {
            console.error("Erro ao carregar produtos:", err.message);
        }
    }

    /**
     * INTERFACE E RENDERIZAÇÃO
     */

    function renderProdutos(dados) {
        const list = document.getElementById('produtos-list');
        list.innerHTML = dados.map(p => {
            const estoqueBaixo = p.estoque_atual <= (p.estoque_minimo || 0);
            return `
            <tr>
                <td><img src="${p.imagem_url || ''}" class="img-prod" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td><b>${p.nome}</b><br><small style="color:gray">${p.marca || ''}</small></td>
                <td><span style="background:#e2e8f0; padding:2px 8px; border-radius:4px; font-size:12px;">${p.categoria_prod || '-'}</span></td>
                <td style="${estoqueBaixo ? 'color:red; font-weight:bold' : ''}">${p.estoque_atual} un</td>
                <td>R$ ${parseFloat(p.preco_venda).toLocaleString('pt-BR', {minFractionDigits:2})}</td>
                <td><small>NF: ${p.numero_nota || '-'}<br>${p.data_compra ? new Date(p.data_compra).toLocaleDateString('pt-BR') : ''}</small></td>
                <td>
                    <div class="actions-flex" style="display:flex; gap:8px;">
                        <button class="btn-action btn-edit" style="background:#0f172a; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;" onclick="window.editProduto('${p.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" style="background:#ef4444; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;" onclick="window.deleteProduto('${p.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        }).join('') || '<tr><td colspan="7" style="text-align:center">Nenhum produto encontrado.</td></tr>';
    }

    function atualizarFiltrosCategorias(produtos) {
        const categorias = [...new Set(produtos.map(p => p.categoria_prod).filter(Boolean))];
        
        // Atualiza o datalist do formulário
        const dataList = document.getElementById('lista-categorias');
        dataList.innerHTML = categorias.map(c => `<option value="${c}">`).join('');
        
        // Atualiza o select de filtro da busca
        const selectFiltro = document.getElementById('filtro_categoria');
        selectFiltro.innerHTML = '<option value="">Todas as Categorias</option>' + 
            categorias.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    /**
     * FUNCIONALIDADES (CÂMERA E IMAGEM)
     */

    window.previewImage = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('preview-container').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.abrirScanner = function() {
        document.getElementById('reader-container').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 150 } },
            (decodedText) => {
                document.getElementById('codigo_de_barras').value = decodedText;
                window.fecharScanner();
            }
        ).catch(err => console.error("Erro na câmera:", err));
    };

    window.fecharScanner = function() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('reader-container').style.display = 'none';
            });
        }
    };

    /**
     * CRUD - SALVAR, EDITAR, EXCLUIR
     */

    window.handleSaveProduto = async function() {
        const { data: { user } } = await _supabase.auth.getUser();
        const id = document.getElementById('edit-id').value;
        const imgPrevia = document.getElementById('img-preview').src;

        const dados = {
            usuario_id: user.id,
            nome: document.getElementById('nome').value,
            codigo_de_barras: document.getElementById('codigo_de_barras').value,
            data_compra: document.getElementById('data_compra').value || null,
            numero_nota: document.getElementById('numero_nota').value,
            categoria_prod: document.getElementById('categoria_prod').value,
            entidade_id: document.getElementById('entidade_id').value || null,
            preco_custo: parseFloat(document.getElementById('preco_custo').value) || 0,
            preco_venda: parseFloat(document.getElementById('preco_venda').value) || 0,
            estoque_atual: parseInt(document.getElementById('estoque_atual').value) || 0,
            estoque_minimo: parseInt(document.getElementById('estoque_minimo').value) || 0,
            imagem_url: imgPrevia.startsWith('data:') ? imgPrevia : (id ? undefined : null)
        };

        if (!dados.nome || !dados.preco_venda) return alert("Nome e Preço de Venda são obrigatórios!");

        const { error } = id ? 
            await _supabase.from('produtos').update(dados).eq('id', id) : 
            await _supabase.from('produtos').insert([dados]);

        if (error) {
            alert("Erro ao salvar: " + error.message);
        } else {
            resetForm();
            loadProdutos();
        }
    };

    window.editProduto = function(id) {
        const p = listaProdutos.find(i => i.id === id);
        if (!p) return;

        document.getElementById('edit-id').value = p.id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('codigo_de_barras').value = p.codigo_de_barras || '';
        document.getElementById('data_compra').value = p.data_compra || '';
        document.getElementById('numero_nota').value = p.numero_nota || '';
        document.getElementById('categoria_prod').value = p.categoria_prod || '';
        document.getElementById('entidade_id').value = p.entidade_id || '';
        document.getElementById('preco_custo').value = p.preco_custo;
        document.getElementById('preco_venda').value = p.preco_venda;
        document.getElementById('estoque_atual').value = p.estoque_atual;
        document.getElementById('estoque_minimo').value = p.estoque_minimo;

        if (p.imagem_url) {
            document.getElementById('img-preview').src = p.imagem_url;
            document.getElementById('preview-container').style.display = 'block';
        }

        document.getElementById('form-title').innerText = "Editando Produto";
        document.getElementById('btn-save').innerText = "Atualizar Produto";
        document.getElementById('btn-cancel').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.deleteProduto = async function(id) {
        if (confirm("Deseja realmente excluir este produto?")) {
            const { error } = await _supabase.from('produtos').delete().eq('id', id);
            if (error) alert("Erro ao excluir!"); else loadProdutos();
        }
    };

    window.resetForm = function() {
        document.getElementById('edit-id').value = '';
        document.querySelectorAll('input, select').forEach(i => i.value = '');
        document.getElementById('img-preview').src = '';
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('form-title').innerText = "Novo Produto";
        document.getElementById('btn-save').innerText = "Salvar Produto";
        document.getElementById('btn-cancel').style.display = 'none';
    };

    window.filtrarProdutos = function() {
        const busca = document.getElementById('inputBusca').value.toLowerCase();
        const categoria = document.getElementById('filtro_categoria').value;

        const filtrados = listaProdutos.filter(p => {
            const matchTexto = p.nome.toLowerCase().includes(busca) || 
                               (p.codigo_de_barras && p.codigo_de_barras.includes(busca));
            const matchCategoria = categoria === "" || p.categoria_prod === categoria;
            return matchTexto && matchCategoria;
        });
        renderProdutos(filtrados);
    };

    document.addEventListener('DOMContentLoaded', inicializar);
})();
            
        
    </script>
</body>
</html>
