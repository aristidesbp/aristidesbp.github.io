<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Entidades - ERP ABP</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --primary: #3ecf8e; --dark: #0f172a; --bg: #f1f5f9; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); }
        .container { max-width: 900px; margin: auto; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Nova Área de Busca */
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .search-box input { flex: 1; }
        .btn-search { background: var(--dark); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        .section-title { color: var(--primary); font-size: 14px; text-transform: uppercase; margin: 20px 0 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        
        .password-wrapper { position: relative; display: flex; align-items: center; }
        .password-wrapper i { position: absolute; right: 10px; cursor: pointer; color: #64748b; }
        
        .btn-add { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; }
        .btn-cancel { background: #64748b; color: white; margin-top: 10px; border: none; padding: 10px; border-radius: 6px; cursor: pointer; display: none; width: 100%; }

        /* Novos Botões de Ação Final */
        .action-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .btn-edit-action { background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-delete-action { background: #ef4444; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <label>Verificar se Cliente já existe (Busca por Nome, CPF ou E-mail)</label>
        <div class="search-box">
            <input type="text" id="inputBuscaGlobal" placeholder="Digite para buscar...">
            <button class="btn-search" onclick="buscarEntidadeExistente()"><i class="fas fa-search"></i> Buscar</button>
        </div>
    </div>

    <div class="card">
        <h3 id="form-title">Novo Cadastro de Entidade</h3>
        <input type="hidden" id="edit-id">

        <div class="section-title">Informações e Acesso</div>
        <div class="form-grid">
            <div><label>Nome Completo / Razão *</label><input type="text" id="nome_completo"></div>
            <div><label>CPF / CNPJ</label><input type="text" id="cpf"></div>
            <div><label>Data Nascimento</label><input type="date" id="data_nascimento"></div>
            <div><label>E-mail</label><input type="email" id="email"></div>
            <div><label>Telefone / WhatsApp *</label><input type="text" id="telefone"></div>
            <div>
                <label>Senha Interna</label>
                <div class="password-wrapper">
                    <input type="password" id="senha_acesso">
                    <i class="fas fa-eye" id="togglePassword" onclick="togglePasswordVisibility()"></i>
                </div>
            </div>
            <div><label>Nível de Acesso</label><select id="acesso"><option value="cliente">Cliente</option><option value="funcionario">Funcionário</option><option value="comprador">Comprador</option><option value="master">Master</option></select></div>
            <div><label>Relacionamento</label><select id="relacionamento"><option value="cliente">Cliente</option><option value="funcionario">Funcionário</option><option value="fornecedor">Fornecedor</option><option value="terceirizado">Terceirizado</option><option value="outros">Outros</option></select></div>
            <div><label>Status</label><select id="status"><option value="ativo">Ativo</option><option value="desativado">Desativado</option></select></div>
            <div><label>Avaliação (0-10)</label><input type="number" id="avaliacao" min="0" max="10" value="5"></div>
        </div>

        <div class="section-title">Endereço</div>
        <div class="form-grid">
            <div><label>CEP</label><input type="text" id="cep" maxlength="8" onblur="buscaCEP()"></div>
            <div style="grid-column: span 2;"><label>Logradouro</label><input type="text" id="logradouro"></div>
            <div><label>Número</label><input type="text" id="numero"></div>
            <div><label>Bairro</label><input type="text" id="bairro"></div>
            <div><label>Cidade</label><input type="text" id="cidade"></div>
            <div><label>UF</label><input type="text" id="estado" maxlength="2"></div>
        </div>

        <div class="section-title">Complementos</div>
        <div class="form-grid">
            <div style="grid-column: span 2;"><label>URL de Arquivos</label><input type="text" id="arquivos_url"></div>
            <div style="grid-column: span 2;"><label>Observações</label><textarea id="observacoes" rows="2"></textarea></div>
        </div>

        <button class="btn-add" id="btn-save" onclick="handleSave()">Salvar Entidade</button>
        
        <div class="action-footer">
            <button class="btn-edit-action" onclick="acionarEdicao()"><i class="fas fa-edit"></i> Editar Atual</button>
            <button class="btn-delete-action" onclick="deletarEntidadeAtual()"><i class="fas fa-trash"></i> Excluir Atual</button>
        </div>
        
        <button class="btn-cancel" id="btn-cancel" onclick="resetForm()">Cancelar / Limpar</button>
    </div>
</div>

<script src="config.js"></script>
<script src="guard.js"></script>

<script>
function togglePasswordVisibility() {
    const p = document.getElementById('senha_acesso');
    const i = document.getElementById('togglePassword');
    p.type = p.type === 'password' ? 'text' : 'password';
    i.classList.toggle('fa-eye'); i.classList.toggle('fa-eye-slash');
}

async function buscaCEP() {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if (cep.length === 8) {
        try {
            const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await res.json();
            if (!data.erro) {
                document.getElementById('logradouro').value = data.logradouro;
                document.getElementById('bairro').value = data.bairro;
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('estado').value = data.uf;
            }
        } catch { console.error("Erro CEP"); }
    }
}

// BUSCA GLOBAL NO BANCO
async function buscarEntidadeExistente() {
    const termo = document.getElementById('inputBuscaGlobal').value;
    if(!termo) return alert("Digite algo para buscar.");

    const { data, error } = await _supabase
        .from('entidades')
        .select('*')
        .or(`nome_completo.ilike.%${termo}%,cpf.eq.${termo},email.eq.${termo},telefone.ilike.%${termo}%`)
        .maybeSingle();

    if (error) return alert("Erro na busca: " + error.message);
    if (data) {
        preencherFormulario(data);
        alert("Entidade encontrada e carregada!");
    } else {
        alert("Nenhum registro encontrado com esses dados.");
    }
}

function preencherFormulario(data) {
    Object.keys(data).forEach(k => {
        const el = document.getElementById(k);
        if (el) el.value = (k === 'arquivos_url' && data[k]) ? data[k][0] : (data[k] || '');
    });
    document.getElementById('edit-id').value = data.id;
    document.getElementById('form-title').innerText = "Visualizando/Editando Entidade";
    document.getElementById('btn-cancel').style.display = "block";
}

async function handleSave() {
    const { data: { user } } = await _supabase.auth.getUser();
    const id = document.getElementById('edit-id').value;
    const dados = capturarCampos(user.id);

    if (!dados.nome_completo) return alert("Nome é obrigatório");

    const { error } = id 
        ? await _supabase.from('entidades').update(dados).eq('id', id) 
        : await _supabase.from('entidades').insert([dados]);

    if (error) alert("Erro: " + error.message); else { alert("Sucesso!"); resetForm(); }
}

function acionarEdicao() {
    const id = document.getElementById('edit-id').value;
    if(!id) return alert("Busque uma entidade primeiro para editar.");
    document.getElementById('form-title').innerText = "Editando Entidade";
    alert("Modo de edição ativado para este registro.");
}

async function deletarEntidadeAtual() {
    const id = document.getElementById('edit-id').value;
    if(!id) return alert("Busque uma entidade primeiro para excluir.");
    if(confirm("Deseja realmente excluir este registro permanentemente?")) {
        const { error } = await _supabase.from('entidades').delete().eq('id', id);
        if(!error) { alert("Excluído!"); resetForm(); }
    }
}

function capturarCampos(uid) {
    return {
        usuario_id: uid,
        nome_completo: document.getElementById('nome_completo').value,
        cpf: document.getElementById('cpf').value,
        data_nascimento: document.getElementById('data_nascimento').value || null,
        email: document.getElementById('email').value,
        telefone: document.getElementById('telefone').value,
        senha_acesso: document.getElementById('senha_acesso').value,
        acesso: document.getElementById('acesso').value,
        relacionamento: document.getElementById('relacionamento').value,
        status: document.getElementById('status').value,
        avaliacao: parseInt(document.getElementById('avaliacao').value),
        observacoes: document.getElementById('observacoes').value,
        cep: document.getElementById('cep').value,
        logradouro: document.getElementById('logradouro').value,
        numero: document.getElementById('numero').value,
        bairro: document.getElementById('bairro').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value,
        arquivos_url: document.getElementById('arquivos_url').value ? [document.getElementById('arquivos_url').value] : []
    };
}

function resetForm() {
    document.querySelectorAll('input, select, textarea').forEach(i => {
        if(i.id === 'avaliacao') i.value = '5';
        else if(i.tagName === 'SELECT') i.selectedIndex = 0;
        else i.value = '';
    });
    document.getElementById('edit-id').value = '';
    document.getElementById('form-title').innerText = "Novo Cadastro de Entidade";
    document.getElementById('btn-cancel').style.display = "none";
}
</script>

</body>
</html>
