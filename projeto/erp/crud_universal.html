<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Inquilino - ERP ABP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Estilização seguindo o padrão do seu produtos.html */
        :root { --primary: #3ecf8e; --dark: #0f172a; --bg: #f1f5f9; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); padding-top: 85px; color: #1e293b; }
        
        #container-seletor-tabelas { padding: 15px; background: white; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; }
        
        .card { 
            background: white; padding: 25px; border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            max-width: 600px; margin: auto; 
        }

        .form-grid-vertical { display: flex; flex-direction: column; gap: 15px; }
        
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: 600; text-transform: uppercase; }
        
        .input-form { 
            width: 100%; padding: 11px; border: 1px solid #e2e8f0; border-radius: 8px; 
            background: #fff; font-size: 14px;
        }

        /* Estilo para campo ID (Não editável) */
        .input-readonly { 
            background: #f8fafc; 
            color: #94a3b8; 
            cursor: not-allowed; 
            border-style: dashed;
        }

        .btn-add { 
            background: var(--primary); color: white; padding: 15px; 
            border: none; border-radius: 8px; cursor: pointer; 
            width: 100%; margin-top: 20px; font-weight: bold; 
            transition: 0.3s;
        }
        .btn-add:hover { filter: brightness(1.1); }
    </style>
</head>
<body>

    <div id="container-seletor-tabelas"></div>
    
    <div class="container">
        <div id="area-dinamica">
            </div>
    </div>

<script src="js/conexao_supabase.js"></script>

<script>
/** ############################################################################## */
/** ERP ABP - SELETOR E GERADOR UNIVERSAL (Versão Aristides - ID Automático) */
(() => {
    "use strict";

    window.tabela_selecionada = "";

    const inicializarSeletor = async () => {
        if (typeof window._supabase === "undefined") {
            setTimeout(inicializarSeletor, 500);
            return;
        }

        try {
            const { data, error } = await _supabase.rpc('get_tables');
            if (error) throw error;

            const container = document.getElementById('container-seletor-tabelas');
            container.innerHTML = `
                <select id="tabela_ativa" class="input-form" style="max-width:300px;">
                    <option value="">-- Selecione a Tabela --</option>
                    ${data.map(t => `<option value="${t.table_name}">${t.table_name.toUpperCase()}</option>`).join('')}
                </select>
            `;

            document.getElementById('tabela_ativa').addEventListener('change', (e) => {
                window.tabela_selecionada = e.target.value;
                CriarFormulario.carregar();
            });
        } catch (err) { console.error(err); }
    };

    inicializarSeletor();
})();

const CriarFormulario = {
    ignorar: ['created_at', 'usuario_id', 'user_id'],

    async carregar() {
        const area = document.getElementById('area-dinamica');
        const tabela = window.tabela_selecionada;
        if (!tabela) return area.innerHTML = "";

        area.innerHTML = `<div class="card"><i class="fas fa-sync fa-spin"></i> Lendo ${tabela}...</div>`;

        try {
            const { data: colunas, error } = await _supabase.rpc('get_column_metadata', { t_name: tabela });
            if (error) throw error;

            let formHtml = `<div class="card">
                <h3 style="margin-top:0; color:var(--primary)">Cadastro: ${tabela.toUpperCase()}</h3>
                <form id="form-universal" class="form-grid-vertical">`;

            for (const col of colunas) {
                if (this.ignorar.includes(col.column_name)) continue;

                const ehId = col.column_name.toLowerCase() === 'id';

                formHtml += `<div>
                    <label>${col.column_name.replace(/_/g, ' ')}</label>`;

                if (col.foreign_table) {
                    formHtml += `<select name="${col.column_name}" id="ref_${col.column_name}" class="input-form" required></select>`;
                    this.preencherSelectEstrangeiro(col.column_name, col.foreign_table);
                } else {
                    const type = col.data_type.includes('date') ? 'date' : (col.data_type.includes('int') || col.data_type.includes('numeric') ? 'number' : 'text');
                    
                    // REQUISITO: Campo ID visível mas NÃO editável
                    if (ehId) {
                        formHtml += `<input type="text" name="${col.column_name}" class="input-form input-readonly" value="GERADO AUTOMATICAMENTE" readonly>`;
                    } else {
                        formHtml += `<input type="${type}" name="${col.column_name}" class="input-form" step="any" required>`;
                    }
                }
                formHtml += `</div>`;
            }

            formHtml += `<button type="submit" class="btn-add">Salvar no ERP</button></form></div>`;
            area.innerHTML = formHtml;

            // Lógica de Salvamento (Baseada no seu produtos.html)
            document.getElementById('form-universal').onsubmit = async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                btn.disabled = true;
                btn.innerText = "Processando...";

                const formData = new FormData(e.target);
                const dadosParaSalvar = Object.fromEntries(formData.entries());

                // EXCLUSÃO DO ID: Garante que o banco gere o próximo número serial automaticamente
                delete dadosParaSalvar.id;

                // Adiciona o usuario_id se a tabela exigir (como em produtos.html)
                const { data: { user } } = await _supabase.auth.getUser();
                if (user) dadosParaSalvar.usuario_id = user.id;

                const { error: insertErr } = await _supabase.from(tabela).insert([dadosParaSalvar]);

                if (insertErr) {
                    alert("Erro ao salvar: " + insertErr.message);
                } else {
                    alert("Registro cadastrado com sucesso!");
                    e.target.reset();
                }
                btn.disabled = false;
                btn.innerText = "Salvar no ERP";
            };

        } catch (err) { area.innerHTML = "Erro ao mapear tabela."; }
    },

    async preencherSelectEstrangeiro(campoId, tabelaDestino) {
        const { data } = await _supabase.from(tabelaDestino).select('*');
        const select = document.getElementById(`ref_${campoId}`);
        if (data && select) {
            let opt = `<option value="">-- Selecione --</option>`;
            data.forEach(i => {
                const label = i.nome || i.nome_completo || i.descricao || i.id;
                opt += `<option value="${i.id}">${label}</option>`;
            });
            select.innerHTML = opt;
        }
    }
};
</script>
</body>
</html>
