<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>CRUD Universal - ERP ABP</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SUPABASE -->
    <script src="js/conexao_supabase.js"></script>

    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- CSS -->
    <style>
        :root {
    --primary: #3ecf8e;
    --dark: #0f172a;
    --danger: #ef4444;
    --bg: #f1f5f9;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    background: var(--bg);
    font-family: 'Segoe UI', sans-serif;
    padding: 20px;
}

.container {
    max-width: 1300px;
    margin: auto;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}

.toolbar {
    display: flex;
    gap: 10px;
    margin: 15px 0;
}

.toolbar input {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
}

.btn {
    padding: 10px 15px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

.btn.primary {
    background: var(--primary);
    color: white;
}

.btn.danger {
    background: var(--danger);
    color: white;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 12px;
    border-bottom: 1px solid #e5e7eb;
    font-size: 14px;
}

th {
    background: #f8fafc;
    text-align: left;
}

.actions {
    display: flex;
    gap: 8px;
}

input, select {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #cbd5e1;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
    gap: 15px;
}

.form-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}
    </style>
</head>
<body>

<div class="container">

    <!-- SELETOR DE TABELA -->
    <div id="container-seletor-tabelas"></div>

    <!-- AÇÕES -->
    <div class="toolbar">
        <button class="btn primary" onclick="CRUD.novo()">
            <i class="fas fa-plus"></i> Novo Registro
        </button>

        <input type="text" id="buscaGlobal" placeholder="Buscar..." onkeyup="CRUD.filtrar()">
    </div>

    <!-- FORMULÁRIO -->
    <div class="card" id="formCard" style="display:none">
        <h3 id="formTitle">Novo Registro</h3>
        <form id="formUniversal"></form>

        <div class="form-actions">
            <button class="btn primary" type="submit">
                <i class="fas fa-save"></i> Salvar
            </button>
            <button class="btn" type="button" onclick="CRUD.cancelar()">Cancelar</button>
        </div>
    </div>

    <!-- LISTAGEM -->
    <div class="card">
        <div class="table-container">
            <table>
                <thead id="thead"></thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
const CRUD = (() => {
    let tabela = '';
    let dados = [];
    let colunas = [];
    let editId = null;

    const ignorar = ['id', 'created_at', 'usuario_id', 'user_id'];

    async function carregarTabela() {
        tabela = window.tabela_selecionada;
        if (!tabela) return;

        await carregarColunas();
        await listar();
    }

    async function carregarColunas() {
        const { data, error } = await _supabase
            .rpc('get_column_metadata', { t_name: tabela });

        if (error) return alert(error.message);
        colunas = data.filter(c => !ignorar.includes(c.column_name));
    }

    async function listar() {
        const { data, error } = await _supabase.from(tabela).select('*');
        if (error) return alert(error.message);

        dados = data || [];
        renderTabela(dados);
    }

    function renderTabela(lista) {
        const thead = document.getElementById('thead');
        const tbody = document.getElementById('tbody');

        thead.innerHTML = `
            <tr>
                ${colunas.map(c => `<th>${c.column_name}</th>`).join('')}
                <th>Ações</th>
            </tr>
        `;

        tbody.innerHTML = lista.map(l => `
            <tr>
                ${colunas.map(c => `<td>${l[c.column_name] ?? ''}</td>`).join('')}
                <td class="actions">
                    <button class="btn" onclick="CRUD.editar('${l.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn danger" onclick="CRUD.excluir('${l.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function montarFormulario(registro = {}) {
        const form = document.getElementById('formUniversal');
        form.innerHTML = `
            <div class="form-grid">
                ${colunas.map(c => `
                    <div>
                        <label>${c.column_name}</label>
                        <input name="${c.column_name}" value="${registro[c.column_name] ?? ''}">
                    </div>
                `).join('')}
            </div>
        `;

        form.onsubmit = salvar;
    }

    async function salvar(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const obj = Object.fromEntries(formData.entries());

        const query = editId
            ? _supabase.from(tabela).update(obj).eq('id', editId)
            : _supabase.from(tabela).insert([obj]);

        const { error } = await query;
        if (error) return alert(error.message);

        cancelar();
        listar();
    }

    function novo() {
        editId = null;
        document.getElementById('formTitle').innerText = 'Novo Registro';
        document.getElementById('formCard').style.display = 'block';
        montarFormulario();
    }

    function editar(id) {
        editId = id;
        const registro = dados.find(d => d.id === id);
        document.getElementById('formTitle').innerText = 'Editar Registro';
        document.getElementById('formCard').style.display = 'block';
        montarFormulario(registro);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function excluir(id) {
        if (!confirm('Confirma exclusão?')) return;
        const { error } = await _supabase.from(tabela).delete().eq('id', id);
        if (error) alert(error.message);
        listar();
    }

    function cancelar() {
        editId = null;
        document.getElementById('formCard').style.display = 'none';
    }

    function filtrar() {
        const termo = document.getElementById('buscaGlobal').value.toLowerCase();
        const filtrados = dados.filter(d =>
            Object.values(d).some(v =>
                String(v).toLowerCase().includes(termo)
            )
        );
        renderTabela(filtrados);
    }

    document.addEventListener('change', e => {
        if (e.target.id === 'tabela_ativa') carregarTabela();
    });

    return { novo, editar, excluir, cancelar, filtrar };
})();
    
</script>
</body>
    </html>
