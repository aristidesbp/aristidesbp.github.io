<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - ERP ABP</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #3ecf8e; --dark: #0f172a; --sidebar-w: 260px; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f1f5f9; padding-top: 80px; }

        /* NAVBAR & SIDEBAR */
        .navbar { position: fixed; top: 0; left: 0; right: 0; height: 65px; background: var(--dark); color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .menu-btn { font-size: 22px; cursor: pointer; color: var(--primary); background: none; border: none; }
        .sidebar { position: fixed; top: 0; left: -260px; width: var(--sidebar-w); height: 100%; background: var(--dark); color: white; transition: 0.3s; z-index: 1001; padding-top: 20px; }
        .sidebar.active { left: 0; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; }
        .sidebar-overlay.active { display: block; }
        .sidebar a { display: block; padding: 15px 25px; color: white; text-decoration: none; border-bottom: 1px solid #1e293b; }

        /* FORMUL√ÅRIO */
        .container { max-width: 1100px; margin: auto; padding: 20px; }
        .card-form { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .section-title { color: var(--primary); font-size: 14px; text-transform: uppercase; margin: 20px 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 5px; font-weight: bold; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: bold; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        .btn-add { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; flex: 2; font-size: 16px; }
        .btn-cancel { background: #64748b; color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; flex: 1; display: none; }

        /* TABELA */
        .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; text-align: left; padding: 15px; color: #64748b; font-size: 12px; text-transform: uppercase; }
        td { padding: 15px; border-top: 1px solid #f1f5f9; font-size: 14px; }
        .btn-edit { color: #3b82f6; background: none; border: none; cursor: pointer; font-size: 16px; margin-right: 10px; }
        .btn-del { color: #ef4444; background: none; border: none; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-left">
            <button class="menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <span style="font-weight: bold;">üë• CADASTRO COMPLETO DE CLIENTES</span>
        </div>
    </nav>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div style="padding: 25px; font-weight: bold; color: var(--primary);">MENU</div>
        <a href="../index.html"><i class="fas fa-chart-line"></i> Dashboard</a>
        <a href="clientes.html"><i class="fas fa-users"></i> Clientes</a>
    </div>

    <div class="container">
        <div class="card-form">
            <h3 id="form-title">Dados do Cliente</h3>
            <input type="hidden" id="edit-id">
            
            <div class="section-title">Informa√ß√µes Pessoais</div>
            <div class="form-grid">
                <div><label>Nome Completo *</label><input type="text" id="nome_completo"></div>
                <div><label>CPF (11 d√≠gitos) *</label><input type="text" id="cpf" maxlength="11"></div>
                <div><label>Data Nascimento *</label><input type="date" id="data_nascimento"></div>
                <div><label>E-mail</label><input type="email" id="email"></div>
                <div><label>Telefone</label><input type="text" id="telefone"></div>
                <div><label>RG</label><input type="text" id="rg"></div>
            </div>

            <div class="section-title">Endere√ßo</div>
            <div class="form-grid">
                <div><label>CEP</label><input type="text" id="cep" maxlength="8" onblur="buscaCEP()"></div>
                <div style="grid-column: span 2;"><label>Logradouro</label><input type="text" id="logradouro"></div>
                <div><label>N√∫mero</label><input type="text" id="numero"></div>
                <div><label>Bairro</label><input type="text" id="bairro"></div>
                <div><label>Cidade</label><input type="text" id="cidade"></div>
                <div><label>UF</label><input type="text" id="estado" maxlength="2"></div>
            </div>

            <div class="btn-group">
                <button class="btn-add" id="btn-save" onclick="handleSave()">Salvar Cadastro Completo</button>
                <button class="btn-cancel" id="btn-cancel" onclick="resetForm()">Cancelar</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>Endere√ßo Atual</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="clients-list"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://kjhjeaiwjilkgocwvbwi.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_WP3TF2GTMMWCS1tCYzQSjA_syIKLyIX';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUserProfile = null;

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('active'); document.querySelector('.sidebar-overlay').classList.toggle('active'); }

        async function buscaCEP() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            if (cep.length === 8) {
                const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const d = await r.json();
                if (!d.erro) {
                    document.getElementById('logradouro').value = d.logradouro;
                    document.getElementById('bairro').value = d.bairro;
                    document.getElementById('cidade').value = d.localidade;
                    document.getElementById('estado').value = d.uf;
                }
            }
        }

        async function checkUser() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) window.location.href = '../login.html';
            const { data: profile } = await _supabase.from('usuarios').select('*').eq('user_id', session.user.id).single();
            currentUserProfile = profile;
            loadClients();
        }

        async function loadClients() {
            try {
                // Tentamos buscar com endere√ßos. Se a rela√ß√£o falhar, buscamos s√≥ os clientes.
                let { data: clients, error } = await _supabase
                    .from('clientes')
                    .select('*, enderecos(*)')
                    .order('nome_completo');

                // Se der erro de relacionamento, busca apenas os dados b√°sicos para n√£o travar a tela
                if (error && error.message.includes('relationship')) {
                    const basic = await _supabase.from('clientes').select('*').order('nome_completo');
                    clients = basic.data;
                } else if (error) throw error;

                const list = document.getElementById('clients-list');
                list.innerHTML = (clients || []).map(c => {
                    const end = (c.enderecos && c.enderecos[0]) 
                        ? `${c.enderecos[0].logradouro}, ${c.enderecos[0].numero} - ${c.enderecos[0].cidade}` 
                        : '<span style="color:#94a3b8; font-style: italic;">Endere√ßo n√£o vinculado</span>';
                    
                    return `
                    <tr>
                        <td><strong>${c.nome_completo}</strong></td>
                        <td>${c.cpf}</td>
                        <td><small>${end}</small></td>
                        <td>
                            <button class="btn-edit" onclick="editFull('${c.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-del" onclick="deleteFull('${c.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('') || '<tr><td colspan="4" style="text-align:center">Nenhum cliente cadastrado.</td></tr>';
            } catch (err) {
                console.error(err);
                document.getElementById('clients-list').innerHTML = `<tr><td colspan="4" style="color:red; text-align:center">Erro cr√≠tico: ${err.message}</td></tr>`;
            }
        }

        async function handleSave() {
            const id = document.getElementById('edit-id').value;
            const clientData = {
                nome_completo: document.getElementById('nome_completo').value,
                cpf: document.getElementById('cpf').value,
                data_nascimento: document.getElementById('data_nascimento').value,
                email: document.getElementById('email').value,
                telefone: document.getElementById('telefone').value,
                rg: document.getElementById('rg').value,
                usuario_id: currentUserProfile.id
            };

            try {
                let clientId = id;
                if (id) {
                    await _supabase.from('clientes').update(clientData).eq('id', id);
                } else {
                    const { data, error } = await _supabase.from('clientes').insert([clientData]).select('id').single();
                    if (error) throw error;
                    clientId = data.id;
                }

                const addrData = {
                    logradouro: document.getElementById('logradouro').value,
                    numero: document.getElementById('numero').value,
                    bairro: document.getElementById('bairro').value,
                    cidade: document.getElementById('cidade').value,
                    estado: document.getElementById('estado').value,
                    cep: document.getElementById('cep').value,
                    cliente_id: clientId,
                    usuario_id: currentUserProfile.id
                };

                const { data: existingAddr } = await _supabase.from('enderecos').select('id').eq('cliente_id', clientId).maybeSingle();
                
                if (existingAddr) {
                    await _supabase.from('enderecos').update(addrData).eq('id', existingAddr.id);
                } else {
                    await _supabase.from('enderecos').insert([addrData]);
                }

                alert("Salvo com sucesso!");
                resetForm();
                loadClients();
            } catch (e) { alert("Erro ao salvar: " + e.message); }
        }

        async function editFull(id) {
    try {
        console.log("Iniciando edi√ß√£o para o ID:", id);
        
        // 1. Primeiro buscamos os dados do cliente
        const { data: cliente, error: errCliente } = await _supabase
            .from('clientes')
            .select('*')
            .eq('id', id)
            .single();

        if (errCliente) throw errCliente;

        // 2. Preenchemos os campos b√°sicos do cliente no formul√°rio
        document.getElementById('edit-id').value = cliente.id;
        document.getElementById('nome_completo').value = cliente.nome_completo || '';
        document.getElementById('cpf').value = cliente.cpf || '';
        document.getElementById('data_nascimento').value = cliente.data_nascimento || '';
        document.getElementById('email').value = cliente.email || '';
        document.getElementById('telefone').value = cliente.telefone || '';
        document.getElementById('rg').value = cliente.rg || '';

        // 3. Tentamos buscar o endere√ßo em uma consulta separada para n√£o travar
        const { data: endereco, error: errEnd } = await _supabase
            .from('enderecos')
            .select('*')
            .eq('cliente_id', id)
            .maybeSingle();

        // Se houver endere√ßo, preenchemos os campos
        if (endereco) {
            document.getElementById('cep').value = endereco.cep || '';
            document.getElementById('logradouro').value = endereco.logradouro || '';
            document.getElementById('numero').value = endereco.numero || '';
            document.getElementById('bairro').value = endereco.bairro || '';
            document.getElementById('cidade').value = endereco.cidade || '';
            document.getElementById('estado').value = endereco.estado || '';
        } else {
            // Se n√£o houver, limpamos os campos de endere√ßo
            ['cep', 'logradouro', 'numero', 'bairro', 'cidade', 'estado'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        // 4. Mudamos o visual do bot√£o para indicar edi√ß√£o
        document.getElementById('btn-save').innerText = "Atualizar Cadastro Completo";
        document.getElementById('btn-cancel').style.display = "block";
        
        // Sobe a p√°gina suavemente para o usu√°rio ver o formul√°rio cheio
        window.scrollTo({ top: 0, behavior: 'smooth' });

    } catch (err) {
        console.error("Erro detalhado na edi√ß√£o:", err);
        alert("Erro ao carregar dados para editar: " + err.message);
    }
}
        function resetForm() {
            document.getElementById('edit-id').value = '';
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.getElementById('btn-save').innerText = "Salvar Cadastro Completo";
            document.getElementById('btn-cancel').style.display = "none";
        }

        async function deleteFull(id) {
            if (confirm("Excluir cliente e endere√ßo?")) {
                await _supabase.from('clientes').delete().eq('id', id);
                loadClients();
            }
        }

        checkUser();
    </script>
</body>
</html>
