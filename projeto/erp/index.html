<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Inquilino - Edifício José Viana</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/conexao_supabase.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <link rel="manifest" href="manifest.json" id="pwa-manifest">
</head>
<body>

    <header class="navbar-premium">
        <div class="logo-area">
            <i class="fas fa-building-columns"></i>
            <div>
                <h1>EDIFÍCIO JOSÉ VIANA</h1>
                <span>Gestão Profissional de Condomínio</span>
            </div>
        </div>
        <button id="btnInstall" class="btn-install">
            <i class="fas fa-mobile-alt"></i> Instalar App
        </button>
    </header>

    <main class="content">
        <section class="welcome-section">
            <h2>Bem-vindo ao Portal do Inquilino</h2>
            <p>Selecione uma das opções abaixo para interagir com a administração.</p>
        </section>

        <div class="action-grid">
            <div class="action-card" onclick="abrirInterfone()">
                <div class="icon-circle"><i class="fab fa-whatsapp"></i></div>
                <h3>Interfone Digital</h3>
                <p>Portaria em Tempo Real</p>
            </div>

            <div class="action-card" onclick="abrirModal('servico')">
                <div class="icon-circle"><i class="fas fa-tools"></i></div>
                <h3>Agendar Serviço</h3>
                <p>Manutenção e Reparos</p>
            </div>

            <div class="action-card" onclick="abrirModal('visitante')">
                <div class="icon-circle"><i class="fas fa-id-card"></i></div>
                <h3>Autorizar Entrada</h3>
                <p>Visitantes e Pacientes</p>
            </div>

            <div class="action-card" onclick="abrirModal('reclamacao')">
                <div class="icon-circle"><i class="fas fa-bullhorn"></i></div>
                <h3>Reclame Aqui</h3>
                <p>Sugestões e Ocorrências</p>
            </div>
        </div>

        <div class="info-layout">
            <section class="card glass">
                <h3 class="gold-title"><i class="fas fa-newspaper"></i> Quadro de Avisos</h3>
                <div id="lista-avisos">
                    <div class="aviso-item">Carregando informações do prédio...</div>
                </div>
            </section>

            <section class="card glass">
                <h3 class="gold-title"><i class="fas fa-door-open"></i> Fluxo de Acesso</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Pessoa</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-acessos"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <div id="modal-base" class="modal">
        <div class="modal-content glass">
            <span class="close-btn" onclick="fecharModal()">&times;</span>
            <div id="modal-render"></div>
        </div>
    </div>

    <script>
      (function() {
    // 1. Configuração de Conexão (Substitua pelos seus dados do projeto)
    const SUPABASE_URL = 'https://kjhjeaiwjilkgocwvbwi.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_WP3TF2GTMMWCS1tCYzQSjA_syIKLyIX';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Variáveis de Controle
    let slotsHorario = [];
    let deferredPrompt;

    // 2. Estilos Dinâmicos (Preto, Dourado e Marrom)
    const style = document.createElement('style');
    style.innerHTML = `
        :root {
            --gold: #d4af37;
            --gold-light: #f1e5ac;
            --dark: #121212;
            --brown: #3d2b1f;
            --text: #e0e0e0;
        }
        body { 
            margin: 0; font-family: 'Poppins', sans-serif; 
            background: radial-gradient(circle, #2a2a2a 0%, #121212 100%); 
            color: var(--text); padding-top: 90px;
        }
        .navbar-premium {
            position: fixed; top: 0; width: 100%; height: 80px;
            background: rgba(18, 18, 18, 0.95); border-bottom: 2px solid var(--gold);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .logo-area h1 { font-family: 'Playfair Display', serif; margin: 0; font-size: 1.4rem; color: var(--gold); }
        .btn-install { background: var(--gold); color: var(--dark); border: none; padding: 10px 18px; border-radius: 50px; font-weight: bold; cursor: pointer; }
        .action-card { 
            background: linear-gradient(145deg, #1e1e1e, #121212);
            border: 1px solid #333; padding: 30px; border-radius: 15px; text-align: center;
            cursor: pointer; transition: 0.3s;
        }
        .action-card:hover { border-color: var(--gold); transform: translateY(-5px); }
        .gold-title { color: var(--gold); border-bottom: 1px solid var(--brown); padding-bottom: 10px; margin-bottom: 20px; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; border-radius: 8px; }
        .btn-gold { background: var(--gold); color: var(--dark); border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .dynamic-item { background: rgba(212, 175, 55, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 3px solid var(--gold); font-size: 0.9rem; }
    `;
    document.head.appendChild(style);

    // 3. Funções de Interface
    window.abrirModal = function(tipo) {
        const render = document.getElementById('modal-render');
        document.getElementById('modal-base').style.display = 'block';
        slotsHorario = [];

        if (tipo === 'visitante') {
            render.innerHTML = `
                <h3 class="gold-title">Autorizar Entrada</h3>
                <input type="text" id="v_sala" placeholder="Número da Sala">
                <input type="text" id="v_inquilino" placeholder="Nome do Inquilino">
                <input type="text" id="v_cliente" placeholder="Nome do Cliente/Paciente">
                <input type="text" id="v_rg" placeholder="RG do Cliente/Paciente">
                <div style="margin-top:15px; border-top: 1px solid var(--brown); padding-top:10px;">
                    <label style="color:var(--gold); font-size: 0.8rem;">Adicionar Horário de Acesso:</label>
                    <div style="display:flex; gap:5px;">
                        <input type="date" id="temp_data">
                        <input type="time" id="temp_hora">
                        <button type="button" onclick="addHorario()" class="btn-gold" style="width:50px; margin-top:10px;"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="lista-horarios"></div>
                </div>
                <button class="btn-gold" style="margin-top:20px;" onclick="salvarVisita()">Confirmar Autorização</button>
            `;
        } else if (tipo === 'servico') {
            render.innerHTML = `
                <h3 class="gold-title">Agendar Serviço</h3>
                <input type="text" id="s_sala" placeholder="Número da Sala">
                <input type="text" id="s_tipo" placeholder="Tipo de Serviço (Ex: Ar-condicionado)">
                <div style="display:flex; gap:10px;">
                    <div style="flex:1"><label style="font-size:0.7rem">DATA</label><input type="date" id="s_data"></div>
                    <div style="flex:1">
                        <label style="font-size:0.7rem">PERÍODO</label>
                        <select id="s_periodo" onchange="document.getElementById('row-horas').style.display = (this.value === 'dia') ? 'none' : 'flex'">
                            <option value="hora">Hora Marcada</option>
                            <option value="dia">Dia Inteiro</option>
                        </select>
                    </div>
                </div>
                <div id="row-horas" style="display:flex; gap:10px;">
                    <input type="time" id="s_inicio" title="Início">
                    <input type="time" id="s_fim" title="Fim">
                </div>
                <button class="btn-gold" onclick="salvarServico()">Solicitar Agendamento</button>
            `;
        } else if (tipo === 'reclamacao') {
            render.innerHTML = `
                <h3 class="gold-title">Reclame Aqui</h3>
                <select id="r_cat"><option>Limpeza</option><option>Segurança</option><option>Barulho</option></select>
                <textarea id="r_msg" rows="4" placeholder="Detalhes da ocorrência..."></textarea>
                <button class="btn-gold" onclick="salvarOcorrencia()">Enviar</button>
            `;
        }
    };

    window.fecharModal = () => document.getElementById('modal-base').style.display = 'none';

    // 4. Lógica de Formulários Dinâmicos
    window.addHorario = function() {
        const d = document.getElementById('temp_data').value;
        const h = document.getElementById('temp_hora').value;
        if(!d || !h) return;
        slotsHorario.push({ data: d, hora: h });
        const list = document.getElementById('lista-horarios');
        list.innerHTML = slotsHorario.map((s, i) => `
            <div class="dynamic-item">
                ${s.data.split('-').reverse().join('/')} às ${s.hora}
                <i class="fas fa-trash" style="float:right; color:red; cursor:pointer" onclick="removerSlot(${i})"></i>
            </div>
        `).join('');
    };

    window.removerSlot = (i) => { slotsHorario.splice(i,1); document.getElementById('lista-horarios').children[i].remove(); };

    // 5. Integração WhatsApp
    window.abrirInterfone = () => {
        window.open(`https://wa.me/5591992420981?text=${encodeURIComponent("Olá Portaria José Viana, gostaria de falar com o atendente.")}`, '_blank');
    };

    // 6. Instalação PWA
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('btnInstall').style.display = 'block';
    });

    document.getElementById('btnInstall')?.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt = null;
        } else {
            alert("Para instalar: no iPhone use 'Compartilhar > Adicionar à Tela de Início'. No Android use os 3 pontinhos do Chrome.");
        }
    });

    // 7. Persistência Supabase (Exemplo Visitante)
    window.salvarVisita = async () => {
        const dados = {
            sala: document.getElementById('v_sala').value,
            inquilino: document.getElementById('v_inquilino').value,
            paciente: document.getElementById('v_cliente').value,
            rg: document.getElementById('v_rg').value,
            horarios: slotsHorario
        };
        
        const { error } = await _supabase.from('visitas_jose_viana').insert([dados]);
        if(!error) { alert("Autorização enviada com sucesso!"); fecharModal(); }
        else { alert("Erro ao salvar: " + error.message); }
    };

    console.log("Script Edifício José Viana Ativo.");
})(); 
    </script>
</body>
</html>
