<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Profissional - ERP ABP</title>
    <script src="conexao.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --success: #10b981; --danger: #ef4444; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        
        .resumo-financeiro { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card-financeiro { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-financeiro h4 { margin: 0; color: #64748b; font-size: 14px; text-transform: uppercase; }
        .card-financeiro .valor { font-size: 24px; font-weight: 800; margin-top: 10px; }
        .valor.entrada { color: var(--success); }
        .valor.saida { color: var(--danger); }

        .tabela-financeira { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); width: 100%; border-collapse: collapse; }
        .tabela-financeira th { background: #f8fafc; padding: 15px; text-align: left; color: #64748b; font-size: 13px; }
        .tabela-financeira td { padding: 15px; border-top: 1px solid #f1f5f9; font-size: 14px; }
        
        .status-pago { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
        .status-pendente { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }

        .btn-acao { background: var(--primary); color: var(--dark); border: none; padding: 10px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="resumo-financeiro">
            <div class="card-financeiro">
                <h4>Receitas</h4>
                <div id="totalEntradas" class="valor entrada">R$ 0,00</div>
            </div>
            <div class="card-financeiro">
                <h4>Despesas</h4>
                <div id="totalSaidas" class="valor saida">R$ 0,00</div>
            </div>
            <div class="card-financeiro">
                <h4>Saldo em Caixa</h4>
                <div id="saldoTotal" class="valor">R$ 0,00</div>
            </div>
        </div>

        <button class="btn-acao" onclick="abrirModal()">+ Nova Transação</button>

        <table class="tabela-financeira">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descrição</th>
                    <th>Entidade</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="listaFinanceira"></tbody>
        </table>
    </div>

    <script>
        async function carregarFinanceiro() {
            const { data, error } = await _supabase.from('financeiro').select('*, entidades(nome_completo)').order('data_vencimento', { ascending: false });
            if (error) return;

            let entradas = 0, saidas = 0;
            const html = data.map(item => {
                const valor = parseFloat(item.valor);
                if (item.tipo === 'entrada') entradas += valor; else saidas += valor;

                return `<tr>
                    <td>${new Date(item.data_vencimento).toLocaleDateString()}</td>
                    <td>${item.descricao}</td>
                    <td>${item.entidades?.nome_completo || 'Geral'}</td>
                    <td style="color: ${item.tipo === 'entrada' ? 'var(--success)' : 'var(--danger)'}">${item.tipo.toUpperCase()}</td>
                    <td font-weight: 700>R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td><span class="status-${item.status}">${item.status.toUpperCase()}</span></td>
                </tr>`;
            }).join('');

            document.getElementById('listaFinanceira').innerHTML = html;
            document.getElementById('totalEntradas').innerText = `R$ ${entradas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('totalSaidas').innerText = `R$ ${saidas.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('saldoTotal').innerText = `R$ ${(entradas - saidas).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        const checkInit = setInterval(() => {
            if (window._supabase) { clearInterval(checkInit); carregarFinanceiro(); }
        }, 100);
    </script>
</body>
</html>
