<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Usuarios - ERP ABP</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>



    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
:root {
    --primary: #3ecf8e;
    --dark: #0f172a;
    --bg: #f1f5f9;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: var(--bg);
    padding-top: 85px;
}

.container {
    max-width: 1100px;
    margin: auto;
    padding: 20px;
}

.card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 20px;
}

.section-title {
    color: var(--primary);
    font-size: 14px;
    text-transform: uppercase;
    margin: 20px 0 10px;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
    font-weight: bold;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-size: 13px;
    color: #64748b;
    font-weight: bold;
}

input, select, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

/* Estilo para o campo de senha com Olho */
.password-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}
.password-wrapper i {
    position: absolute;
    right: 10px;
    cursor: pointer;
    color: #64748b;
}

input:focus, select:focus, textarea:focus {
    border-color: var(--primary);
    outline: none;
}

.btn-add {
    background: var(--primary);
    color: white;
    padding: 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    width: 100%;
    margin-top: 20px;
}

.btn-cancel {
    background: #64748b;
    color: white;
    margin-top: 10px;
    border: none;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    display: none;
    width: 100%;
}

.table-container {
    background: white;
    border-radius: 12px;
    overflow-x: auto;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

table { width: 100%; border-collapse: collapse; min-width: 800px; }
th { background: #f8fafc; padding: 15px; color: #64748b; font-size: 12px; text-transform: uppercase; }
td { padding: 15px; border-top: 1px solid #f1f5f9; }

.btn-edit { color: #3b82f6; cursor: pointer; font-size: 18px; background: none; border: none; margin-right: 10px;}
.btn-del { color: #ef4444; cursor: pointer; font-size: 18px; background: none; border: none; margin-right: 10px;}
.btn-wpp { color: #25d366; cursor: pointer; font-size: 18px; background: none; border: none; margin-right: 10px;}
.btn-mail { color: #ea4335; cursor: pointer; font-size: 18px; background: none; border: none; }

.navbar {
    position: fixed; top: 0; left: 0; width: 100%; background: white;
    padding: 15px 25px; display: flex; justify-content: space-between;
    align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000;
}
.nav-buttons { display: flex; gap: 15px; align-items: center; }
.btn-nav-back { text-decoration: none; color: #64748b; font-weight: bold; }
.btn-logout-nav {
    background: #ef4444; color: white; padding: 8px 15px; border-radius: 6px;
    font-weight: bold; font-size: 14px; border: none; cursor: pointer;
}

.export-area {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.btn-export {
    background: #2c3e50;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-export-full {
    background: #1e293b;
}
    </style>
</head>
<body>

<div class="navbar">
    <div style="font-weight: bold; color: #0f172a;">ERP ABP - USUARIOS</div>
    <div class="nav-buttons">
        <a href="index.html" class="btn-nav-back"><i class="fas fa-home"></i> Voltar</a>
        <button class="btn-logout-nav" onclick="sairDaConta()"><i class="fas fa-sign-out-alt"></i> Sair</button>
    </div>
</div>

<div class="container">
    <div class="card">
        <h3 id="form-title">Novo Cadastro de Entidade</h3>
        <input type="hidden" id="edit-id">

        <div class="section-title">Informações e Acesso</div>
        <div class="form-grid">
            <div><label>Nome Completo / Razão *</label><input type="text" id="nome_completo"></div>
            <div><label>CPF / CNPJ</label><input type="text" id="cpf"></div>
            <div><label>Data Nascimento</label><input type="date" id="data_nascimento"></div>
            <div><label>E-mail</label><input type="email" id="email"></div>
            <div><label>Telefone / WhatsApp *</label><input type="text" id="telefone"></div>
            <div>
                <label>Senha Interna</label>
                <div class="password-wrapper">
                    <input type="password" id="senha_acesso">
                    <i class="fas fa-eye" id="togglePassword" onclick="togglePasswordVisibility()"></i>
                </div>
            </div>
            
            <div>
                <label>Nível de Acesso</label>
                <select id="acesso">
                    <option value="cliente">Cliente</option>
                    <option value="funcionario">Funcionário</option>
                    <option value="comprador">Comprador</option>
                    <option value="master">Master</option>
                </select>
            </div>
            <div>
                <label>Relacionamento</label>
                <select id="relacionamento">
                    <option value="cliente">Cliente</option>
                    <option value="funcionario">Funcionário</option>
                    <option value="fornecedor">Fornecedor</option>
                    <option value="terceirizado">Terceirizado</option>
                    <option value="outros">Outros</option>
                </select>
            </div>
            <div>
                <label>Status</label>
                <select id="status">
                    <option value="ativo">Ativo</option>
                    <option value="desativado">Desativado</option>
                </select>
            </div>
            <div><label>Avaliação (0-10)</label><input type="number" id="avaliacao" min="0" max="10" value="5"></div>
        </div>

        <div class="section-title">Endereço</div>
        <div class="form-grid">
            <div><label>CEP</label><input type="text" id="cep" maxlength="8" onblur="buscaCEP()"></div>
            <div style="grid-column: span 2;"><label>Logradouro</label><input type="text" id="logradouro"></div>
            <div><label>Número</label><input type="text" id="numero"></div>
            <div><label>Bairro</label><input type="text" id="bairro"></div>
            <div><label>Cidade</label><input type="text" id="cidade"></div>
            <div><label>UF</label><input type="text" id="estado" maxlength="2"></div>
        </div>

        <div class="section-title">Complementos</div>
        <div class="form-grid">
            <div style="grid-column: span 2;"><label>URL de Arquivos</label><input type="text" id="arquivos_url"></div>
            <div style="grid-column: span 2;"><label>Observações</label><textarea id="observacoes" rows="2"></textarea></div>
        </div>

        <button class="btn-add" id="btn-save" onclick="handleSave()">Salvar Entidade</button>
        <button class="btn-cancel" id="btn-cancel" onclick="resetForm()">Cancelar Edição</button>
    </div>

    <div class="card" style="margin-bottom: 10px; padding: 15px;">
        <label><i class="fas fa-search"></i> BUSCAR ENTIDADE</label>
        <input type="text" id="inputBusca" placeholder="Digite o nome para filtrar..." onkeyup="filtrarTabela()">
        
        <div class="export-area">
            <button class="btn-export" onclick="exportarPDFListagem()">
                <i class="fas fa-list"></i> Exportar Listagem (PDF)
            </button>
            <button class="btn-export btn-export-full" onclick="exportarPDFFichaCompleta()">
                <i class="fas fa-file-invoice"></i> Exportar Fichas Detalhadas (PDF)
            </button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nome / Tipo</th>
                    <th>Telefone / E-mail</th>
                    <th>Acesso / Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="entities-list"></tbody>
        </table>
    </div>
</div>

<script>
// Configurações do Supabase
const SUPABASE_URL = 'https://luanoblszirvzqidhecr.supabase.co';
const SUPABASE_KEY = 'sb_publishable_jqhEnUuuEF4-zxKbgupuTQ_n-7h-qTp';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentData = [];

/** 1. INICIALIZAÇÃO E ACESSO */

async function validarAcesso() {
    const { data: { session } } = await _supabase.auth.getSession();
    if (!session) {
        const pathPrefix = window.location.pathname.includes('/pages/') ? '../' : '';
        window.location.href = pathPrefix + 'login.html';
    }
    return session;
} 

// Injeção da Navbar via JS (Regra de Arquitetura)
function renderNavbar() {
    const navHTML = `
    <div class="navbar">
        <div style="font-weight: bold; color: #0f172a;">ERP ABP - USUÁRIOS</div>
        <div class="nav-buttons">
            <select id="lang-switcher" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
                <option value="pt">Português</option>
                <option value="es">Español</option>
                <option value="en">English</option>
            </select>
            <a href="index.html" class="btn-nav-back"><i class="fas fa-home"></i> Voltar</a>
            <button class="btn-logout-nav" onclick="sairDaConta()"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </div>`;
    document.body.insertAdjacentHTML('afterbegin', navHTML);
}

/**
 * 2. GESTÃO DE DADOS (CRUD)
 */
async function loadEntities() {
    // Exemplo de invocação de serviço externo conforme sua regra
    try {
        const res = await fetch('servicos.json');
        const servicos = await res.json();
        console.log("Serviços disponíveis:", servicos);
    } catch (e) { console.warn("Arquivo servicos.json não encontrado."); }

    const { data, error } = await _supabase.from('usuarios').select('*').order('nome_completo');
    if (error) {
        console.error("Erro ao carregar:", error.message);
        return;
    }
    currentData = data || [];
    renderTable(currentData);
}

async function handleSave() {
    const id = document.getElementById('edit-id').value;
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha_acesso').value;
    const nome = document.getElementById('nome_completo').value;

    if (!nome || !email) return alert("Nome e E-mail são obrigatórios");

    // Coleta de dados do formulário (IDs mapeados com a tabela)
    const dados = {
        nome_completo: nome,
        cpf: document.getElementById('cpf').value,
        data_nascimento: document.getElementById('data_nascimento').value || null,
        email: email,
        telefone: document.getElementById('telefone').value,
        senha_acesso: senha, 
        acesso: document.getElementById('acesso').value,
        relacionamento: document.getElementById('relacionamento').value,
        status: document.getElementById('status').value,
        avaliacao: parseInt(document.getElementById('avaliacao').value),
        observacoes: document.getElementById('observacoes').value,
        cep: document.getElementById('cep').value,
        logradouro: document.getElementById('logradouro').value,
        numero: document.getElementById('numero').value,
        bairro: document.getElementById('bairro').value,
        cidade: document.getElementById('cidade').value,
        estado: document.getElementById('estado').value,
        arquivos_url: document.getElementById('arquivos_url').value ? [document.getElementById('arquivos_url').value] : []
    };

    if (id) {
        // MODO EDIÇÃO
        const { error } = await _supabase.from('usuarios').update(dados).eq('id', id);
        if (error) alert("Erro ao atualizar: " + error.message);
        else { alert("Atualizado com sucesso!"); resetForm(); loadEntities(); }
    } else {
        // MODO NOVO CADASTRO (Cria no Auth e o Trigger cria no Public)
        if (!senha) return alert("Defina uma senha para o primeiro acesso.");
        
        const { data: authData, error: authError } = await _supabase.auth.signUp({
            email: email,
            password: senha,
            options: { data: { nome_completo: nome } }
        });

        if (authError) {
            alert("Erro no cadastro: " + authError.message);
        } else {
            // O Trigger já criou a linha, agora fazemos o update com os dados extras (CPF, Endereço, etc)
            const { error: updateError } = await _supabase.from('usuarios').update(dados).eq('id', authData.user.id);
            if (updateError) console.error("Erro ao complementar perfil:", updateError.message);
            
            alert("Usuário cadastrado com sucesso!");
            resetForm();
            loadEntities();
        }
    }
}

async function deleteEntity(id) {
    if (confirm("Deseja excluir definitivamente este usuário do banco de dados?")) {
        const { error } = await _supabase.from('usuarios').delete().eq('id', id);
        if (error) alert("Erro ao excluir: " + error.message);
        else loadEntities();
    }
}

/**
 * 3. INTERFACE E UI
 */
function renderTable(data) {
    const list = document.getElementById('entities-list');
    list.innerHTML = data.map(c => {
        const wppLink = c.telefone ? `https://wa.me/${c.telefone.replace(/\D/g, '')}` : '#';
        const mailLink = c.email ? `mailto:${c.email}` : '#';

        return `
        <tr>
            <td><b>${c.nome_completo}</b><br><small>${c.relacionamento.toUpperCase()}</small></td>
            <td>${c.telefone || '---'}<br><small>${c.email || ''}</small></td>
            <td>${c.acesso}<br><small style="color:${c.status === 'ativo' ? 'green' : 'red'}">${c.status}</small></td>
            <td>
                <button class="btn-edit" title="Editar" onclick="editFull('${c.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn-del" title="Excluir" onclick="deleteEntity('${c.id}')"><i class="fas fa-trash"></i></button>
                <a href="${wppLink}" target="_blank" class="btn-wpp"><i class="fab fa-whatsapp"></i></a>
                <a href="${mailLink}" class="btn-mail"><i class="fas fa-envelope"></i></a>
            </td>
        </tr>`;
    }).join('') || '<tr><td colspan="4" style="text-align:center">Nenhum registro encontrado.</td></tr>';
}

function filtrarTabela() {
    const filtro = document.getElementById("inputBusca").value.toLowerCase();
    const dadosFiltrados = currentData.filter(u => 
        u.nome_completo.toLowerCase().includes(filtro) || 
        (u.cpf && u.cpf.includes(filtro)) ||
        (u.email && u.email.toLowerCase().includes(filtro))
    );
    renderTable(dadosFiltrados);
}

async function editFull(id) {
    const { data, error } = await _supabase.from('usuarios').select('*').eq('id', id).single();
    if (error || !data) return;

    // Preenchimento automático por ID de campo
    Object.keys(data).forEach(k => {
        const el = document.getElementById(k);
        if (el) el.value = (k === 'arquivos_url' && data[k]) ? data[k][0] : (data[k] || '');
    });

    document.getElementById('edit-id').value = data.id;
    document.getElementById('form-title').innerText = "Editando Usuário";
    document.getElementById('btn-save').innerText = "Atualizar Dados";
    document.getElementById('btn-cancel').style.display = "block";
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * 4. UTILITÁRIOS
 */
async function buscaCEP() {
    const cep = document.getElementById('cep').value.replace(/\D/g, '');
    if (cep.length === 8) {
        try {
            const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await res.json();
            if (!data.erro) {
                document.getElementById('logradouro').value = data.logradouro;
                document.getElementById('bairro').value = data.bairro;
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('estado').value = data.uf;
            }
        } catch (e) { console.error("Erro ao buscar CEP"); }
    }
}

function togglePasswordVisibility() {
    const pass = document.getElementById('senha_acesso');
    const icon = document.getElementById('togglePassword');
    const isPass = pass.type === 'password';
    pass.type = isPass ? 'text' : 'password';
    icon.classList.toggle('fa-eye');
    icon.classList.toggle('fa-eye-slash');
}

function resetForm() {
    document.querySelectorAll('input, select, textarea').forEach(i => {
        if(i.id === 'avaliacao') i.value = '5';
        else if(i.tagName === 'SELECT') i.selectedIndex = 0;
        else i.value = '';
    });
    document.getElementById('edit-id').value = '';
    document.getElementById('form-title').innerText = "Novo Cadastro de Entidade";
    document.getElementById('btn-save').innerText = "Salvar Entidade";
    document.getElementById('btn-cancel').style.display = "none";
}

async function sairDaConta() {
    if(confirm("Deseja encerrar a sessão?")) {
        await _supabase.auth.signOut();
        window.location.href = 'login.html';
    }
}

// Inicialização Geral
document.addEventListener('DOMContentLoaded', () => {
    validarAcesso();
    renderNavbar();
    loadEntities();
});
</script>
</body>
</html>
