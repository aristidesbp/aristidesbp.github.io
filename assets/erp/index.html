<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vitrine & PDV - ERP ABP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #3ecf8e; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding-bottom: 120px; }
        .header-pdv { position: fixed; top: 0; width: 100%; background: white; z-index: 100; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .grid-produtos { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 140px 15px 20px; }
        .card-prod { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .prod-img { width: 100%; height: 120px; object-fit: cover; background: #eee; }
        .btn-add { width: 100%; background: var(--primary); color: white; padding: 10px; border: none; font-weight: bold; cursor: pointer; }
        .footer-checkout { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; border-top: 2px solid var(--primary); display: flex; justify-content: space-between; align-items: center; z-index: 101; }
        #reader { width: 100%; display: none; margin-top: 10px; }
    </style>
    <style>
   :root { --primary: #3ecf8e; --accent: #6366f1; --dark: #0f172a; --bg: #f8fafc; }

body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding-top: 130px; padding-bottom: 100px; }

.header-fixo { position: fixed; top: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 1000; }

.search-bar-container { display: flex; gap: 10px; margin-bottom: 12px; }

#busca-vitrine { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 16px; outline: none; }

.btn-scan-pdv { background: var(--accent); color: white; border: none; width: 50px; border-radius: 12px; cursor: pointer; }

#reader-pdv { width: 100%; border-radius: 12px; margin-top: 10px; display: none; overflow: hidden; }

.categorias-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
.cat-chip { padding: 8px 18px; border-radius: 20px; background: #edf2f7; border: none; white-space: nowrap; font-weight: 600; color: #4a5568; }
.cat-chip.active { background: var(--primary); color: white; }

/* Grid de Produtos */
.grid-produtos { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 15px; }

.card-produto { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: 0.2s; position: relative; }

.img-vitrine { width: 100%; height: 140px; object-fit: cover; background: #f1f5f9; }

.info-prod { padding: 12px; }
.info-prod h4 { margin: 0; font-size: 14px; color: var(--dark); }
.info-prod .preco { color: var(--primary); font-weight: 800; font-size: 16px; margin: 5px 0; }

.btn-add-vitrine { width: 100%; padding: 10px; border: none; background: #f1f5f9; color: var(--dark); font-weight: bold; border-radius: 10px; cursor: pointer; }
.btn-add-vitrine:active { transform: scale(0.95); }

/* Rodapé Checkout */
.checkout-footer { position: fixed; bottom: 0; width: 100%; background: white; border-top: 2px solid #edf2f7; z-index: 1001; }
.resumo-carrinho { display: flex; justify-content: space-between; align-items: center; padding: 20px; cursor: pointer; }
.btn-finalizar { width: calc(100% - 40px); margin: 0 20px 20px; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 800; }
.detalhes-ocultos { display: none; max-height: 300px; overflow-y: auto; padding: 0 20px; }
        
        </style>
</head>
<body>

<header class="header-pdv">
    <div class="flex gap-2">
        <input type="text" id="busca" class="w-full p-3 border rounded-lg" placeholder="Buscar produto ou ler código..." onkeyup="filtrar()">
        <button onclick="toggleScanner()" class="bg-indigo-500 text-white p-3 rounded-lg"><i class="fas fa-barcode"></i></button>
    </div>
    <div id="reader"></div>
    <select id="filtro-categoria" class="w-full mt-2 p-2 border rounded-lg" onchange="filtrar()">
        <option value="">Todas as Categorias</option>
    </select>
</header>

<div id="lista-produtos" class="grid-produtos">
    </div>

<footer class="footer-checkout">
    <div>
        <span class="block text-sm text-gray-500" id="total-itens">0 itens</span>
        <b class="text-xl" id="valor-total">R$ 0,00</b>
    </div>
    <button onclick="finalizarVenda()" class="bg-green-500 text-white px-6 py-3 rounded-xl font-bold">Finalizar Venda</button>
</footer>

<script>
const supabaseUrl = 'https://eisruaetsqrratemqswv.supabase.co';
const supabaseKey = 'SUA_CHAVE_AQUI'; // Use a chave do seu produtos.html
const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

let produtos = [];
let carrinho = [];
let scanner;

async function inicializar() {
    const { data, error } = await _supabase.from('produtos').select('*');
    if (error) return console.error("Erro ao carregar:", error);
    
    produtos = data;
    renderizar(produtos);
    popularCategorias(data);
}

function popularCategorias(data) {
    const categorias = [...new Set(data.map(p => p.categoria_prod).filter(c => c))];
    const select = document.getElementById('filtro-categoria');
    categorias.forEach(cat => {
        select.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
}

function renderizar(lista) {
    const container = document.getElementById('lista-produtos');
    container.innerHTML = lista.map(p => `
        <div class="card-prod">
            <img src="${p.imagem_url || ''}" class="prod-img">
            <div class="p-3">
                <h4 class="font-bold text-sm truncate">${p.nome}</h4>
                <p class="text-green-600 font-bold">R$ ${parseFloat(p.preco_venda).toFixed(2)}</p>
                <p class="text-xs text-gray-400">Estoque: ${p.estoque_atual}</p>
            </div>
            <button class="btn-add" onclick="adicionar('${p.id}')">ADICIONAR</button>
        </div>
    `).join('');
}

function adicionar(id) {
    const p = produtos.find(item => item.id === id);
    carrinho.push(p);
    atualizarCarrinho();
}

function atualizarCarrinho() {
    const total = carrinho.reduce((acc, p) => acc + parseFloat(p.preco_venda), 0);
    document.getElementById('total-itens').innerText = `${carrinho.length} itens`;
    document.getElementById('valor-total').innerText = `R$ ${total.toFixed(2)}`;
}

async function finalizarVenda() {
    if (carrinho.length === 0) return alert("Carrinho vazio!");

    const totalVenda = carrinho.reduce((acc, p) => acc + parseFloat(p.preco_venda), 0);

    // 1. Registrar no Financeiro
    const { error: errFin } = await _supabase.from('financeiro').insert([{
        tipo: 'receber',
        descricao: `Venda PDV - ${carrinho.length} itens`,
        valor: totalVenda,
        status: 'pago',
        data_pagamento: new Date().toISOString().split('T')[0]
    }]);

    // 2. Baixar Estoque
    for (const item of carrinho) {
        await _supabase.from('produtos')
            .update({ estoque_atual: item.estoque_atual - 1 })
            .eq('id', item.id);
    }

    if (!errFin) {
        alert("Venda Finalizada com Sucesso!");
        carrinho = [];
        atualizarCarrinho();
        inicializar(); // Recarrega para atualizar números de estoque na tela
    }
}

// Lógica de Busca e Scanner
function filtrar() {
    const termo = document.getElementById('busca').value.toLowerCase();
    const cat = document.getElementById('filtro-categoria').value;
    const filtrados = produtos.filter(p => 
        (p.nome.toLowerCase().includes(termo) || (p.codigo_de_barras && p.codigo_de_barras.includes(termo))) &&
        (cat === "" || p.categoria_prod === cat)
    );
    renderizar(filtrados);
}

function toggleScanner() {
    const div = document.getElementById('reader');
    if (div.style.display === 'block') {
        scanner.stop();
        div.style.display = 'none';
    } else {
        div.style.display = 'block';
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
            const p = produtos.find(prod => prod.codigo_de_barras === text);
            if (p) {
                adicionar(p.id);
                alert("Adicionado: " + p.nome);
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', inicializar);
    

    
</script>
</body>
</html>
