<!DOCTYPE html>
<html class="light" lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>PDV Móvel - ERP ABP</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#3ecf8e", "background-light": "#f6f7f8", "background-dark": "#101922" },
                    fontFamily: { "display": ["Inter"] }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://eisruaetsqrratemqswv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpc3J1YWV0c3FycmF0ZW1xc3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MDI4OTAsImV4cCI6MjA4NTM3ODg5MH0.Rb-nu9zBL7TNWoGNYHvETWMfbqO1NF7UID4TdSYyKS4';
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey);
        window.supabaseClient = _supabase;

        async function checarAutenticacao() {
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) window.location.href = "login.html";
        }
        checarAutenticacao();
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white antialiased">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden max-w-[480px] mx-auto shadow-2xl bg-white dark:bg-background-dark">
        
        <header class="sticky top-0 z-30 bg-white dark:bg-background-dark/95 backdrop-blur-md border-b border-gray-100 dark:border-gray-800">
            <div class="flex items-center p-4 pb-2 justify-between">
                <div class="text-primary flex size-10 shrink-0 items-center justify-center rounded-lg bg-primary/10">
                    <span class="material-symbols-outlined">storefront</span>
                </div>
                <h2 class="text-lg font-bold flex-1 ml-3">PDV Móvel</h2>
                <a href="index.html" class="p-2 text-gray-500"><span class="material-symbols-outlined">home</span></a>
            </div>

            <div class="px-4 py-3 flex gap-2 relative">
                <div class="flex flex-1 items-stretch rounded-xl overflow-hidden bg-[#f0f2f4] dark:bg-gray-800">
                    <div class="text-[#617589] flex items-center justify-center pl-4">
                        <span class="material-symbols-outlined text-[20px]">search</span>
                    </div>
                    <input id="inputBusca" onkeyup="buscarProdutos(this.value)" class="form-input flex-1 border-none bg-transparent focus:ring-0 text-base py-3" placeholder="Buscar produto..."/>
                </div>
                <div id="resultadosBusca" class="absolute top-16 left-4 right-4 bg-white dark:bg-gray-800 shadow-xl rounded-xl z-50 hidden max-h-60 overflow-y-auto border dark:border-gray-700"></div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto pb-44">
            <div class="p-4 border-b border-gray-50 dark:border-gray-800">
                <h3 class="text-sm font-semibold text-[#617589] uppercase tracking-wider">Carrinho</h3>
            </div>
            
            <div id="carrinho-lista">
                <div class="p-8 text-center text-gray-400">Carrinho vazio</div>
            </div>
        </main>

        <footer class="fixed bottom-0 w-full max-w-[480px] bg-white dark:bg-background-dark border-t border-gray-100 dark:border-gray-800 px-4 pt-4 pb-8 z-40">
            <div class="flex flex-col gap-3">
                <div class="flex justify-between text-sm text-[#617589]">
                    <span>Subtotal</span>
                    <span id="resumo-subtotal">R$ 0,00</span>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="text-lg font-bold">Total</span>
                    <span id="resumo-total" class="text-2xl font-extrabold tracking-tight text-primary">R$ 0,00</span>
                </div>
                <button onclick="finalizarVenda()" class="w-full flex items-center justify-center gap-2 rounded-xl h-14 bg-primary text-white text-base font-bold shadow-lg active:scale-95 transition-all">
                    <span class="material-symbols-outlined">shopping_cart_checkout</span>
                    Finalizar Venda
                </button>
            </div>
        </footer>
    </div>

<script>
    let carrinho = [];

    async function buscarProdutos(termo) {
        const listaResultados = document.getElementById('resultadosBusca');
        if (termo.length < 2) {
            listaResultados.classList.add('hidden');
            return;
        }

        const { data, error } = await window.supabaseClient
            .from('produtos')
            .select('*')
            .ilike('nome', `%${termo}%`)
            .limit(5);

        if (data && data.length > 0) {
            listaResultados.innerHTML = data.map(p => `
                <div onclick="adicionarAoCarrinho('${p.id}', '${p.nome}', ${p.preco_venda})" class="p-4 border-b dark:border-gray-700 flex justify-between items-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                    <div>
                        <p class="font-bold text-sm">${p.nome}</p>
                        <p class="text-xs text-primary">R$ ${p.preco_venda.toFixed(2)}</p>
                    </div>
                    <span class="material-symbols-outlined text-primary">add_circle</span>
                </div>
            `).join('');
            listaResultados.classList.remove('hidden');
        }
    }

    function adicionarAoCarrinho(id, nome, preco) {
        const itemExistente = carrinho.find(i => i.id === id);
        if (itemExistente) {
            itemExistente.qtd++;
        } else {
            carrinho.push({ id, nome, preco, qtd: 1 });
        }
        document.getElementById('resultadosBusca').classList.add('hidden');
        document.getElementById('inputBusca').value = '';
        renderizarCarrinho();
    }

    function alterarQtd(id, delta) {
        const item = carrinho.find(i => i.id === id);
        if (item) {
            item.qtd += delta;
            if (item.qtd <= 0) {
                carrinho = carrinho.filter(i => i.id !== id);
            }
        }
        renderizarCarrinho();
    }

    function renderizarCarrinho() {
        const lista = document.getElementById('carrinho-lista');
        let total = 0;

        if (carrinho.length === 0) {
            lista.innerHTML = '<div class="p-8 text-center text-gray-400">Carrinho vazio</div>';
        } else {
            lista.innerHTML = carrinho.map(item => {
                total += item.preco * item.qtd;
                return `
                <div class="flex items-center gap-4 px-4 py-4 border-b dark:border-gray-800/50 justify-between">
                    <div class="flex-1">
                        <p class="text-base font-semibold leading-tight">${item.nome}</p>
                        <p class="text-primary font-bold mt-1">R$ ${item.preco.toFixed(2)}</p>
                    </div>
                    <div class="flex items-center gap-3 bg-[#f0f2f4] dark:bg-gray-800 p-1 rounded-full">
                        <button onclick="alterarQtd('${item.id}', -1)" class="h-8 w-8 rounded-full bg-white dark:bg-gray-700 shadow-sm font-bold text-lg">-</button>
                        <span class="font-bold w-4 text-center">${item.qtd}</span>
                        <button onclick="alterarQtd('${item.id}', 1)" class="h-8 w-8 rounded-full bg-white dark:bg-gray-700 shadow-sm font-bold text-lg">+</button>
                    </div>
                </div>`;
            }).join('');
        }

        document.getElementById('resumo-subtotal').innerText = `R$ ${total.toFixed(2)}`;
        document.getElementById('resumo-total').innerText = `R$ ${total.toFixed(2)}`;
    }

    async function finalizarVenda() {
        if (carrinho.length === 0) return alert("Adicione itens ao carrinho!");

        const total = carrinho.reduce((acc, i) => acc + (i.preco * i.qtd), 0);

        try {
            // 1. Criar Venda
            const { data: venda, error: vError } = await window.supabaseClient
                .from('vendas')
                .insert([{ valor_total: total, metodo_pagamento: 'Dinheiro' }])
                .select()
                .single();

            if (vError) throw vError;

            // 2. Criar Itens da Venda
            const itensPayload = carrinho.map(i => ({
                venda_id: venda.id,
                produto_id: i.id,
                quantidade: i.qtd,
                preco_unitario: i.preco,
                subtotal_item: i.preco * i.qtd
            }));

            const { error: iError } = await window.supabaseClient.from('venda_itens').insert(itensPayload);
            if (iError) throw iError;

            alert("Venda realizada com sucesso!");
            carrinho = [];
            renderizarCarrinho();

        } catch (err) {
            alert("Erro ao finalizar: " + err.message);
        }
    }
</script>
</body>
</html>
