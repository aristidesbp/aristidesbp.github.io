<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entidades - ERP ABP</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="app" style="display: block;"> <nav class="navbar">
            <a href="index.html" class="btn-back"><i class="fas fa-arrow-left"></i></a>
            <div class="brand">Clientes & Fornecedores</div>
            <button id="btn-novo" class="btn-add"><i class="fas fa-plus"></i></button>
        </nav>

        <main class="content">
            <div id="debug-status" style="font-size: 10px; color: #3ecf8e; margin-bottom: 10px;">Verificando conexão...</div>
            
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="input-busca" placeholder="Buscar...">
            </div>

            <div id="lista-entidades" class="list-container">
                <div class="loading">Iniciando busca no banco...</div>
            </div>
        </main>

        <div id="modal-entidade" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Nova Entidade</h2>
                    <button class="btn-close" onclick="fecharModal()">&times;</button>
                </div>
                <form id="form-entidade">
                    <input type="text" id="nome" placeholder="Nome" required style="width:100%; padding:10px; margin-bottom:10px; background:#0f172a; border:1px solid #334155; color:white;">
                    <button type="submit" class="btn-save">SALVAR</button>
                </form>
            </div>
        </div>
    </div>

<script>
(function() {
    const CONFIG = {
        URL: "https://ueaprmzmlkfrbmibdnro.supabase.co",
        KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlYXBybXptbGtmcmJtaWJkbnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTg3OTQsImV4cCI6MjA4NDkzNDc5NH0.Nl_W2v3JN_uQLfz4eAqV3goDVFernnGi2A7L9kszX3w"
    };

    const supabaseClient = supabase.createClient(CONFIG.URL, CONFIG.KEY);
    let empresaId = null;

    // Estilo Compacto
    const style = document.createElement('style');
    style.innerHTML = `
        :root { --primary: #3ecf8e; --dark: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { margin: 0; font-family: sans-serif; background: var(--dark); color: var(--text); padding: 0; }
        .navbar { display: flex; align-items: center; padding: 15px; background: var(--card); border-bottom: 1px solid #334155; }
        .btn-back { color: white; margin-right: 15px; text-decoration: none; }
        .brand { flex-grow: 1; font-weight: bold; }
        .btn-add { background: var(--primary); border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; }
        .content { padding: 15px; }
        .search-bar { background: var(--card); padding: 10px; border-radius: 8px; display: flex; gap: 10px; border: 1px solid #334155; margin-bottom: 15px; }
        .search-bar input { background: transparent; border: none; color: white; width: 100%; outline: none; }
        .entidade-card { background: var(--card); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; }
        .modal-content { background:var(--card); width:80%; margin:20% auto; padding:20px; border-radius:10px; }
        .btn-save { background:var(--primary); border:none; padding:10px; width:100%; font-weight:bold; border-radius:5px; }
    `;
    document.head.appendChild(style);

    const log = (m) => document.getElementById('debug-status').innerText = m;

    async function carregar() {
        log("Checando sessão...");
        const { data: { session } } = await supabaseClient.auth.getSession();
        
        if (!session) {
            log("Sessão não encontrada. Redirecionando...");
            window.location.href = "login.html";
            return;
        }

        log("Buscando sua empresa...");
        // Tentamos buscar o ID da empresa vinculado ao seu usuário
        const { data: vinculo, error: errV } = await supabaseClient
            .from('usuario_empresas')
            .select('empresa_id')
            .eq('usuario_id', session.user.id)
            .single();

        if (errV || !vinculo) {
            document.getElementById('lista-entidades').innerHTML = `<div style="color:#ef4444">Erro: Vínculo de empresa não encontrado. Execute o SQL de correção.</div>`;
            log("Erro no vínculo.");
            return;
        }

        empresaId = vinculo.empresa_id;
        log("Conectado na Empresa: " + empresaId);

        log("Carregando lista...");
        const { data, error } = await supabaseClient
            .from('clientes')
            .select('*')
            .eq('empresa_id', empresaId);

        if (error) {
            document.getElementById('lista-entidades').innerHTML = `<div style="color:#ef4444">Erro de Política (RLS): ${error.message}</div>`;
            return;
        }

        if (data.length === 0) {
            document.getElementById('lista-entidades').innerHTML = `<div style="text-align:center; margin-top:20px; color:#64748b;">Nenhum cliente cadastrado ainda. <br> Clique no + para começar.</div>`;
        } else {
            document.getElementById('lista-entidades').innerHTML = data.map(i => `
                <div class="entidade-card">
                    <div style="font-weight:bold; color:var(--primary)">${i.nome}</div>
                    <div style="font-size:11px; color:#94a3b8;">${i.cpf_cnpj || 'Sem documento'}</div>
                </div>
            `).join('');
        }
    }

    // Modal
    window.fecharModal = () => document.getElementById('modal-entidade').style.display = 'none';
    document.getElementById('btn-novo').onclick = () => document.getElementById('modal-entidade').style.display = 'block';

    document.getElementById('form-entidade').onsubmit = async (e) => {
        e.preventDefault();
        const nome = document.getElementById('nome').value;
        log("Salvando...");
        
        const { error } = await supabaseClient.from('clientes').insert([{
            nome: nome,
            empresa_id: empresaId,
            ativo: true
        }]);

        if (error) alert("Erro: " + error.message);
        else {
            fecharModal();
            carregar();
        }
    };

    carregar();
})();
</script>
</body>
</html>
