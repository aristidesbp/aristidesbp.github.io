<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Financeira - ERP ABP</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="conexao_supabase.js"></script>
    
    <style>
        :root { --primary: #3ecf8e; --dark: #0f172a; --bg: #f1f5f9; --danger: #ef4444; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); }

        .container { max-width: 1200px; margin: auto; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* Dashboard de Saldos */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { padding: 20px; border-radius: 12px; color: white; display: flex; flex-direction: column; }
        .stat-card.receber { background: #10b981; }
        .stat-card.pagar { background: #ef4444; }
        .stat-card.saldo { background: #3b82f6; }
        .stat-value { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 11px; border: 1px solid #e2e8f0; border-radius: 8px; }

        .btn-add { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 15px; font-weight: bold; }
        .btn-cancel { background: #94a3b8; color: white; padding: 10px; border: none; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; }

        .table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; padding: 15px; font-size: 12px; text-align: left; color: #475569; }
        td { padding: 12px 15px; border-top: 1px solid #f1f5f9; font-size: 14px; }

        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .status-pago { background: #dcfce7; color: #166534; }
        .status-pendente { background: #fef9c3; color: #854d0e; }
        
        .bulk-actions { background: #334155; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="stats-grid">
        <div class="stat-card receber">
            <span>A Receber</span>
            <div class="stat-value" id="total-receber">R$ 0,00</div>
        </div>
        <div class="stat-card pagar">
            <span>A Pagar</span>
            <div class="stat-value" id="total-pagar">R$ 0,00</div>
        </div>
        <div class="stat-card saldo">
            <span>Saldo Previsto</span>
            <div class="stat-value" id="total-saldo">R$ 0,00</div>
        </div>
    </div>

    <div class="card">
        <h3 id="form-title">Lançamento Financeiro</h3>
        <input type="hidden" id="edit-id">
        <div class="form-grid">
            <div><label>Descrição *</label><input type="text" id="descricao" placeholder="Ex: Venda de Piso"></div>
            <div>
                <label>Tipo *</label>
                <select id="tipo">
                    <option value="receita">Receita (+)</option>
                    <option value="despesa">Despesa (-)</option>
                </select>
            </div>
            <div><label>Valor (R$) *</label><input type="number" id="valor" step="0.01"></div>
            <div><label>Vencimento</label><input type="date" id="data_vencimento"></div>
            <div>
                <label>Entidade (Cliente/Fornecedor)</label>
                <select id="entidade_id"><option value="">Carregando...</option></select>
            </div>
            <div>
                <label>Status</label>
                <select id="status">
                    <option value="pendente">Pendente</option>
                    <option value="pago">Pago / Recebido</option>
                </select>
            </div>
            <div style="grid-column: span 2;"><label>Observações</label><textarea id="observacoes" rows="1"></textarea></div>
        </div>
        <button class="btn-add" onclick="handleSaveFinanceiro()">Salvar Lançamento</button>
        <button id="btn-cancel" class="btn-cancel" onclick="resetForm()" style="display:none;">Cancelar Edição</button>
    </div>

    <div id="bulk-area" class="bulk-actions">
        <span id="selected-count">0 selecionados</span>
        <button onclick="deleteSelected()" style="background:red; color:white; border:none; padding:5px 10px; border-radius:4px; margin-left:15px; cursor:pointer;">
            Excluir Selecionados
        </button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th width="30"><input type="checkbox" id="select-all" onclick="toggleAll()"></th>
                    <th>Vencimento</th>
                    <th>Descrição / Entidade</th>
                    <th>Valor</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="financeiro-list"></tbody>
        </table>
    </div>
</div>

<script>
    let dadosFinanceiros = [];

    async function inicializar() {
        if (!window._supabase) {
            setTimeout(inicializar, 500);
            return;
        }
        await loadEntidadesSelect();
        await loadFinanceiro();
    }

    async function loadEntidadesSelect() {
        const { data } = await window._supabase.from('entidades').select('id, nome_completo').order('nome_completo');
        if(data) {
            document.getElementById('entidade_id').innerHTML = '<option value="">Selecione...</option>' + 
                data.map(e => `<option value="${e.id}">${e.nome_completo}</option>`).join('');
        }
    }

    async function loadFinanceiro() {
        const { data, error } = await window._supabase
            .from('financeiro')
            .select('*, entidades(nome_completo)')
            .order('data_vencimento', { ascending: true });

        if (!error) {
            dadosFinanceiros = data || [];
            renderFinanceiro(dadosFinanceiros);
            calcularResumo(dadosFinanceiros);
        }
    }

    function calcularResumo(dados) {
        let rec = 0, pag = 0;
        dados.forEach(d => {
            if (d.tipo === 'receita') rec += d.valor;
            else pag += d.valor;
        });
        document.getElementById('total-receber').innerText = `R$ ${rec.toLocaleString('pt-BR', {minFractionDigits:2})}`;
        document.getElementById('total-pagar').innerText = `R$ ${pag.toLocaleString('pt-BR', {minFractionDigits:2})}`;
        document.getElementById('total-saldo').innerText = `R$ ${(rec - pag).toLocaleString('pt-BR', {minFractionDigits:2})}`;
    }

    function renderFinanceiro(dados) {
        const list = document.getElementById('financeiro-list');
        list.innerHTML = dados.map(d => `
            <tr>
                <td><input type="checkbox" class="row-checkbox" value="${d.id}" onclick="updateBulkUI()"></td>
                <td>${d.data_vencimento ? new Date(d.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                <td><b>${d.descricao}</b><br><small>${d.entidades?.nome_completo || 'Geral'}</small></td>
                <td style="color: ${d.tipo === 'receita' ? '#10b981' : '#ef4444'}; font-weight:bold">
                    ${d.tipo === 'receita' ? '+' : '-'} R$ ${d.valor.toLocaleString('pt-BR', {minFractionDigits:2})}
                </td>
                <td><span class="status-badge ${d.status === 'pago' ? 'status-pago' : 'status-pendente'}">${d.status}</span></td>
                <td>
                    <button class="btn-edit" style="border:none; background:none; color:#3b82f6; cursor:pointer;" onclick="editFinanceiro('${d.id}')"><i class="fas fa-edit"></i></button>
                    <button style="border:none; background:none; color:red; cursor:pointer;" onclick="deleteFinanceiro('${d.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('') || '<tr><td colspan="6" style="text-align:center">Sem lançamentos.</td></tr>';
    }

    window.handleSaveFinanceiro = async function() {
        const { data: { user } } = await window._supabase.auth.getUser();
        const id = document.getElementById('edit-id').value;
        const dados = {
            usuario_id: user.id,
            descricao: document.getElementById('descricao').value,
            tipo: document.getElementById('tipo').value,
            valor: parseFloat(document.getElementById('valor').value),
            data_vencimento: document.getElementById('data_vencimento').value || null,
            entidade_id: document.getElementById('entidade_id').value || null,
            status: document.getElementById('status').value,
            observacoes: document.getElementById('observacoes').value
        };

        if(!dados.descricao || !dados.valor) return alert("Preencha descrição e valor!");

        const { error } = id ? 
            await window._supabase.from('financeiro').update(dados).eq('id', id) : 
            await window._supabase.from('financeiro').insert([dados]);

        if(!error) { resetForm(); loadFinanceiro(); } else { alert(error.message); }
    };

    window.editFinanceiro = function(id) {
        const d = dadosFinanceiros.find(i => i.id === id);
        if(!d) return;
        document.getElementById('edit-id').value = d.id;
        document.getElementById('descricao').value = d.descricao;
        document.getElementById('tipo').value = d.tipo;
        document.getElementById('valor').value = d.valor;
        document.getElementById('data_vencimento').value = d.data_vencimento;
        document.getElementById('entidade_id').value = d.entidade_id || '';
        document.getElementById('status').value = d.status;
        document.getElementById('observacoes').value = d.observacoes || '';
        
        document.getElementById('form-title').innerText = "Editando Lançamento";
        document.getElementById('btn-cancel').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.resetForm = function() {
        document.getElementById('edit-id').value = '';
        document.querySelectorAll('input, select, textarea').forEach(i => i.value = '');
        document.getElementById('form-title').innerText = "Lançamento Financeiro";
        document.getElementById('btn-cancel').style.display = 'none';
    };

    window.deleteFinanceiro = async function(id) {
        if(confirm("Excluir lançamento?")) {
            await window._supabase.from('financeiro').delete().eq('id', id);
            loadFinanceiro();
        }
    };

    // Lógica Bulk (Massa)
    window.toggleAll = function() {
        const isChecked = document.getElementById('select-all').checked;
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked);
        updateBulkUI();
    };

    window.updateBulkUI = function() {
        const selected = document.querySelectorAll('.row-checkbox:checked').length;
        document.getElementById('bulk-area').style.display = selected > 0 ? 'block' : 'none';
        document.getElementById('selected-count').innerText = `${selected} selecionado(s)`;
    };

    window.deleteSelected = async function() {
        if(!confirm("Excluir selecionados?")) return;
        const ids = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
        await window._supabase.from('financeiro').delete().in('id', ids);
        loadFinanceiro();
        updateBulkUI();
    };

    document.addEventListener('DOMContentLoaded', inicializar);
</script>
</body>
</html>
