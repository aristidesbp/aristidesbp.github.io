<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entidades - ERP ABP Profissional</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="conexao.js"></script>
    <style>
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-form { display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #2c3e50; color: white; }
        .btn-add { background: #27ae60; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; }
        .btn-del { background: #c0392b; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Gestão de Entidades (Clientes/Fornecedores)</h2>

        <div class="card">
            <form id="entidade-form" class="grid-form">
                <div style="display: flex; flex-direction: column;">
                    <label>Nome / Razão Social</label>
                    <input type="text" id="nome" placeholder="Ex: João Silva ou Empresa LTDA" required>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label>CPF/CNPJ</label>
                    <input type="text" id="documento" placeholder="00.000.000/0000-00" oninput="mascaraDocumento(this)">
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label>Tipo</label>
                    <select id="tipo">
                        <option value="cliente">Cliente</option>
                        <option value="fornecedor">Fornecedor</option>
                        <option value="ambos">Ambos</option>
                    </select>
                </div>
                <button type="submit" class="btn-add">Salvar</button>
            </form>
        </div>

        <div class="card" style="padding: 0;">
            <table id="tabela-entidades">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Documento</th>
                        <th>Tipo</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
    (function() {
        // --- UTILITÁRIOS DE SEGURANÇA E MÁSCARA ---
        
        // Máscara dinâmica para CPF/CNPJ
        window.mascaraDocumento = (i) => {
            let v = i.value.replace(/\D/g, "");
            if (v.length <= 11) { // CPF
                v = v.replace(/(\={3})(\={3})(\={3})(\={2})/g, "$1.$2.$3-$4");
                i.value = v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            } else { // CNPJ
                i.value = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
            }
        };

        // Sanitização básica contra Injeção de Código (XSS)
        const limparTexto = (str) => {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };

        // --- LÓGICA DO CRUD ---

        const carregarEntidades = async () => {
            const { data, error } = await db
                .from('entidades')
                .select('*')
                .order('nome_razao', { ascending: true });

            if (error) return alert("Erro ao carregar: " + error.message);

            const tbody = document.querySelector('#tabela-entidades tbody');
            tbody.innerHTML = data.map(ent => `
                <tr>
                    <td>${limparTexto(ent.nome_razao)}</td>
                    <td>${ent.documento || '---'}</td>
                    <td><span style="text-transform: capitalize">${ent.tipo}</span></td>
                    <td>
                        <button class="btn-del" onclick="deletarEntidade(${ent.id})">Excluir</button>
                    </td>
                </tr>
            `).join('');
        };

        document.getElementById('entidade-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const { data: { user } } = await db.auth.getUser();
            
            const payload = {
                user_id: user.id, // Vincula ao usuário logado (Segurança RLS)
                nome_razao: document.getElementById('nome').value.trim(),
                documento: document.getElementById('documento').value.replace(/\D/g, ""), // Salva apenas números
                tipo: document.getElementById('tipo').value
            };

            const { error } = await db.from('entidades').insert([payload]);

            if (error) {
                alert("Erro ao salvar: " + error.message);
            } else {
                document.getElementById('entidade-form').reset();
                carregarEntidades();
            }
        });

        window.deletarEntidade = async (id) => {
            if (!confirm("Deseja realmente excluir esta entidade?")) return;
            
            const { error } = await db.from('entidades').delete().eq('id', id);
            if (error) alert(error.message);
            else carregarEntidades();
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', carregarEntidades);
    })();
    </script>
</body>
</html>
