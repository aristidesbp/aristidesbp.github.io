ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
# 01
# CRIANDO BANCO DE DADOS NO SUPABASE
https://supabase.com
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
# CRIAR TABELA entidades
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
```
create table public.entidades (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  user_id uuid null,
  nome_completo text null,
  bio text null,
  avatar_url text null,
  senha_user text null,
  telefone text null,
  endereco text null,
  data_nascimento text null,
  cpf_cnpj text null,
  insc_estadual text null,
  status text null,
  relacionamento text null,
  email text null,
  nivel_acesso text null,
  cep text null,
  bairro text null,
  cidade text null,
  prontuario text null,
  uf text null,
  insc_municipal text null,
  constraint usuario_pkey primary key (id),
  constraint usuario_user_id_fkey foreign KEY (user_id) references auth.users (id)
) TABLESPACE pg_default;
```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
## FUNCTION TRIGGER
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
``` 
crie uma funÃ§Ã£o trigger para ser implementada no Supabase com o seguinte objetivo:
A cada novo usuario que for criado no schema auth, deve ser criado o mesmo usuario no schema public na tabela abaixo.

(entre na tabela/ cantoinferio direto/ definitions (codigo da tabela criada acima))
```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
## FUNCTION TRIGGER
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
``` 
-- 1. Criar a funÃ§Ã£o que serÃ¡ executada pelo gatilho
create or replace function public.handle_new_user()
returns trigger as $$
begin
  insert into public.entidades (
    user_id,
    email,
    nome_completo,
    status,
    relacionamento -- Definido como 'UsuÃ¡rio' ou 'Colaborador' por padrÃ£o
  )
  values (
    new.id,
    new.email,
    new.raw_user_meta_data->>'full_name', -- Tenta pegar o nome se vier do metadata (ex: Google Auth)
    'Ativo',
    'UsuÃ¡rio'
  );
  return new;
end;
$$ language plpgsql security definer;

-- 2. Criar o gatilho na tabela auth.users
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
# CRIAR APOLICE 
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
```
-- Cria a polÃ­tica que permite ao usuÃ¡rio gerenciar apenas os seus fornecedores
CREATE POLICY "Acesso total aos prÃ³prios fornecedores" 
ON public.fornecedores 
FOR ALL 
USING (auth.uid() = usuario_id);
```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
# CRIANDO UMA VISUALIZAÃ‡ÃƒO COM VIEWS
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
## PROMPT PARA CRIAR VIEWS:
```
Crie uma view chamada "v_sevicos_destaque" que liste os serviÃ§os com o nome
da categoria e detalhes do autor que esta na tabela de usuarios. Alem disso, 
caucule a media das notas (use ) se nao houver) e o total de avaliÃ§oes recebidas por cada serviÃ§o.
Conforme o schema do banco de dados que vou te passar abaixo:

Obs: Ja acrescente with (security_invoker) logo depois do nome da view, para criar uma seguranÃ§a.

[cole aqui o schema fica em: menu lateral/ Database/ no canto superior direi opÃ§Ã£o Copy as SQL]
```







ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
# conexao.js
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
```
/** ############################################################################## */
/** ERP ABP - GUARD GLOBAL (VersÃ£o Final Corrigida - Responsiva)
 * SeguranÃ§a + SDK Auto-load + Navbar + Controle de SessÃ£o */

(async () => {
    "use strict";

    if (window.__ERP_GUARD_LOADED__) return;
    window.__ERP_GUARD_LOADED__ = true;

    const CONFIG = Object.freeze({
        SUPABASE_URL: 'https://kjhjeaiwjilkgocwvbwi.supabase.co',
        SUPABASE_KEY: 'sb_publishable_WP3TF2GTMMWCS1tCYzQSjA_syIKLyIX',
        LOGIN_PAGE: "login.html",
        HOME_PAGE: "index.html",
        HUB_PAGE: "https://aristidesbp.github.io/",
        APP_NAME: "ERP ABP",
        SDK_URL: "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
    });

    async function carregarSDK() {
        if (window.supabase) return true;
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = CONFIG.SDK_URL;
            script.onload = () => resolve(true);
            script.onerror = () => reject(new Error("Falha ao carregar SDK do Supabase"));
            document.head.appendChild(script);
        });
    }

    try {
        await carregarSDK();
        if (!window._supabase) {
            window._supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        }

        async function validarSessao() {
            try {
                const { data, error } = await _supabase.auth.getSession();
                if (error || !data || !data.session) throw new Error();
                return data.session;
            } catch (e) {
                window.location.replace(CONFIG.LOGIN_PAGE);
                return null;
            }
        }

        async function logout() {
            if (!confirm("Deseja realmente sair do sistema?")) return;
            try { await _supabase.auth.signOut(); } finally { window.location.replace(CONFIG.LOGIN_PAGE); }
        }

        function renderNavbar() {
            if (document.querySelector(".erp-navbar")) return;
            const style = `
                <style>
                    /* Reset bÃ¡sico para a Navbar */
                    .erp-navbar, .erp-navbar * { box-sizing: border-box; }

                    .erp-navbar { 
                        position: fixed; top: 0; left: 0; width: 100%; 
                        background: #fff; padding: 10px 15px; 
                        display: flex; justify-content: space-between; align-items: center; 
                        box-shadow: 0 2px 10px rgba(0,0,0,.1); z-index: 9999; 
                        font-family: sans-serif; 
                    }
                    .erp-navbar .brand { 
                        font-weight: bold; color: #0f172a; font-size: 1.1rem; 
                        display: flex; align-items: center; gap: 5px; 
                        white-space: nowrap;
                    }
                    .erp-navbar .nav-right { display: flex; gap: 8px; flex-wrap: nowrap; }
                    
                    .erp-navbar .btn { 
                        padding: 6px 10px; border-radius: 6px; font-weight: bold; font-size: 12px; border: none; 
                        cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; 
                        gap: 5px; transition: 0.3s; white-space: nowrap; color: white;
                    }
                    .erp-navbar .btn-logout { background: #ef4444; }
                    .erp-navbar .btn-home { background: #3ecf8e; }
                    
                    /* Ajustes para Celular */
                    @media (max-width: 600px) {
                        .erp-navbar { padding: 8px 10px; }
                        .erp-navbar .brand { font-size: 0.9rem; }
                        .erp-navbar .btn span { display: none; } /* Esconde o texto, deixa sÃ³ o Ã­cone no celular se ficar apertado */
                        .erp-navbar .btn { padding: 8px 12px; font-size: 14px; }
                    }

                    body.erp-guard-active { padding-top: 70px !important; }
                </style>`;

            const html = `
                <div class="erp-navbar">
                    <div class="brand"><span style="color: #3ecf8e;">â—</span> ${CONFIG.APP_NAME}</div>
                    <div class="nav-right">
                        <a href="${CONFIG.HUB_PAGE}" class="btn btn-home"><i class="fas fa-external-link-alt"></i> <span>Projetos</span></a>
                        <a href="${CONFIG.HOME_PAGE}" class="btn btn-home"><i class="fas fa-home"></i> <span>InÃ­cio</span></a>
                        <button class="btn btn-logout" id="btnSair"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button>
                    </div>
                </div>`;

            document.head.insertAdjacentHTML("beforeend", style);
            document.body.insertAdjacentHTML("afterbegin", html);
            document.body.classList.add("erp-guard-active");
            document.getElementById("btnSair")?.addEventListener("click", logout);
        }

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", async () => {
                const session = await validarSessao();
                if (session) renderNavbar();
            });
        } else {
            const session = await validarSessao();
            if (session) renderNavbar();
        }

    } catch (err) {
        console.error("Erro crÃ­tico no Guard:", err);
    }
})();

```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
# bloco_de_notas
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
```
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloco de Notas - ERP ABP</title>
    
    <script src="conexao.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #3ecf8e;
            --dark: #0f172a;
            --bg: #f1f5f9;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --gray: #94a3b8;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 40px auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        h2 { color: var(--dark); margin-top: 0; }

        textarea, input[type="text"] {
            width: 100%;
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-save {
            background: var(--primary);
            color: white;
            padding: 15px;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            border-radius: 8px;
            font-size: 16px;
            transition: 0.3s;
        }

        .btn-save:hover { filter: brightness(1.1); }

        /* Estilo do Novo BotÃ£o de Cancelar */
        .btn-cancel {
            background: var(--gray);
            color: white;
            padding: 12px;
            border: none;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
            display: none; /* Escondido por padrÃ£o */
            transition: 0.3s;
        }

        .btn-cancel:hover { background: #64748b; }

        .note {
            border-bottom: 1px solid #f1f1f1;
            padding: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .note-content strong {
            color: #1e293b;
            font-size: 1.1em;
            display: block;
            margin-bottom: 5px;
        }

        .note-content p {
            color: #64748b;
            margin: 0;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .actions button {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            color: white;
            transition: 0.2s;
        }

        .actions button:hover { opacity: 0.8; }

        .search-box {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .export-btn {
            width: 100%;
            background: #2c3e50;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="form-title">Minhas Notas</h2>
        <input type="hidden" id="note-id">
        <input type="text" id="title" placeholder="TÃ­tulo da nota...">
        <textarea id="content" rows="4" placeholder="Escreva algo importante..."></textarea>

        <button class="btn-save" id="btn-save" onclick="saveNote()">
            Salvar Nota
        </button>
        
        <button class="btn-cancel" id="btn-cancel" onclick="resetForm()">
            Cancelar EdiÃ§Ã£o
        </button>

        <div class="search-box">
            <label style="font-size: 12px; font-weight: bold; color: #64748b;">PESQUISAR OU EXPORTAR</label>
            <input type="text" id="search" placeholder="ğŸ” Digite para buscar..." onkeyup="filterNotes()">
            <button class="export-btn" onclick="exportAllToPDF()">
                <i class="fas fa-file-pdf"></i> Exportar Notas para PDF
            </button>
        </div>

        <div id="notes-list"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        /** ERP ABP - Bloco de Notas Integrado **/
        (function() {
            "use strict";

            let allNotes = [];

            // 1. Aguarda a conexÃ£o com Supabase do conexao.js
            async function init() {
                if (!window._supabase) {
                    setTimeout(init, 200);
                    return;
                }
                loadNotes();
            }

            // 2. Carregar Notas
            async function loadNotes() {
                const { data, error } = await _supabase
                    .from('notes')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) return console.error("Erro:", error);
                allNotes = data || [];
                renderNotes(allNotes);
            }

            // 3. Renderizar Lista
            function renderNotes(notes) {
                const list = document.getElementById('notes-list');
                list.innerHTML = notes.map(n => `
                    <div class="note">
                        <div class="note-content">
                            <strong>${n.title}</strong>
                            <p>${n.content}</p>
                        </div>
                        <div class="actions">
                            <button style="background:var(--warning)" onclick="window.prepareEdit('${n.id}')"><i class="fas fa-edit"></i></button>
                            <button style="background:var(--danger)" onclick="window.deleteNote('${n.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('') || '<p style="text-align:center; color:#94a3b8;">Nenhuma nota encontrada.</p>';
            }

            // 4. Salvar ou Atualizar
            window.saveNote = async function() {
                const id = document.getElementById('note-id').value;
                const title = document.getElementById('title').value;
                const content = document.getElementById('content').value;

                if (!title || !content) return alert("Por favor, preencha o tÃ­tulo e o conteÃºdo.");

                const { data: { user } } = await _supabase.auth.getUser();

                if (id) {
                    await _supabase.from('notes').update({ title, content }).eq('id', id);
                } else {
                    await _supabase.from('notes').insert([{ title, content, user_id: user.id }]);
                }

                resetForm();
                loadNotes();
            };

            // 5. Preparar EdiÃ§Ã£o
            window.prepareEdit = function(id) {
                const note = allNotes.find(n => n.id === id);
                if (!note) return;

                document.getElementById('note-id').value = note.id;
                document.getElementById('title').value = note.title;
                document.getElementById('content').value = note.content;
                
                document.getElementById('form-title').innerText = "Editando Nota";
                document.getElementById('btn-save').innerText = "Atualizar Nota";
                document.getElementById('btn-cancel').style.display = 'block';
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            // 6. Resetar FormulÃ¡rio (FunÃ§Ã£o Cancelar)
            window.resetForm = function() {
                document.getElementById('note-id').value = '';
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
                
                document.getElementById('form-title').innerText = "Minhas Notas";
                document.getElementById('btn-save').innerText = "Salvar Nota";
                document.getElementById('btn-cancel').style.display = 'none';
            };

            // 7. Excluir Nota
            window.deleteNote = async function(id) {
                if (confirm("Tem certeza que deseja excluir esta nota?")) {
                    await _supabase.from('notes').delete().eq('id', id);
                    loadNotes();
                }
            };

            // 8. Busca
            window.filterNotes = function() {
                const q = document.getElementById('search').value.toLowerCase();
                renderNotes(allNotes.filter(n => n.title.toLowerCase().includes(q) || n.content.toLowerCase().includes(q)));
            };

            // 9. PDF
            window.exportAllToPDF = function() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18);
                doc.text("RelatÃ³rio de Notas - ERP ABP", 10, 20);
                
                doc.setFontSize(12);
                let y = 35;
                allNotes.forEach((n, i) => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.setFont(undefined, 'bold');
                    doc.text(`${i + 1}. ${n.title}`, 10, y);
                    doc.setFont(undefined, 'normal');
                    const textLines = doc.splitTextToSize(n.content, 180);
                    doc.text(textLines, 10, y + 7);
                    y += (textLines.length * 7) + 15;
                });
                doc.save("notas_erp_abp.pdf");
            };

            document.addEventListener('DOMContentLoaded', init);
        })();
    </script>
</body>
</html>

```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
# entidades.html
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
```
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o de Entidades - ERP ABP</title>
    <script src="conexao.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary: #3ecf8e;
            --dark: #0f172a;
            --bg: #f1f5f9;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
        }

        .container {
            max-width: 1100px;
            margin: auto;
            padding: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .section-title {
            color: var(--primary);
            font-size: 14px;
            text-transform: uppercase;
            margin: 20px 0 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            font-weight: bold;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #64748b;
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-wrapper i {
            position: absolute;
            right: 10px;
            cursor: pointer;
            color: #64748b;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
        }

        .btn-add {
            background: var(--primary);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
        }

        .btn-cancel {
            background: #64748b;
            color: white;
            margin-top: 10px;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            display: none;
            width: 100%;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; padding: 15px; color: #64748b; font-size: 12px; text-transform: uppercase; }
        td { padding: 15px; border-top: 1px solid #f1f5f9; }

        .btn-edit { color: #3b82f6; cursor: pointer; font-size: 18px; background: none; border: none; margin-right: 10px;}
        .btn-del { color: #ef4444; cursor: pointer; font-size: 18px; background: none; border: none; margin-right: 10px;}
        .btn-wpp { color: #25d366; cursor: pointer; font-size: 18px; background: none; border: none; margin-right: 10px;}
        .btn-mail { color: #ea4335; cursor: pointer; font-size: 18px; background: none; border: none; }

        .export-area {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-export {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export-full { background: #1e293b; }   
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h3 id="form-title">Novo Cadastro de Entidade</h3>
        <input type="hidden" id="edit-id">

        <div class="section-title">InformaÃ§Ãµes e Acesso</div>
        <div class="form-grid">
            <div><label>Nome Completo / RazÃ£o *</label><input type="text" id="nome_completo"></div>
            <div><label>CPF / CNPJ</label><input type="text" id="cpf"></div>
            <div><label>Data Nascimento</label><input type="date" id="data_nascimento"></div>
            <div><label>E-mail</label><input type="email" id="email"></div>
            <div><label>Telefone / WhatsApp *</label><input type="text" id="telefone"></div>
            <div>
                <label>Senha Interna</label>
                <div class="password-wrapper">
                    <input type="password" id="senha_acesso">
                    <i class="fas fa-eye" id="togglePassword" onclick="togglePasswordVisibility()"></i>
                </div>
            </div>
            
            <div>
                <label>NÃ­vel de Acesso</label>
                <select id="acesso">
                    <option value="cliente">Cliente</option>
                    <option value="funcionario">FuncionÃ¡rio</option>
                    <option value="comprador">Comprador</option>
                    <option value="master">Master</option>
                </select>
            </div>
            <div>
                <label>Relacionamento</label>
                <select id="relacionamento">
                    <option value="cliente">Cliente</option>
                    <option value="funcionario">FuncionÃ¡rio</option>
                    <option value="fornecedor">Fornecedor</option>
                    <option value="terceirizado">Terceirizado</option>
                    <option value="outros">Outros</option>
                </select>
            </div>
            <div>
                <label>Status</label>
                <select id="status">
                    <option value="ativo">Ativo</option>
                    <option value="desativado">Desativado</option>
                </select>
            </div>
            <div><label>AvaliaÃ§Ã£o (0-10)</label><input type="number" id="avaliacao" min="0" max="10" value="5"></div>
        </div>

        <div class="section-title">EndereÃ§o</div>
        <div class="form-grid">
            <div><label>CEP</label><input type="text" id="cep" maxlength="8" onblur="buscaCEP()"></div>
            <div style="grid-column: span 2;"><label>Logradouro</label><input type="text" id="logradouro"></div>
            <div><label>NÃºmero</label><input type="text" id="numero"></div>
            <div><label>Bairro</label><input type="text" id="bairro"></div>
            <div><label>Cidade</label><input type="text" id="cidade"></div>
            <div><label>UF</label><input type="text" id="estado" maxlength="2"></div>
        </div>

        <div class="section-title">Complementos</div>
        <div class="form-grid">
            <div style="grid-column: span 2;"><label>URL de Arquivos</label><input type="text" id="arquivos_url"></div>
            <div style="grid-column: span 2;"><label>ObservaÃ§Ãµes</label><textarea id="observacoes" rows="2"></textarea></div>
        </div>

        <button class="btn-add" id="btn-save" onclick="handleSave()">Salvar Entidade</button>
        <button class="btn-cancel" id="btn-cancel" onclick="resetForm()">Cancelar EdiÃ§Ã£o</button>
    </div>

    <div class="card" style="margin-bottom: 10px; padding: 15px;">
        <label><i class="fas fa-search"></i> BUSCAR ENTIDADE</label>
        <input type="text" id="inputBusca" placeholder="Digite o nome para filtrar..." onkeyup="filtrarTabela()">
        
        <div class="export-area">
            <button class="btn-export" onclick="exportarPDFListagem()">
                <i class="fas fa-list"></i> Exportar Listagem (PDF)
            </button>
            <button class="btn-export btn-export-full" onclick="exportarPDFFichaCompleta()">
                <i class="fas fa-file-invoice"></i> Exportar Fichas Detalhadas (PDF)
            </button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Nome / Tipo</th>
                    <th>Telefone / E-mail</th>
                    <th>Acesso / Status</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody id="entities-list">
                <tr><td colspan="4" style="text-align:center">Carregando entidades...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
Â Â Â  /** ERP ABP - MÃ³dulo Entidades **/
(function() {
Â Â Â  "use strict";

Â Â Â  let currentData = [];

Â Â Â  // ExpÃµe as funÃ§Ãµes para o HTML (onclick)
Â Â Â  window.togglePasswordVisibility = function() {
Â Â Â Â Â Â Â  const passwordInput = document.getElementById('senha_acesso');
Â Â Â Â Â Â Â  const toggleIcon = document.getElementById('togglePassword');
Â Â Â Â Â Â Â  if (passwordInput.type === 'password') {
Â Â Â Â Â Â Â Â Â Â Â  passwordInput.type = 'text';
Â Â Â Â Â Â Â Â Â Â Â  toggleIcon.classList.replace('fa-eye', 'fa-eye-slash');
Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â  passwordInput.type = 'password';
Â Â Â Â Â Â Â Â Â Â Â  toggleIcon.classList.replace('fa-eye-slash', 'fa-eye');
Â Â Â Â Â Â Â  }
Â Â Â  };

Â Â Â  window.buscaCEP = async function() {
Â Â Â Â Â Â Â  const cep = document.getElementById('cep').value.replace(/\D/g, '');
Â Â Â Â Â Â Â  if (cep.length === 8) {
Â Â Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const data = await res.json();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if (!data.erro) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('logradouro').value = data.logradouro;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('bairro').value = data.bairro;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('cidade').value = data.localidade;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  document.getElementById('estado').value = data.uf;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  } catch { console.error("Erro CEP"); }
Â Â Â Â Â Â Â  }
Â Â Â  };

Â Â Â  async function loadEntities() {
Â Â Â Â Â Â Â  // Aguarda o _supabase ser inicializado pelo conexao.js se necessÃ¡rio
Â Â Â Â Â Â Â  if (!window._supabase) {
Â Â Â Â Â Â Â Â Â Â Â  setTimeout(loadEntities, 500);
Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â  }

Â Â Â Â Â Â Â  const { data, error } = await _supabase.from('entidades').select('*').order('nome_completo');
Â Â Â Â Â Â Â  if (error) {
Â Â Â Â Â Â Â Â Â Â Â  console.error("Erro ao carregar:", error);
Â Â Â Â Â Â Â Â Â Â Â  return;
Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  currentData = data || [];
Â Â Â Â Â Â Â  renderTable(currentData);
Â Â Â  }

Â Â Â  function renderTable(data) {
Â Â Â Â Â Â Â  const list = document.getElementById('entities-list');
Â Â Â Â Â Â Â  list.innerHTML = data.map(c => {
Â Â Â Â Â Â Â Â Â Â Â  const wppLink = c.telefone && c.telefone.includes('http') ? c.telefone : `https://wa.me/${c.telefone ? c.telefone.replace(/\D/g, '') : ''}`;
Â Â Â Â Â Â Â Â Â Â Â  const mailLink = c.email ? `https://mail.google.com/mail/?view=cm&fs=1&to=${c.email}` : '#';

Â Â Â Â Â Â Â Â Â Â Â  return `
Â Â Â Â Â Â Â Â Â Â Â  <tr>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <td><b>${c.nome_completo}</b><br><small>${(c.relacionamento || '').toUpperCase()}</small></td>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <td>${c.telefone || 'Sem contato'}<br><small>${c.email || ''}</small></td>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <td>${c.acesso}<br><small style="color:${c.status === 'ativo' ? 'green' : 'red'}">${c.status}</small></td>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <td>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button class="btn-edit" title="Editar" onclick="editFull('${c.id}')"><i class="fas fa-edit"></i></button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <button class="btn-del" title="Excluir" onclick="deleteEntity('${c.id}')"><i class="fas fa-trash"></i></button>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <a href="${wppLink}" target="_blank" class="btn-wpp" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  <a href="${mailLink}" target="_blank" class="btn-mail" title="Gmail"><i class="fas fa-envelope"></i></a>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  </td>
Â Â Â Â Â Â Â Â Â Â Â  </tr>`;
Â Â Â Â Â Â Â  }).join('') || '<tr><td colspan="4" style="text-align:center">Nenhuma entidade encontrada.</td></tr>';
Â Â Â  }

Â Â Â  window.filtrarTabela = function() {
Â Â Â Â Â Â Â  const filtro = document.getElementById("inputBusca").value.toLowerCase();
Â Â Â Â Â Â Â  const linhas = document.querySelectorAll("#entities-list tr");
Â Â Â Â Â Â Â  linhas.forEach(linha => {
Â Â Â Â Â Â Â Â Â Â Â  const txt = linha.innerText.toLowerCase();
Â Â Â Â Â Â Â Â Â Â Â  linha.style.display = txt.includes(filtro) ? "" : "none";
Â Â Â Â Â Â Â  });
Â Â Â  };

Â Â Â  window.handleSave = async function() {
Â Â Â Â Â Â Â  const { data: { user } } = await _supabase.auth.getUser();
Â Â Â Â Â Â Â  const id = document.getElementById('edit-id').value;
Â Â Â Â Â Â Â  const dados = {
Â Â Â Â Â Â Â Â Â Â Â  usuario_id: user.id,
Â Â Â Â Â Â Â Â Â Â Â  nome_completo: document.getElementById('nome_completo').value,
Â Â Â Â Â Â Â Â Â Â Â  cpf: document.getElementById('cpf').value,
Â Â Â Â Â Â Â Â Â Â Â  data_nascimento: document.getElementById('data_nascimento').value || null,
Â Â Â Â Â Â Â Â Â Â Â  email: document.getElementById('email').value,
Â Â Â Â Â Â Â Â Â Â Â  telefone: document.getElementById('telefone').value,
Â Â Â Â Â Â Â Â Â Â Â  senha_acesso: document.getElementById('senha_acesso').value,
Â Â Â Â Â Â Â Â Â Â Â  acesso: document.getElementById('acesso').value,
Â Â Â Â Â Â Â Â Â Â Â  relacionamento: document.getElementById('relacionamento').value,
Â Â Â Â Â Â Â Â Â Â Â  status: document.getElementById('status').value,
Â Â Â Â Â Â Â Â Â Â Â  avaliacao: parseInt(document.getElementById('avaliacao').value),
Â Â Â Â Â Â Â Â Â Â Â  observacoes: document.getElementById('observacoes').value,
Â Â Â Â Â Â Â Â Â Â Â  cep: document.getElementById('cep').value,
Â Â Â Â Â Â Â Â Â Â Â  logradouro: document.getElementById('logradouro').value,
Â Â Â Â Â Â Â Â Â Â Â  numero: document.getElementById('numero').value,
Â Â Â Â Â Â Â Â Â Â Â  bairro: document.getElementById('bairro').value,
Â Â Â Â Â Â Â Â Â Â Â  cidade: document.getElementById('cidade').value,
Â Â Â Â Â Â Â Â Â Â Â  estado: document.getElementById('estado').value,
Â Â Â Â Â Â Â Â Â Â Â  arquivos_url: document.getElementById('arquivos_url').value ? [document.getElementById('arquivos_url').value] : []
Â Â Â Â Â Â Â  };
Â Â Â Â Â Â  Â 
Â Â Â Â Â Â Â  if (!dados.nome_completo) return alert("Nome Ã© obrigatÃ³rio");
Â Â Â Â Â Â  Â 
Â Â Â Â Â Â Â  const { error } = id ? await _supabase.from('entidades').update(dados).eq('id', id) : await _supabase.from('entidades').insert([dados]);
Â Â Â Â Â Â  Â 
Â Â Â Â Â Â Â  if (error) alert("Erro: " + error.message); 
Â Â Â Â Â Â Â  else { resetForm(); loadEntities(); }
Â Â Â  };

Â Â Â  window.editFull = async function(id) {
Â Â Â Â Â Â Â  const { data, error } = await _supabase.from('entidades').select('*').eq('id', id).single();
Â Â Â Â Â Â Â  if (error || !data) return;
Â Â Â Â Â Â Â  Object.keys(data).forEach(k => {
Â Â Â Â Â Â Â Â Â Â Â  const el = document.getElementById(k);
Â Â Â Â Â Â Â Â Â Â Â  if (el) el.value = (k === 'arquivos_url' && data[k]) ? data[k][0] : (data[k] || '');
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  document.getElementById('edit-id').value = data.id;
Â Â Â Â Â Â Â  document.getElementById('form-title').innerText = "Editando Entidade";
Â Â Â Â Â Â Â  document.getElementById('btn-save').innerText = "Atualizar Entidade";
Â Â Â Â Â Â Â  document.getElementById('btn-cancel').style.display = "block";
Â Â Â Â Â Â Â  window.scrollTo({ top: 0, behavior: 'smooth' });
Â Â Â  };

Â Â Â  window.resetForm = function() {
Â Â Â Â Â Â Â  document.querySelectorAll('input, select, textarea').forEach(i => {
Â Â Â Â Â Â Â Â Â Â Â  if(i.id === 'avaliacao') i.value = '5';
Â Â Â Â Â Â Â Â Â Â Â  else if(i.tagName === 'SELECT') i.selectedIndex = 0;
Â Â Â Â Â Â Â Â Â Â Â  else i.value = '';
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  document.getElementById('edit-id').value = '';
Â Â Â Â Â Â Â  document.getElementById('form-title').innerText = "Novo Cadastro de Entidade";
Â Â Â Â Â Â Â  document.getElementById('btn-save').innerText = "Salvar Entidade";
Â Â Â Â Â Â Â  document.getElementById('btn-cancel').style.display = "none";
Â Â Â  };

Â Â Â  window.deleteEntity = async function(id) {
Â Â Â Â Â Â Â  if (confirm("Excluir definitivamente?")) {
Â Â Â Â Â Â Â Â Â Â Â  await _supabase.from('entidades').delete().eq('id', id);
Â Â Â Â Â Â Â Â Â Â Â  loadEntities();
Â Â Â Â Â Â Â  }
Â Â Â  };

Â Â Â  // FunÃ§Ãµes de PDF (Globais)
Â Â Â  window.exportarPDFListagem = function() {
Â Â Â Â Â Â Â  const { jsPDF } = window.jspdf;
Â Â Â Â Â Â Â  const doc = new jsPDF();
Â Â Â Â Â Â Â  doc.text("Listagem de Entidades - ERP ABP", 14, 15);
Â Â Â Â Â Â Â  const rows = [];
Â Â Â Â Â Â Â  document.querySelectorAll("#entities-list tr").forEach(tr => {
Â Â Â Â Â Â Â Â Â Â Â  if (tr.style.display !== "none") {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  const cells = tr.querySelectorAll("td");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  if(cells.length > 3) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  rows.push([
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  cells[0].innerText.replace('\n', ' - '), 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  cells[1].innerText.replace('\n', ' - '), 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  cells[2].innerText.replace('\n', ' - ')
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ]);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  doc.autoTable({ head: [['Entidade / Tipo', 'Contato', 'Acesso / Status']], body: rows, startY: 20 });
Â Â Â Â Â Â Â  doc.save("listagem_entidades.pdf");
Â Â Â  };

Â Â Â  window.exportarPDFFichaCompleta = function() {
Â Â Â Â Â Â Â  const { jsPDF } = window.jspdf;
Â Â Â Â Â Â Â  const doc = new jsPDF();
Â Â Â Â Â Â Â  let y = 20;
Â Â Â Â Â Â Â  const filtro = document.getElementById("inputBusca").value.toLowerCase();
Â Â Â Â Â Â Â  const dadosFiltrados = currentData.filter(c => (c.nome_completo || '').toLowerCase().includes(filtro));
Â Â Â Â Â Â  Â 
Â Â Â Â Â Â Â  doc.setFontSize(16);
Â Â Â Â Â Â Â  doc.text("FICHAS DETALHADAS DE ENTIDADES", 14, y);
Â Â Â Â Â Â Â  y += 10;

Â Â Â Â Â Â Â  dadosFiltrados.forEach((c, index) => {
Â Â Â Â Â Â Â Â Â Â Â  if (y > 250) { doc.addPage(); y = 20; }
Â Â Â Â Â Â Â Â Â Â Â  doc.setFontSize(11); doc.setFont(undefined, 'bold');
Â Â Â Â Â Â Â Â Â Â Â  doc.text(`${index + 1}. ${(c.nome_completo || '').toUpperCase()}`, 14, y);
Â Â Â Â Â Â Â Â Â Â Â  y += 6; 
Â Â Â Â Â Â Â Â Â Â Â  doc.setFontSize(9); doc.setFont(undefined, 'normal');
Â Â Â Â Â Â Â Â Â Â Â  doc.text(`Doc: ${c.cpf || 'N/A'} | Nasc: ${c.data_nascimento || 'N/A'}`, 14, y);
Â Â Â Â Â Â Â Â Â Â Â  y += 4;
Â Â Â Â Â Â Â Â Â Â Â  doc.text(`Email: ${c.email || 'N/A'} | Tel: ${c.telefone || 'N/A'}`, 14, y);
Â Â Â Â Â Â Â Â Â Â Â  y += 4;
Â Â Â Â Â Â Â Â Â Â Â  doc.text(`End: ${c.logradouro || ''}, ${c.numero || ''} - ${c.bairro || ''}, ${c.cidade || ''}/${c.estado || ''}`, 14, y);
Â Â Â Â Â Â Â Â Â Â Â  y += 4;
Â Â Â Â Â Â Â Â Â Â Â  doc.text(`Tipo: ${c.relacionamento} | Acesso: ${c.acesso} | Status: ${c.status}`, 14, y);
Â Â Â Â Â Â Â Â Â Â Â  y += 4;
Â Â Â Â Â Â Â Â Â Â Â  doc.text(`Obs: ${c.observacoes || 'Nenhuma'}`, 14, y);
Â Â Â Â Â Â Â Â Â Â Â  y += 5;
Â Â Â Â Â Â Â Â Â Â Â  doc.line(14, y, 196, y);
Â Â Â Â Â Â Â Â Â Â Â  y += 8;
Â Â Â Â Â Â Â  });
Â Â Â Â Â Â Â  doc.save("fichas_entidades.pdf");
Â Â Â  };

Â Â Â  // Inicia a carga
Â Â Â  document.addEventListener('DOMContentLoaded', loadEntities);
})();
</script>
</body>
</html>



```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
# finaceiro.html
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
```
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o Financeira - ERP ABP</title>
    <script src="conexao.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
  <style>
      :root { 
    --primary: #3ecf8e; 
    --dark: #0f172a; 
    --bg: #f1f5f9; 
    --danger: #ef4444; 
}

* { box-sizing: border-box; }

body { 
    margin: 0; 
    font-family: 'Segoe UI', sans-serif; 
    background: var(--bg); 
    padding-top: 85px; 
}

.container { max-width: 1200px; margin: auto; padding: 20px; }

.card { 
    background: white; 
    padding: 25px; 
    border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
    margin-bottom: 20px; 
}

.navbar { 
    position: fixed; top: 0; left: 0; width: 100%; 
    background: white; padding: 15px 25px; 
    display: flex; justify-content: space-between; align-items: center; 
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; 
}

.nav-link { text-decoration: none; color: #64748b; font-weight: bold; margin-right: 15px; }
.btn-exit { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; }

.section-title { 
    color: var(--primary); font-size: 14px; text-transform: uppercase; 
    margin: 20px 0 10px; border-bottom: 1px solid #eee; 
    padding-bottom: 5px; font-weight: bold; 
}

.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: bold; }
input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }

.btn-add { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 20px; }
.btn-cancel { background: #64748b; color: white; margin-top: 10px; border: none; padding: 10px; border-radius: 6px; cursor: pointer; display: none; width: 100%; }

.table-container { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
table { width: 100%; border-collapse: collapse; min-width: 1100px; }
th { background: #f8fafc; padding: 15px; color: #64748b; font-size: 12px; text-transform: uppercase; text-align: left; }
td { padding: 12px 15px; border-top: 1px solid #f1f5f9; font-size: 14px; }

.status-badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
.status-pago { background: #dcfce7; color: #166534; }
.status-pendente { background: #fef9c3; color: #854d0e; }

.label-tipo { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-right: 5px; }
.tipo-pagar { color: var(--danger); }
.tipo-receber { color: var(--primary); }

.resumo-financeiro { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
.resumo-card { padding: 15px; border-radius: 10px; color: white; text-align: center; }
.resumo-entradas { background: #10b981; }
.resumo-saidas { background: #ef4444; }
.resumo-saldo { background: #3b82f6; }

.bulk-actions { margin-bottom: 10px; display: none; background: #fee2e2; padding: 10px; border-radius: 8px; border: 1px solid #fecaca; }
.btn-delete-bulk { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-left: 15px; }
.btn-action { background: none; border: none; cursor: pointer; font-size: 16px; margin-right: 8px; }
.btn-pdf { background: #334155; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
      </style>
 
</head>
<body>

<div class="container">
    <div class="card">
        <h3 id="form-title">Novo LanÃ§amento</h3>
        <input type="hidden" id="edit-id">
        
        <div class="section-title">Dados e Parcelamento</div>
        <div class="form-grid">
            <div><label>Tipo *</label><select id="tipo"><option value="pagar">SaÃ­da</option><option value="receber">Entrada</option></select></div>
            <div style="grid-column: span 2;"><label>DescriÃ§Ã£o *</label><input type="text" id="descricao"></div>
            <div><label>Valor Parcela (R$) *</label><input type="number" id="valor" step="0.01"></div>
            <div><label>Qtde Parcelas</label><input type="number" id="parcelas" value="1" min="1"></div>
        </div>

        <div class="section-title">Datas e Status</div>
        <div class="form-grid">
            <div><label>1Âº Vencimento *</label><input type="date" id="data_vencimento"></div>
            <div><label>Data Pagamento</label><input type="date" id="data_pagamento"></div>
            <div><label>Status</label><select id="status"><option value="pendente">Pendente</option><option value="pago">Pago/Recebido</option></select></div>
        </div>

        <div class="section-title">ClassificaÃ§Ã£o</div>
        <div class="form-grid">
            <div><label>Entidade</label><select id="entidade_id"><option value="">Selecione...</option></select></div>
            <div><label>Categoria</label><input type="text" id="categoria"></div>
            <div><label>Forma Pagto</label><input type="text" id="forma_pagamento"></div>
        </div>
        
        <button class="btn-add" id="btn-save" onclick="handleSave()">Salvar LanÃ§amento(s)</button>
        <button class="btn-cancel" id="btn-cancel" onclick="resetForm()">Cancelar EdiÃ§Ã£o</button>
    </div>

    <div class="card">
        <div class="form-grid">
            <div style="grid-column: span 2;"><label>Busca Inteligente (Tudo)</label><input type="text" id="inputBusca" onkeyup="filtrarTabela()" placeholder="Busque por descriÃ§Ã£o, categoria, valor..."></div>
            <div><label>InÃ­cio</label><input type="date" id="dataInicio" onchange="filtrarTabela()"></div>
            <div><label>Fim</label><input type="date" id="dataFim" onchange="filtrarTabela()"></div>
            <div style="display: flex; align-items: flex-end;">
                <button class="btn-pdf" onclick="exportarPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>
        </div>
    </div>

    <div class="resumo-financeiro">
        <div class="resumo-card resumo-entradas"><span>Entradas</span><br><b id="total-receber">R$ 0,00</b></div>
        <div class="resumo-card resumo-saidas"><span>SaÃ­das</span><br><b id="total-pagar">R$ 0,00</b></div>
        <div class="resumo-card resumo-saldo"><span>Saldo Filtrado</span><br><b id="total-saldo">R$ 0,00</b></div>
    </div>

    <div id="bulk-area" class="bulk-actions" style="display:none;">
        <span id="selected-count" style="font-weight:bold; color:#b91c1c;">0 selecionados</span>
        <button onclick="deleteSelected()" class="btn-delete-bulk"><i class="fas fa-trash"></i> Excluir Selecionados</button>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th width="40"><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></th>
                    <th>Tipo</th>
                    <th>DescriÃ§Ã£o</th>
                    <th>Categoria</th>
                    <th>Forma Pagto</th>
                    <th>Vencimento</th>
                    <th>Pagamento</th>
                    <th>Valor</th>
                    <th>Status</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody id="financeiro-list"></tbody>
        </table>
    </div>
</div>

<script>
 /** ERP ABP - MÃ³dulo Financeiro **/
(function() {
    "use strict";

    let currentFinanceData = [];
    let filteredData = [];

    // UtilitÃ¡rio de Data
    function formatarDataBR(dataISO) {
        if(!dataISO) return '---';
        const partes = dataISO.split('-');
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }

    // Carregar Dados Principais
    async function loadFinanceiro() {
        if (!window._supabase) {
            setTimeout(loadFinanceiro, 500);
            return;
        }

        const { data, error } = await _supabase.from('financeiro')
            .select('*, entidades(nome_completo)')
            .order('data_vencimento', { ascending: true });
        
        if (error) return console.error("Erro Financeiro:", error);
        currentFinanceData = data || [];
        window.filtrarTabela();
    }

    // Renderizar Tabela
    function renderTable(data) {
        const list = document.getElementById('financeiro-list');
        let e = 0, s = 0;
        
        list.innerHTML = data.map(f => {
            const val = parseFloat(f.valor) || 0;
            const tipoLabel = f.tipo === 'receber' ? 'Entrada' : 'SaÃ­da';
            if(f.tipo === 'receber') e += val; else s += val;
            
            return `
            <tr>
                <td><input type="checkbox" class="row-checkbox" value="${f.id}" onclick="updateBulkUI()"></td>
                <td><span class="label-tipo tipo-${f.tipo}">${tipoLabel}</span></td>
                <td>${f.descricao}</td>
                <td>${f.categoria || '-'}</td>
                <td>${f.forma_pagamento || '-'}</td>
                <td>${formatarDataBR(f.data_vencimento)}</td>
                <td>${f.data_pagamento ? formatarDataBR(f.data_pagamento) : '<small style="color:#ccc">---</small>'}</td>
                <td><b>R$ ${val.toLocaleString('pt-BR', {minimumFractionDigits:2})}</b></td>
                <td><span class="status-badge status-${f.status}">${f.status}</span></td>
                <td>
                    <button class="btn-action" style="color:#3b82f6; border:none; background:none; cursor:pointer;" onclick="editFinance('${f.id}')"><i class="fas fa-edit"></i></button>
                    <button class="btn-action" style="color:#ef4444; border:none; background:none; cursor:pointer;" onclick="deleteSingle('${f.id}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }).join('') || '<tr><td colspan="10" style="text-align:center">Nenhum resultado encontrado.</td></tr>';
        
        document.getElementById('total-receber').innerText = `R$ ${e.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
        document.getElementById('total-pagar').innerText = `R$ ${s.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
        document.getElementById('total-saldo').innerText = `R$ ${(e-s).toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
    }

    // Filtros e Busca
    window.filtrarTabela = function() {
        const busca = document.getElementById('inputBusca').value.toLowerCase();
        const dIni = document.getElementById('dataInicio').value;
        const dFim = document.getElementById('dataFim').value;
        
        filteredData = currentFinanceData.filter(f => {
            const valorFormatado = (parseFloat(f.valor) || 0).toLocaleString('pt-BR', {minimumFractionDigits:2});
            const tipoExtenso = f.tipo === 'receber' ? 'entrada' : 'saida saÃ­da';

            const matchBusca = f.descricao.toLowerCase().includes(busca) || 
                               (f.categoria && f.categoria.toLowerCase().includes(busca)) ||
                               f.status.toLowerCase().includes(busca) ||
                               valorFormatado.includes(busca) ||
                               tipoExtenso.includes(busca);

            let matchData = true;
            if(dIni) matchData = matchData && (f.data_vencimento >= dIni);
            if(dFim) matchData = matchData && (f.data_vencimento <= dFim);

            return matchBusca && matchData;
        });
        renderTable(filteredData);
    };

    // PDF
    window.exportarPDF = function() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        doc.text("Extrato Financeiro - ERP ABP", 14, 15);
        
        const body = filteredData.map(f => [
            f.tipo === 'receber' ? 'ENTRADA' : 'SAÃDA',
            f.descricao,
            f.categoria || '-',
            f.forma_pagamento || '-',
            formatarDataBR(f.data_vencimento),
            f.data_pagamento ? formatarDataBR(f.data_pagamento) : '-',
            `R$ ${parseFloat(f.valor).toLocaleString('pt-BR', {minimumFractionDigits:2})}`,
            f.status.toUpperCase()
        ]);

        doc.autoTable({
            head: [['TIPO', 'DESCRIÃ‡ÃƒO', 'CATEGORIA', 'FORMA', 'VENC.', 'PAGTO.', 'VALOR', 'STATUS']],
            body: body,
            startY: 25,
            theme: 'striped',
            styles: { fontSize: 8 }
        });
        doc.save('extrato_financeiro.pdf');
    };

    // Salvar LanÃ§amento
    window.handleSave = async function() {
        const { data: { user } } = await _supabase.auth.getUser();
        const id = document.getElementById('edit-id').value;
        const numParcelas = parseInt(document.getElementById('parcelas').value) || 1;
        const valorParcela = parseFloat(document.getElementById('valor').value) || 0;
        const dataString = document.getElementById('data_vencimento').value;

        if(!document.getElementById('descricao').value || !valorParcela || !dataString) {
            return alert("Preencha os campos obrigatÃ³rios.");
        }

        if(id) {
            await _supabase.from('financeiro').update(getFormData(user.id)).eq('id', id);
        } else {
            const lancamentos = [];
            for(let i = 0; i < numParcelas; i++) {
                let dt = new Date(dataString + "T12:00:00"); 
                dt.setMonth(dt.getMonth() + i);
                lancamentos.push({
                    ...getFormData(user.id), 
                    valor: valorParcela,
                    descricao: numParcelas > 1 ? `${document.getElementById('descricao').value} (${i+1}/${numParcelas})` : document.getElementById('descricao').value,
                    data_vencimento: dt.toISOString().split('T')[0]
                });
            }
            await _supabase.from('financeiro').insert(lancamentos);
        }
        window.resetForm(); 
        loadFinanceiro();
    };

    function getFormData(uid) {
        return { 
            usuario_id: uid, 
            tipo: document.getElementById('tipo').value, 
            descricao: document.getElementById('descricao').value, 
            valor: parseFloat(document.getElementById('valor').value), 
            data_vencimento: document.getElementById('data_vencimento').value, 
            data_pagamento: document.getElementById('data_pagamento').value || null, 
            status: document.getElementById('status').value, 
            entidade_id: document.getElementById('entidade_id').value || null, 
            categoria: document.getElementById('categoria').value, 
            forma_pagamento: document.getElementById('forma_pagamento').value 
        };
    }

    // EdiÃ§Ã£o e Delete
    window.editFinance = function(id) {
        const item = currentFinanceData.find(f => f.id === id);
        if(!item) return;
        document.getElementById('edit-id').value = item.id;
        document.getElementById('tipo').value = item.tipo;
        document.getElementById('descricao').value = item.descricao;
        document.getElementById('valor').value = item.valor;
        document.getElementById('data_vencimento').value = item.data_vencimento;
        document.getElementById('data_pagamento').value = item.data_pagamento || '';
        document.getElementById('status').value = item.status;
        document.getElementById('entidade_id').value = item.entidade_id || '';
        document.getElementById('categoria').value = item.categoria || '';
        document.getElementById('forma_pagamento').value = item.forma_pagamento || '';
        document.getElementById('parcelas').disabled = true;
        document.getElementById('form-title').innerText = "Editando LanÃ§amento";
        document.getElementById('btn-save').innerText = "Atualizar LanÃ§amento";
        document.getElementById('btn-cancel').style.display = 'block';
        window.scrollTo({top:0, behavior:'smooth'});
    };

    window.resetForm = function() { 
        document.querySelectorAll('input, select').forEach(i => {
            if(i.id === 'parcelas') i.value = '1';
            else if(i.id === 'tipo') i.value = 'pagar';
            else if(i.id === 'status') i.value = 'pendente';
            else i.value = '';
        }); 
        document.getElementById('edit-id').value = ''; 
        document.getElementById('parcelas').disabled = false; 
        document.getElementById('form-title').innerText = "Novo LanÃ§amento"; 
        document.getElementById('btn-save').innerText = "Salvar LanÃ§amento(s)"; 
        document.getElementById('btn-cancel').style.display = 'none'; 
    };

    window.deleteSingle = async function(id) { 
        if(confirm("Excluir este lanÃ§amento?")) { 
            await _supabase.from('financeiro').delete().eq('id', id); 
            loadFinanceiro(); 
        } 
    };

    // Massa
    window.toggleSelectAll = function() { 
        const isChecked = document.getElementById('select-all').checked; 
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = isChecked); 
        window.updateBulkUI(); 
    };
    
    window.updateBulkUI = function() { 
        const selected = document.querySelectorAll('.row-checkbox:checked').length; 
        document.getElementById('bulk-area').style.display = selected > 0 ? 'block' : 'none'; 
        document.getElementById('selected-count').innerText = `${selected} selecionados`; 
    };
    
    window.deleteSelected = async function() { 
        if(!confirm("Excluir selecionados?")) return; 
        const ids = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value); 
        await _supabase.from('financeiro').delete().in('id', ids); 
        loadFinanceiro(); 
        window.updateBulkUI(); 
    };

    // Carregar Entidades para o Select
    async function loadEntidadesSelect() { 
        if (!window._supabase) return;
        const { data } = await _supabase.from('entidades').select('id, nome_completo'); 
        const select = document.getElementById('entidade_id'); 
        if(data) {
            select.innerHTML = '<option value="">Selecione...</option>' + 
                data.map(e => `<option value="${e.id}">${e.nome_completo}</option>`).join('');
        }
    }

    // InicializaÃ§Ã£o
    document.addEventListener('DOMContentLoaded', () => { 
        loadFinanceiro(); 
        loadEntidadesSelect();
    });

})();   
</script>
</body>
</html>


```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
# index.html
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
```
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA ERP ABP - Inicio</title>
    
    <script src="conexao.js" defer></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
   <style>
       /* Reset e Box-sizing conforme seu padrÃ£o */
* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: #f1f5f9;
    /* Removido o padding fixo para deixar o conexao.js (Guard) controlar via classe .erp-guard-active */
}

.content {
    max-width: 1100px;
    margin: auto;
    padding: 20px;
}

.header-area {
    text-align: center;
    margin-bottom: 30px;
}

.header-area h1 {
    color: #1e293b;
    font-size: 1.8rem;
    letter-spacing: -0.5px;
}

/* Grid Responsivo Inteligente */
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

/* EstilizaÃ§Ã£o dos Cards */
.card {
    background: white;
    padding: 30px;
    border-radius: 12px;
    text-decoration: none;
    color: #334155;
    text-align: center;
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.02);
}

.card:hover {
    transform: translateY(-5px);
    border-color: #3ecf8e;
    box-shadow: 0 10px 25px rgba(62, 207, 142, 0.1);
}

.card i {
    font-size: 40px;
    color: #3ecf8e;
    margin-bottom: 15px;
}

.card h3 {
    margin: 10px 0 5px 0;
    font-size: 1.25rem;
    color: #1e293b;
}

.card p {
    font-size: 0.9em;
    color: #64748b;
    line-height: 1.4;
    margin: 0;
}

/* Responsividade Extra para Celulares Pequenos */
@media (max-width: 480px) {
    .grid {
        grid-template-columns: 1fr;
    }
    .card {
        padding: 20px;
    }
}
   </style>
    
    
   
</head>
<body>
 <div class="content">
        <div class="header-area">
            <h1>SISTEMA ERP ABP</h1>
        </div>
     <div class="grid">

         
<!-- ################################################################ -->
<!-- ################################################################ -->
<!-- ################################################################ -->
<!-- ################################################################ -->
         
 <div class="grid">

     <a href="testes.html" class="card">
        <i class="fas fa-chart-line"></i> <h3>Testes</h3>
        <p>NÃƒO BAGUNCE SEU SISTEMA! salve os codigos no BLOCO DE NOTAS</p>
    </a>
    
  
     
    <a href="bloco_de_notas.html" class="card">
        <i class="fas fa-sticky-note"></i>
        <h3>Bloco de Notas</h3>
        <p>Anote e organize suas ideias na nuvem.</p>
    </a>
    
    <a href="produtos.html" class="card">
        <i class="fas fa-box"></i> <h3>Produtos</h3>
        <p>GestÃ£o de estoque e catÃ¡logo.</p> </a>

    <a href="entidades.html" class="card">
        <i class="fas fa-users"></i>
        <h3>Entidades</h3>
        <p>Clientes, Fornecedores e Colaboradores.</p>
    </a>

    <a href="financeiro.html" class="card">
        <i class="fas fa-chart-line"></i> <h3>Financeiro</h3>
        <p>Fluxo de caixa e controle de contas.</p>
    </a>

     
     
</div>
          

         
<!-- ################################################################ -->
<!-- ################################################################ -->
<!-- ################################################################ -->
<!-- ################################################################ -->

        </div>
    </div>
</body>
</html>






```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
# login.html
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
```
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- CodificaÃ§Ã£o de caracteres -->
    <meta charset="UTF-8">

    <!-- Responsividade para dispositivos mÃ³veis -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- TÃ­tulo da aba -->
    <title>Login - SISTEMA ERP ABP</title>

    <!-- SDK do Supabase (frontend) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- CSS especÃ­fico da tela de login -->
    <style>
    /* VariÃ¡veis globais de cores */
:root {
    --primary: #3ecf8e;
    --dark: #1e293b;
    --bg: #0f172a;
}

/* Estilo base da pÃ¡gina */
body {
    font-family: 'Segoe UI', sans-serif;
    background-color: var(--bg);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}

/* Card central de login */
.login-card {
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    width: 100%;
    max-width: 400px;
    text-align: center;
}

/* TÃ­tulo principal */
h1 {
    color: var(--dark);
    margin-bottom: 5px;
    font-size: 24px;
}

/* SubtÃ­tulo */
h2 {
    color: #64748b;
    margin-bottom: 25px;
    font-size: 16px;
    font-weight: normal;
}

/* Container dos inputs */
.input-container {
    position: relative;
    margin-bottom: 15px;
}

/* Campos de entrada */
input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 16px;
}

/* BotÃ£o para mostrar/ocultar senha */
.toggle-password {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    background: none;
    border: none;
    font-size: 18px;
    color: #666;
}

/* BotÃ£o principal */
button.main-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    background-color: var(--primary);
    color: white;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: 0.3s;
}

/* Hover do botÃ£o */
button.main-btn:hover {
    background-color: #34b27b;
}

/* Links extras */
.extra-links {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    font-size: 14px;
}

/* Estilo dos links */
.link {
    color: #4a90e2;
    text-decoration: none;
    cursor: pointer;
    font-weight: 500;
}

/* BotÃ£o de voltar */
.btn-back {
    background: #e2e8f0;
    color: #475569;
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    margin-bottom: 20px;
    cursor: pointer;
    display: none;
}
    </style>
</head>
<body>

    <!-- Card central de autenticaÃ§Ã£o -->
    <div class="login-card">

        <!-- BotÃ£o de retorno (usado em recuperaÃ§Ã£o/cadastro) -->
        <button id="btn-back" class="btn-back" onclick="toggleMode()">
            â† Voltar para o Login
        </button>

        <!-- TÃ­tulo principal -->
        <h1>SISTEMA ERP ABP</h1>

        <!-- SubtÃ­tulo dinÃ¢mico -->
        <h2 id="form-subtitle">FaÃ§a login para acessar o ERP</h2>

        <!-- Campo de e-mail -->
        <div class="input-container" id="email-group">
            <input type="email" id="email" placeholder="Seu e-mail">
        </div>

        <!-- Campo de senha -->
        <div class="input-container" id="pass-group">
            <input type="password" id="password" placeholder="Sua senha">

            <!-- BotÃ£o para alternar visibilidade da senha -->
            <button type="button" class="toggle-password" onclick="toggleVisibility()">
                ğŸ‘ï¸
            </button>
        </div>

        <!-- BotÃ£o principal (login / cadastro / salvar senha) -->
        <button class="main-btn" id="btn-auth" onclick="handleAuth()">
            Entrar
        </button>

        <!-- Links auxiliares -->
        <div class="extra-links">
            <span id="link-forgot" class="link" onclick="forgotPassword()">
                Esqueci minha senha
            </span>

    <h3>DESENVOLVEDOR: ARISTIDES BP</h3>
    <h3>CONTATO: +55 91 99242-0981</h3>
            
        </div>
    </div>

    
    
    <!-- Script principal do login -->
    <script>

const SUPABASE_URL = 'https://kjhjeaiwjilkgocwvbwi.supabase.co';
const SUPABASE_KEY = 'sb_publishable_WP3TF2GTMMWCS1tCYzQSjA_syIKLyIX';

// CriaÃ§Ã£o do cliente Supabase
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/**
 * Alterna a visibilidade da senha
 */
function toggleVisibility() {
    const passInput = document.getElementById('password');
    const toggleBtn = document.querySelector('.toggle-password');

    passInput.type = passInput.type === 'password' ? 'text' : 'password';
    toggleBtn.innerText = passInput.type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
}

/**
 * Apenas Login
 */
async function handleAuth() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    const { error } = await _supabase.auth.signInWithPassword({ email, password });

    if (error) alert("Erro: " + error.message);
    else window.location.href = 'index.html';
}

/**
 * Envio de e-mail para recuperaÃ§Ã£o de senha
 */
async function forgotPassword() {
    const email = document.getElementById('email').value;
    if (!email) return alert("Digite seu e-mail.");

    const { error } = await _supabase.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.href
    });

    if (error) alert(error.message);
    else alert("Link de recuperaÃ§Ã£o enviado!");
}

/**
 * Detecta se o usuÃ¡rio chegou por link de recuperaÃ§Ã£o
 */
/**
 * Detecta se o usuÃ¡rio jÃ¡ estÃ¡ logado ou se veio por recuperaÃ§Ã£o
 */
async function checkStatus() {
    const { data } = await _supabase.auth.getSession();
    
    // Se jÃ¡ estiver logado, pula o login e vai para o ERP
    if (data.session && !window.location.hash.includes("type=recovery")) {
        window.location.href = 'index.html';
        return;
    }

    const hash = window.location.hash;
    if (hash && (hash.includes("type=recovery") || hash.includes("access_token="))) {
        document.getElementById('form-subtitle').innerText = "ğŸ”‘ Defina sua nova senha";
        document.getElementById('email-group').style.display = 'none';
        document.getElementById('btn-auth').innerText = "Salvar Nova Senha";
        document.getElementById('btn-auth').onclick = updatePassword;
        document.getElementById('link-forgot').style.display = 'none';
        document.getElementById('btn-back').style.display = 'block'; // Mostra botÃ£o voltar
    }
}

/**
 * FunÃ§Ã£o para resetar o formulÃ¡rio se o usuÃ¡rio quiser desistir da recuperaÃ§Ã£o
 */
function toggleMode() {
    window.location.hash = "";
    window.location.reload();
}

// InicializaÃ§Ã£o
window.onload = checkStatus;
    </script>

</body>
</html>

```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
# produtos.html
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
```

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos - ERP ABP</title>
    <script src="conexao.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    :root { --primary: #3ecf8e; --dark: #0f172a; --bg: #f1f5f9; --danger: #ef4444; }
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 85px 15px 20px; color: #1e293b; }
.container { max-width: 1250px; margin: auto; }
.card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
.section-title { color: var(--primary); font-size: 13px; text-transform: uppercase; margin: 25px 0 12px; border-bottom: 2px solid #f1f5f9; padding-bottom: 6px; font-weight: 800; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
label { display: block; margin-bottom: 5px; font-size: 13px; color: #64748b; font-weight: 600; }
input, select { width: 100%; padding: 11px; border: 1px solid #e2e8f0; border-radius: 8px; }
.btn-add { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 20px; font-weight: bold; }
.btn-cancel { background: #94a3b8; color: white; padding: 12px; border: none; border-radius: 8px; width: 100%; margin-top: 10px; cursor: pointer; font-weight: bold; }
.btn-scan { background: var(--dark); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
.table-container { background: white; border-radius: 12px; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; min-width: 900px; }
th { background: #f8fafc; padding: 15px; font-size: 12px; text-align: left; color: #475569; }
td { padding: 12px 15px; border-top: 1px solid #f1f5f9; font-size: 14px; }
.img-prod { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; background: #eee; }
#reader { width: 100%; border-radius: 12px; margin-bottom: 10px; }


    .actions-flex {
    display: flex;
    gap: 8px;
    justify-content: flex-start;
}

.btn-action {
    border: none;
    border-radius: 6px;
    padding: 10px 12px;
    cursor: pointer;
    color: white;
    font-size: 14px;
    transition: 0.2s;
}

.btn-edit {
    background-color: var(--dark); /* Cor escura que vocÃª jÃ¡ usa */
}

.btn-delete {
    background-color: var(--danger); /* Vermelho para exclusÃ£o */
}

.btn-action:hover {
    filter: brightness(1.2);
}
    
    </style>

</head>
<body>

<div class="container">
    <div class="card">
        <h3 id="form-title">Novo Produto</h3>
        <input type="hidden" id="edit-id">
        
        <div class="section-title">IdentificaÃ§Ã£o e Foto</div>
        <div class="form-grid">
            <div style="grid-column: span 2;">
                <label>Foto do Produto</label>
                <input type="file" id="foto_produto" accept="image/*" onchange="previewImage(this)">
                <div id="preview-container" style="margin-top:10px; display:none;">
                    <img id="img-preview" src="" style="max-height: 120px; border: 2px solid #3ecf8e; border-radius: 8px;">
                </div>
            </div>
            <div style="grid-column: span 2;">
                <label>Nome do Produto *</label>
                <input type="text" id="nome" placeholder="Ex: Porcelanato 60x60">
            </div>
            <div>
                <label>CÃ³digo de Barras (EAN)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="codigo_de_barras" placeholder="0000000000000">
                    <button type="button" class="btn-scan" onclick="abrirScanner()">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="reader-container" style="display:none;">
            <div id="reader"></div>
            <button class="btn-cancel" onclick="fecharScanner()" style="margin-bottom: 20px;">Fechar CÃ¢mera</button>
        </div>

        <div class="section-title">Dados da Compra e Fornecedor</div>
        <div class="form-grid">
            <div><label>Data da Compra</label><input type="date" id="data_compra"></div>
            <div><label>NÂº Nota Fiscal</label><input type="text" id="numero_nota"></div>
            <div>
                <label>Fornecedor</label>
                <select id="entidade_id"><option value="">Carregando...</option></select>
            </div>
            <div><label>Categoria</label><input type="text" id="categoria_prod" list="lista-categorias"></div>
            <datalist id="lista-categorias"></datalist>
        </div>

        <div class="section-title">PreÃ§os e Estoque</div>
        <div class="form-grid">
            <div><label>Custo (R$)</label><input type="number" id="preco_custo" step="0.01"></div>
            <div><label>Venda (R$) *</label><input type="number" id="preco_venda" step="0.01"></div>
            <div><label>Estoque Atual</label><input type="number" id="estoque_atual"></div>
            <div><label>MÃ­nimo</label><input type="number" id="estoque_minimo"></div>
        </div>

        <button class="btn-add" id="btn-save" onclick="handleSaveProduto()">Salvar Produto</button>
        <button id="btn-cancel" class="btn-cancel" onclick="resetForm()" style="display:none;">Cancelar EdiÃ§Ã£o</button>
    </div>

    <div class="card">
        <div class="form-grid">
            <div style="grid-column: span 2;">
                <label>Busca Inteligente</label>
                <input type="text" id="inputBusca" onkeyup="filtrarProdutos()" placeholder="Nome, SKU ou EAN...">
            </div>
            <div>
                <label>Filtrar Categoria</label>
                <select id="filtro_categoria" onchange="filtrarProdutos()">
                    <option value="">Todas</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Foto</th>
                    <th>Produto / Marca</th>
                    <th>Categoria</th>
                    <th>Estoque</th>
                    <th>Venda</th>
                    <th>Compra / NF</th>
                    <th>AÃ§Ãµes</th>
                </tr>
            </thead>
            <tbody id="produtos-list"></tbody>
        </table>
    </div>
</div>
    <script>

(function() {
    "use strict";

    let listaProdutos = [];
    let html5QrCode;

    async function inicializar() {
        if (!window._supabase) {
            setTimeout(inicializar, 500);
            return;
        }
        await loadEntidadesFornecedores();
        await loadProdutos();
    }

    // Carrega apenas entidades marcadas como 'fornecedor'
    async function loadEntidadesFornecedores() {
        try {
            const { data, error } = await _supabase
                .from('entidades')
                .select('id, nome_completo')
                .eq('relacionamento', 'fornecedor')
                .order('nome_completo');

            if (error) throw error;

            const select = document.getElementById('entidade_id');
            select.innerHTML = '<option value="">Selecione o Fornecedor...</option>' + 
                data.map(e => `<option value="${e.id}">${e.nome_completo}</option>`).join('');
        } catch (err) {
            console.error("Erro ao carregar fornecedores:", err.message);
        }
    }

    async function loadProdutos() {
        try {
            const { data, error } = await _supabase
                .from('produtos')
                .select('*, entidades(nome_completo)')
                .order('nome');

            if (error) throw error;
            
            listaProdutos = data || [];
            renderProdutos(listaProdutos);
            atualizarFiltrosCategorias(listaProdutos);
        } catch (err) {
            console.error("Erro ao carregar produtos:", err.message);
        }
    }

    /**
     * LÃ“GICA DE IMAGEM: COMPRESSÃƒO E STORAGE
     */

    // FunÃ§Ã£o para comprimir a imagem antes do upload
    async function comprimirImagem(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX_SIZE = 800; // MÃ¡ximo 800px

                    if (width > height) {
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                    } else {
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.7); // 70% de qualidade
                };
            };
        });
    }

    window.previewImage = function(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('img-preview').src = e.target.result;
                document.getElementById('preview-container').style.display = 'block';
            }
            reader.readAsDataURL(input.files[0]);
        }
    };

    /**
     * CRUD - SALVAR, EDITAR, EXCLUIR
     */

    window.handleSaveProduto = async function() {
        try {
            const { data: { user } } = await _supabase.auth.getUser();
            const id = document.getElementById('edit-id').value;
            const fotoInput = document.getElementById('foto_produto');
            let publicUrl = document.getElementById('img-preview').src;

            // Se houver um novo arquivo selecionado, faz upload para o Storage
            if (fotoInput.files && fotoInput.files[0]) {
                const file = fotoInput.files[0];
                
                // Limite de 5MB para o arquivo original
                if (file.size > 5 * 1024 * 1024) return alert("Arquivo muito grande! MÃ¡ximo 5MB.");

                const imagemBlob = await comprimirImagem(file);
                const fileName = `prod_${Date.now()}.jpg`;
                // Altere esta linha no seu handleSaveProduto:
const filePath = `fotos/${Date.now()}_${Math.random().toString(36).substring(7)}.jpg`;

                const { error: uploadError } = await _supabase.storage
                    .from('produtos')
                    .upload(filePath, imagemBlob);

                if (uploadError) throw uploadError;

                const { data: urlData } = _supabase.storage
                    .from('produtos')
                    .getPublicUrl(filePath);
                
                publicUrl = urlData.publicUrl;
            }

            const dados = {
                usuario_id: user.id,
                nome: document.getElementById('nome').value,
                codigo_de_barras: document.getElementById('codigo_de_barras').value,
                data_compra: document.getElementById('data_compra').value || null,
                numero_nota: document.getElementById('numero_nota').value,
                categoria_prod: document.getElementById('categoria_prod').value,
                entidade_id: document.getElementById('entidade_id').value || null,
                preco_custo: parseFloat(document.getElementById('preco_custo').value) || 0,
                preco_venda: parseFloat(document.getElementById('preco_venda').value) || 0,
                estoque_atual: parseInt(document.getElementById('estoque_atual').value) || 0,
                estoque_minimo: parseInt(document.getElementById('estoque_minimo').value) || 0,
                imagem_url: publicUrl.startsWith('data:') ? null : publicUrl
            };

            if (!dados.nome || !dados.preco_venda) return alert("Nome e PreÃ§o de Venda sÃ£o obrigatÃ³rios!");

            const { error } = id ? 
                await _supabase.from('produtos').update(dados).eq('id', id) : 
                await _supabase.from('produtos').insert([dados]);

            if (error) throw error;

            resetForm();
            loadProdutos();
            alert("Produto salvo com sucesso!");

        } catch (err) {
            alert("Erro ao salvar produto: " + err.message);
        }
    };

    window.deleteProduto = async function(id) {
        if (!confirm("Deseja realmente excluir este produto?")) return;

        try {
            const produto = listaProdutos.find(p => p.id === id);
            
            // Se o produto tinha imagem no Storage, tenta deletar o arquivo fÃ­sico
            if (produto && produto.imagem_url && produto.imagem_url.includes('storage')) {
                const urlParts = produto.imagem_url.split('/produtos/');
                if (urlParts.length > 1) {
                    const filePath = urlParts[1].split('?')[0]; 
                    await _supabase.storage.from('produtos').remove([filePath]);
                }
            }

            const { error } = await _supabase.from('produtos').delete().eq('id', id);
            if (error) throw error;
            
            loadProdutos();
        } catch (err) {
            alert("Erro ao excluir: " + err.message);
        }
    };

    // --- FUNÃ‡Ã•ES DE INTERFACE MANTIDAS ---

    window.editProduto = function(id) {
        const p = listaProdutos.find(i => i.id === id);
        if (!p) return;

        document.getElementById('edit-id').value = p.id;
        document.getElementById('nome').value = p.nome;
        document.getElementById('codigo_de_barras').value = p.codigo_de_barras || '';
        document.getElementById('data_compra').value = p.data_compra || '';
        document.getElementById('numero_nota').value = p.numero_nota || '';
        document.getElementById('categoria_prod').value = p.categoria_prod || '';
        document.getElementById('entidade_id').value = p.entidade_id || '';
        document.getElementById('preco_custo').value = p.preco_custo;
        document.getElementById('preco_venda').value = p.preco_venda;
        document.getElementById('estoque_atual').value = p.estoque_atual;
        document.getElementById('estoque_minimo').value = p.estoque_minimo;

        if (p.imagem_url) {
            document.getElementById('img-preview').src = p.imagem_url;
            document.getElementById('preview-container').style.display = 'block';
        }

        document.getElementById('form-title').innerText = "Editando Produto";
        document.getElementById('btn-save').innerText = "Atualizar Produto";
        document.getElementById('btn-cancel').style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.resetForm = function() {
        document.getElementById('edit-id').value = '';
        document.querySelectorAll('input, select').forEach(i => i.value = '');
        document.getElementById('img-preview').src = '';
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('form-title').innerText = "Novo Produto";
        document.getElementById('btn-save').innerText = "Salvar Produto";
        document.getElementById('btn-cancel').style.display = 'none';
    };

    window.renderProdutos = function(dados) {
        const list = document.getElementById('produtos-list');
        list.innerHTML = dados.map(p => {
            const estoqueBaixo = p.estoque_atual <= (p.estoque_minimo || 0);
            return `
            <tr>
                <td><img src="${p.imagem_url || ''}" class="img-prod" style="width:50px; height:50px; object-fit:cover; border-radius:4px;" onerror="this.src='https://via.placeholder.com/50'"></td>
                <td><b>${p.nome}</b><br><small style="color:gray">${p.marca || ''}</small></td>
                <td><span style="background:#e2e8f0; padding:2px 8px; border-radius:4px; font-size:12px;">${p.categoria_prod || '-'}</span></td>
                <td style="${estoqueBaixo ? 'color:red; font-weight:bold' : ''}">${p.estoque_atual} un</td>
                <td>R$ ${parseFloat(p.preco_venda).toLocaleString('pt-BR', {minFractionDigits:2})}</td>
                <td><small>NF: ${p.numero_nota || '-'}<br>${p.data_compra ? new Date(p.data_compra).toLocaleDateString('pt-BR') : ''}</small></td>
                <td>
                    <div class="actions-flex" style="display:flex; gap:8px;">
                        <button class="btn-action btn-edit" style="background:#0f172a; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;" onclick="window.editProduto('${p.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-action btn-delete" style="background:#ef4444; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer;" onclick="window.deleteProduto('${p.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>`;
        }).join('') || '<tr><td colspan="7" style="text-align:center">Nenhum produto encontrado.</td></tr>';
    };

    window.abrirScanner = function() {
        document.getElementById('reader-container').style.display = 'block';
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 150 } },
            (decodedText) => {
                document.getElementById('codigo_de_barras').value = decodedText;
                window.fecharScanner();
            }
        ).catch(err => console.error(err));
    };

    window.fecharScanner = function() {
        if (html5QrCode) html5QrCode.stop().then(() => {
            document.getElementById('reader-container').style.display = 'none';
        });
    };

    window.filtrarProdutos = function() {
        const busca = document.getElementById('inputBusca').value.toLowerCase();
        const categoria = document.getElementById('filtro_categoria').value;
        const filtrados = listaProdutos.filter(p => {
            const matchTexto = p.nome.toLowerCase().includes(busca) || (p.codigo_de_barras && p.codigo_de_barras.includes(busca));
            const matchCategoria = categoria === "" || p.categoria_prod === categoria;
            return matchTexto && matchCategoria;
        });
        renderProdutos(filtrados);
    };

    function atualizarFiltrosCategorias(produtos) {
        const categorias = [...new Set(produtos.map(p => p.categoria_prod).filter(Boolean))];
        const dataList = document.getElementById('lista-categorias');
        if(dataList) dataList.innerHTML = categorias.map(c => `<option value="${c}">`).join('');
        const selectFiltro = document.getElementById('filtro_categoria');
        if(selectFiltro) selectFiltro.innerHTML = '<option value="">Todas as Categorias</option>' + 
            categorias.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    document.addEventListener('DOMContentLoaded', inicializar);
})();
        
    </script>
</body>
</html>

```
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥  
 # seguranÃ§a reforÃ§ada 
ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ğŸŸ¥ 
 ```
/**
 * =======================================================
 *  ERP ABP - GUARD GLOBAL
 *  SeguranÃ§a + Navbar + Controle de SessÃ£o
 *  Arquivo ÃšNICO | ReutilizÃ¡vel | Defensivo
 * =======================================================
 */

(() => {
    "use strict";

    // Evita execuÃ§Ã£o duplicada
    if (window.__ERP_GUARD_LOADED__) return;
    window.__ERP_GUARD_LOADED__ = true;

    // ---------------------------------------------------
    // VERIFICA SUPABASE
    // ---------------------------------------------------
    if (typeof window._supabase === "undefined") {
        console.error("Supabase nÃ£o encontrado.");
        window.location.replace("login.html");
        return;
    }

    // ---------------------------------------------------
    // CONFIGURAÃ‡ÃƒO CENTRAL
    // ---------------------------------------------------
    const CONFIG = Object.freeze({
        LOGIN_PAGE: "login.html",
        HOME_PAGE: "adm.html",
        APP_NAME: "ERP ABP"
    });

    // ---------------------------------------------------
    // VALIDA SESSÃƒO
    // ---------------------------------------------------
    async function validarSessao() {
        try {
            const { data, error } = await _supabase.auth.getSession();
            if (error || !data || !data.session) {
                throw new Error("SessÃ£o invÃ¡lida");
            }
            return data.session;
        } catch (e) {
            window.location.replace(CONFIG.LOGIN_PAGE);
            return null;
        }
    }

    // ---------------------------------------------------
    // LOGOUT
    // ---------------------------------------------------
    async function logout() {
        if (!confirm("Deseja sair do sistema?")) return;

        try {
            await _supabase.auth.signOut();
        } catch (_) {
            // Falha silenciosa proposital
        } finally {
            window.location.replace(CONFIG.LOGIN_PAGE);
        }
    }

    // ---------------------------------------------------
    // NAVBAR
    // ---------------------------------------------------
    function renderNavbar() {
        if (document.querySelector(".erp-navbar")) return;

        const style = `
            <style>
                .erp-navbar {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    background: #fff;
                    padding: 15px 25px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    box-shadow: 0 2px 10px rgba(0,0,0,.1);
                    z-index: 9999;
                }
                .erp-navbar .btn {
                    background: #ef4444;
                    color: #fff;
                    border: none;
                    padding: 8px 14px;
                    border-radius: 6px;
                    font-weight: bold;
                    cursor: pointer;
                }
                .erp-navbar .home {
                    background: #3ecf8e;
                }
                body.erp-guard {
                    padding-top: 80px;
                }
            </style>
        `;

        const html = `
            <div class="erp-navbar">
                <strong>${CONFIG.APP_NAME}</strong>
                <div>
                    <a href="${CONFIG.HOME_PAGE}" class="btn home">InÃ­cio</a>
                    <button class="btn" id="erpLogout">Sair</button>
                </div>
            </div>
        `;

        document.head.insertAdjacentHTML("beforeend", style);
        document.body.insertAdjacentHTML("afterbegin", html);
        document.body.classList.add("erp-guard");

        document
            .getElementById("erpLogout")
            ?.addEventListener("click", logout);
    }

    // ---------------------------------------------------
    // INICIALIZAÃ‡ÃƒO
    // ---------------------------------------------------
    document.addEventListener("DOMContentLoaded", async () => {
        const session = await validarSessao();
        if (!session) return;
        renderNavbar();
    });

})();

```













