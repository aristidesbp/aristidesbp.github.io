
# üîπ PARTE 2 ‚Äî üß± BANCO DE DADOS NO SUPABASE (USUARIOS)
* üëâ Compat√≠vel com PostgreSQL / Supabase
  
# usuarios.sql
```
create table public.usuarios (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  user_auth_users_id uuid null,
  nome text null,
  cpf text null,
  data_nascimento text null,
  email text null,
  senha_hash text null,
  contato text null,
  endereco text null,
  avata_url text null,
  constraint usuarios_pkey primary key (id),
  constraint usuarios_user_auth_users_id_fkey foreign KEY (user_auth_users_id) references auth.users (id)
) TABLESPACE pg_default;
```


# FUNCTION TRIGGER (prompt)
```
crie uma fun√ß√£o trigger para ser implementada no Supabase com o seguinte objetivo:
A cada novo usuario que for criado no schema auth, deve ser criado o mesmo usuario no schema public na tabela abaixo.

create table public.usuarios (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  user_auth_users_id uuid null,
  nome text null,
  cpf text null,
  data_nascimento text null,
  email text null,
  senha_hash text null,
  contato text null,
  endereco text null,
  avata_url text null,
  constraint usuarios_pkey primary key (id),
  constraint usuarios_user_auth_users_id_fkey foreign KEY (user_auth_users_id) references auth.users (id)
) TABLESPACE pg_default;
```



# FUNCTION TRIGGER (codigo)
```
-- 1. Cria√ß√£o da fun√ß√£o que ser√° disparada
create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer set search_path = public
as $$
begin
  insert into public.usuarios (user_auth_users_id, email, nome)
  values (
    new.id, 
    new.email, 
    new.raw_user_meta_data->>'full_name' -- Captura o nome se enviado via metadata
  );
  return new;
end;
$$;

-- 2. Cria√ß√£o do Trigger propriamente dito
create trigger on_auth_user_created
  after insert on auth.users
  for each row execute procedure public.handle_new_user();
```



# VIEWS (prompt)
```
Crie uma view chamada listar_usuarios que liste os usuarios cadastrados, com todos os campos da tabela usuarios. 
conforme o esquema abaixo:

create table public.usuarios (
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  user_auth_users_id uuid null,
  nome text null,
  cpf text null,
  data_nascimento text null,
  email text null,
  senha_hash text null,
  contato text null,
  endereco text null,
  avata_url text null,
  constraint usuarios_pkey primary key (id),
  constraint usuarios_user_auth_users_id_fkey foreign KEY (user_auth_users_id) references auth.users (id)
) TABLESPACE pg_default;
```

# VIEWS (codigo)
```
-- Cria√ß√£o da View listar_usuarios
CREATE OR REPLACE VIEW public.listar_usuarios AS
SELECT 
    id,
    created_at,
    user_auth_users_id,
    nome,
    cpf,
    data_nascimento,
    email,
    senha_hash,
    contato,
    endereco,
    avata_url
FROM 
    public.usuarios;

-- Garantir que a View seja acess√≠vel via API (opcional, dependendo das suas RLS)
ALTER VIEW public.listar_usuarios OWNER TO postgres;

```

# conexao_navbar.js
```
/** ############################################################################## */
/** ERP ABP - GUARD GLOBAL (Vers√£o Final Corrigida - Responsiva)
 * Seguran√ßa + SDK Auto-load + Navbar + Controle de Sess√£o */

(async () => {
    "use strict";

    if (window.__ERP_GUARD_LOADED__) return;
    window.__ERP_GUARD_LOADED__ = true;

    const CONFIG = Object.freeze({
        SUPABASE_URL: 'https://kjhjeaiwjilkgocwvbwi.supabase.co',
        SUPABASE_KEY: 'sb_publishable_WP3TF2GTMMWCS1tCYzQSjA_syIKLyIX',
        LOGIN_PAGE: "login.html",
        HOME_PAGE: "index.html",
        HUB_PAGE: "https://aristidesbp.github.io/",
        APP_NAME: "ERP ABP",
        SDK_URL: "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"
    });

    async function carregarSDK() {
        if (window.supabase) return true;
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = CONFIG.SDK_URL;
            script.onload = () => resolve(true);
            script.onerror = () => reject(new Error("Falha ao carregar SDK do Supabase"));
            document.head.appendChild(script);
        });
    }

    try {
        await carregarSDK();
        if (!window._supabase) {
            window._supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        }

        async function validarSessao() {
            try {
                const { data, error } = await _supabase.auth.getSession();
                if (error || !data || !data.session) throw new Error();
                return data.session;
            } catch (e) {
                window.location.replace(CONFIG.LOGIN_PAGE);
                return null;
            }
        }

        async function logout() {
            if (!confirm("Deseja realmente sair do sistema?")) return;
            try { await _supabase.auth.signOut(); } finally { window.location.replace(CONFIG.LOGIN_PAGE); }
        }

        function renderNavbar() {
            if (document.querySelector(".erp-navbar")) return;
            const style = `
                <style>
                    /* Reset b√°sico para a Navbar */
                    .erp-navbar, .erp-navbar * { box-sizing: border-box; }

                    .erp-navbar { 
                        position: fixed; top: 0; left: 0; width: 100%; 
                        background: #fff; padding: 10px 15px; 
                        display: flex; justify-content: space-between; align-items: center; 
                        box-shadow: 0 2px 10px rgba(0,0,0,.1); z-index: 9999; 
                        font-family: sans-serif; 
                    }
                    .erp-navbar .brand { 
                        font-weight: bold; color: #0f172a; font-size: 1.1rem; 
                        display: flex; align-items: center; gap: 5px; 
                        white-space: nowrap;
                    }
                    .erp-navbar .nav-right { display: flex; gap: 8px; flex-wrap: nowrap; }
                    
                    .erp-navbar .btn { 
                        padding: 6px 10px; border-radius: 6px; font-weight: bold; font-size: 12px; border: none; 
                        cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; 
                        gap: 5px; transition: 0.3s; white-space: nowrap; color: white;
                    }
                    .erp-navbar .btn-logout { background: #ef4444; }
                    .erp-navbar .btn-home { background: #3ecf8e; }
                    
                    /* Ajustes para Celular */
                    @media (max-width: 600px) {
                        .erp-navbar { padding: 8px 10px; }
                        .erp-navbar .brand { font-size: 0.9rem; }
                        .erp-navbar .btn span { display: none; } /* Esconde o texto, deixa s√≥ o √≠cone no celular se ficar apertado */
                        .erp-navbar .btn { padding: 8px 12px; font-size: 14px; }
                    }

                    body.erp-guard-active { padding-top: 70px !important; }
                </style>`;

            const html = `
                <div class="erp-navbar">
                    <div class="brand"><span style="color: #3ecf8e;">‚óè</span> ${CONFIG.APP_NAME}</div>
                    <div class="nav-right">
                        <a href="${CONFIG.HUB_PAGE}" class="btn btn-home"><i class="fas fa-external-link-alt"></i> <span>Projetos</span></a>
                        <a href="${CONFIG.HOME_PAGE}" class="btn btn-home"><i class="fas fa-home"></i> <span>In√≠cio</span></a>
                        <button class="btn btn-logout" id="btnSair"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></button>
                    </div>
                </div>`;

            document.head.insertAdjacentHTML("beforeend", style);
            document.body.insertAdjacentHTML("afterbegin", html);
            document.body.classList.add("erp-guard-active");
            document.getElementById("btnSair")?.addEventListener("click", logout);
        }

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", async () => {
                const session = await validarSessao();
                if (session) renderNavbar();
            });
        } else {
            const session = await validarSessao();
            if (session) renderNavbar();
        }

    } catch (err) {
        console.error("Erro cr√≠tico no Guard:", err);
    }
})();
```









