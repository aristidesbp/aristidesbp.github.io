<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP ABP Profissional - Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="app">
        <div class="container">
            <header>
                <h1>ERP ABP <span class="badge">v1.0</span></h1>
                <div id="status-conexao" class="status-box">Verificando conex√£o com Supabase...</div>
            </header>

            <main id="main-content">
                <div id="setup-section">
                    <h2>üöÄ Primeiro Acesso</h2>
                    <p>Crie sua conta administrativa para configurar o banco de dados.</p>
                    
                    <form id="form-setup">
                        <input type="text" id="nome" placeholder="Seu Nome Completo" required>
                        <input type="text" id="empresa" placeholder="Nome da sua Empresa" required>
                        <input type="email" id="email" placeholder="E-mail de Login" required>
                        <input type="password" id="senha" placeholder="Senha (m√≠n. 6 caracteres)" required>
                        <button type="submit" id="btn-submit">Finalizar Instala√ß√£o</button>
                    </form>
                </div>

                <div id="debug-console">
                    <h3>üîç Console de Diagn√≥stico:</h3>
                    <div id="log-output">Iniciando sistema...</div>
                </div>
            </main>
        </div>
    </div>

<script>
/**
 * ERP ABP PROFISSIONAL
 * Arquivo: index.html (Setup & Diagn√≥stico)
 */
(function() {
    // Configura√ß√µes fornecidas por Aristides
    const CONFIG = {
        URL: "https://ueaprmzmlkfrbmibdnro.supabase.co",
        ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlYXBybXptbGtmcmJtaWJkbnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTg3OTQsImV4cCI6MjA4NDkzNDc5NH0.Nl_W2v3JN_uQLfz4eAqV3goDVFernnGi2A7L9kszX3w"
    };

    // Inje√ß√£o de CSS Direta (Conforme padr√£o do projeto)
    const style = document.createElement('style');
    style.innerHTML = `
        body { font-family: sans-serif; background: #0f172a; color: #f8fafc; margin: 0; padding: 20px; }
        .container { max-width: 500px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        .badge { font-size: 0.5em; background: #3b82f6; padding: 4px 8px; border-radius: 4px; vertical-align: middle; }
        .status-box { padding: 10px; border-radius: 8px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .online { background: #065f46; color: #34d399; border: 1px solid #059669; }
        .offline { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
        
        #setup-section { background: #1e293b; padding: 25px; border-radius: 12px; border: 1px solid #334155; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 6px; border: 1px solid #475569; background: #0f172a; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background: #2563eb; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:disabled { background: #475569; cursor: not-allowed; }

        #debug-console { margin-top: 30px; background: #000; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; border: 1px solid #334155; }
        #log-output { color: #10b981; white-space: pre-wrap; word-break: break-all; }
        .log-error { color: #ef4444 !important; }
    `;
    document.head.appendChild(style);

    // Inicializa√ß√£o do Supabase
    const supabaseClient = supabase.createClient(CONFIG.URL, CONFIG.ANON_KEY);

    // Helper para Log no Celular
    function logger(msg, isError = false) {
        const out = document.getElementById('log-output');
        const span = document.createElement('div');
        if(isError) span.className = 'log-error';
        span.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
        out.prepend(span);
        console.log(msg);
    }

    async function testarConexao() {
        const statusDiv = document.getElementById('status-conexao');
        try {
            logger("Testando comunica√ß√£o com Supabase...");
            // Tenta ler uma tabela p√∫blica simples (ex: empresas) apenas para ver se responde
            const { data, error } = await supabaseClient.from('empresas').select('id').limit(1);
            
            if (error && error.code !== 'PGRST116') { // Ignora erro de tabela vazia
                throw error;
            }

            statusDiv.innerText = "‚óè CONECTADO AO SUPABASE";
            statusDiv.className = "status-box online";
            logger("Conex√£o estabelecida com sucesso!");
        } catch (err) {
            statusDiv.innerText = "‚óè ERRO DE CONEX√ÉO";
            statusDiv.className = "status-box offline";
            logger(`FALHA: ${err.message || JSON.stringify(err)}`, true);
            logger("Dica: Verifique se a URL e a KEY est√£o corretas ou se o banco est√° ativo.", true);
        }
    }

    // L√≥gica de Cadastro
    document.getElementById('form-setup').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        btn.innerText = "Processando Registro...";

        const dados = {
            nome: document.getElementById('nome').value,
            empresa: document.getElementById('empresa').value,
            email: document.getElementById('email').value,
            senha: document.getElementById('senha').value
        };

        try {
            logger(`Iniciando SignUp para: ${dados.email}`);
            
            // 1. Criar usu√°rio no Auth
            const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                email: dados.email,
                password: dados.senha
            });

            if (authError) throw authError;
            logger("Usu√°rio criado no Auth! ID: " + authData.user.id);

            // 2. Chamar a RPC para inicializar tabelas (Passo 4)
            logger("Chamando rpc.inicializar_novo_cliente...");
            const { error: rpcError } = await supabaseClient.rpc('inicializar_novo_cliente', {
                p_user_id: authData.user.id,
                p_user_nome: dados.nome,
                p_empresa_nome: dados.empresa,
                p_plano: 'Master'
            });

            if (rpcError) throw rpcError;

            logger("INSTALA√á√ÉO CONCLU√çDA COM SUCESSO!", false);
            alert("Sucesso! Verifique seu e-mail e confirme a conta para logar.");
            
        } catch (err) {
            logger(`ERRO NO PROCESSO: ${err.message}`, true);
        } finally {
            btn.disabled = false;
            btn.innerText = "Finalizar Instala√ß√£o";
        }
    });

    // Iniciar teste ao carregar
    testarConexao();

})();
</script>
</body>
</html>
