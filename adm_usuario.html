<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - ERP ABP</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div id="app" style="display: none;">
        <nav class="navbar">
            <a href="index.html" class="btn-back"><i class="fas fa-arrow-left"></i></a>
            <div class="brand">Gerenciar Minha Conta</div>
        </nav>

        <main class="content">
            <section class="card">
                <h3><i class="fas fa-user-edit"></i> Dados do Perfil</h3>
                <p style="font-size: 0.8rem; color: #94a3b8; margin-bottom: 15px;">
                    Estes dados identificam você dentro do sistema.
                </p>
                <form id="form-perfil">
                    <div class="input-group">
                        <label>Nome Completo</label>
                        <input type="text" id="user-nome" required>
                    </div>
                    <div class="input-group">
                        <label>Telefone/WhatsApp</label>
                        <input type="tel" id="user-tel">
                    </div>
                    <button type="submit" class="btn-save">Atualizar Perfil</button>
                </form>
            </section>

            <section class="card" style="margin-top: 20px;">
                <h3><i class="fas fa-key"></i> Segurança e Login</h3>
                <form id="form-seguranca">
                    <div class="input-group">
                        <label>Novo E-mail de Login</label>
                        <input type="email" id="user-email">
                    </div>
                    <div class="input-group">
                        <label>Nova Senha (mín. 6 caracteres)</label>
                        <input type="password" id="user-senha" placeholder="Deixe em branco para não alterar">
                    </div>
                    <p class="aviso">* Ao alterar o e-mail, você precisará confirmar no novo endereço.</p>
                    <button type="submit" class="btn-save-alt">Salvar Novas Credenciais</button>
                </form>
            </section>
        </main>
    </div>

<script>
(function() {
    const CONFIG = {
        URL: "https://ueaprmzmlkfrbmibdnro.supabase.co",
        KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlYXBybXptbGtmcmJtaWJkbnJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkzNTg3OTQsImV4cCI6MjA4NDkzNDc5NH0.Nl_W2v3JN_uQLfz4eAqV3goDVFernnGi2A7L9kszX3w"
    };
    const supabaseClient = supabase.createClient(CONFIG.URL, CONFIG.KEY);
    let userId = null;

    const style = document.createElement('style');
    style.innerHTML = `
        :root { --primary: #3ecf8e; --dark: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { margin: 0; font-family: sans-serif; background: var(--dark); color: var(--text); }
        .navbar { display: flex; align-items: center; padding: 15px; background: var(--card); border-bottom: 1px solid #334155; }
        .btn-back { color: white; text-decoration: none; margin-right: 15px; }
        .brand { font-weight: bold; }
        .content { padding: 15px; max-width: 500px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #334155; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white; box-sizing: border-box; }
        .btn-save { width: 100%; padding: 12px; background: var(--primary); border: none; border-radius: 6px; font-weight: bold; color: #000; cursor: pointer; }
        .btn-save-alt { width: 100%; padding: 12px; background: #3b82f6; border: none; border-radius: 6px; font-weight: bold; color: white; cursor: pointer; }
        .aviso { font-size: 10px; color: #f59e0b; margin-bottom: 10px; }
    `;
    document.head.appendChild(style);

    async function init() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) { window.location.href = "login.html"; return; }
        
        userId = session.user.id;
        document.getElementById('app').style.display = 'block';
        document.getElementById('user-email').value = session.user.email;

        // Busca dados na tabela public.usuarios
        const { data: perfil } = await supabaseClient
            .from('usuarios')
            .select('*')
            .eq('id', userId)
            .single();

        if (perfil) {
            document.getElementById('user-nome').value = perfil.nome || '';
            document.getElementById('user-tel').value = perfil.telefone || '';
        }
    }

    // Ação 1: Atualizar Perfil (Tabela public.usuarios)
    document.getElementById('form-perfil').onsubmit = async (e) => {
        e.preventDefault();
        const { error } = await supabaseClient.from('usuarios').upsert({
            id: userId,
            nome: document.getElementById('user-nome').value,
            telefone: document.getElementById('user-tel').value,
            email: document.getElementById('user-email').value
        });

        if (error) alert("Erro ao salvar perfil: " + error.message);
        else alert("Perfil atualizado no banco de dados!");
    };

    // Ação 2: Atualizar Credenciais (E-mail e Senha)
    document.getElementById('form-seguranca').onsubmit = async (e) => {
        e.preventDefault();
        const novoEmail = document.getElementById('user-email').value;
        const novaSenha = document.getElementById('user-senha').value;
        
        let updates = {};
        if (novoEmail) updates.email = novoEmail;
        if (novaSenha) updates.password = novaSenha;

        const { error } = await supabaseClient.auth.updateUser(updates);
        
        if (error) alert("Erro na segurança: " + error.message);
        else alert("Credenciais atualizadas! Se mudou o e-mail, verifique sua caixa de entrada.");
    };

    init();
})();
</script>
</body>
</html>
